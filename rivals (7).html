<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>RIVALS</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Rajdhani:wght@600;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --y:#FFE600;--r:#FF3131;--b:#1E90FF;--c:#00F5FF;--g:#22C55E;--p:#A855F7;
  --bg:#04040a;--card:#0b0b16;--bdr:#1a1a2e;--txt:#e8e8f8;--mut:#484870;
  --coin:#F59E0B;
}
html,body{width:100%;height:100%;overflow:hidden;background:var(--bg);
  font-family:'Rajdhani',sans-serif;color:var(--txt);font-weight:600}
.screen{position:fixed;inset:0;display:none;overflow-y:auto}
.screen.active{display:block}

/* ‚ïê‚ïê‚ïê MENU ‚ïê‚ïê‚ïê */
#s-menu{
  background:var(--bg);min-height:100%;
  background-image:radial-gradient(ellipse 900px 500px at 20% 50%,rgba(255,0,80,.05),transparent),
    radial-gradient(ellipse 700px 400px at 80% 50%,rgba(0,245,255,.04),transparent),
    linear-gradient(rgba(255,230,0,.025) 1px,transparent 1px),
    linear-gradient(90deg,rgba(255,230,0,.025) 1px,transparent 1px);
  background-size:auto,auto,48px 48px,48px 48px;
}
.menu-wrap{max-width:900px;margin:0 auto;padding:1.5rem 1rem 3rem}
/* Header */
.logo-row{text-align:center;padding:1rem 0 1.2rem;position:relative}
.logo-eye{font-family:'Press Start 2P',monospace;font-size:.38rem;color:var(--mut);letter-spacing:.3em;display:block;margin-bottom:.5rem}
.logo{font-family:'Press Start 2P',monospace;font-size:clamp(2rem,7vw,4.2rem);
  color:var(--y);text-shadow:0 0 40px rgba(255,230,0,.8),0 0 80px rgba(255,230,0,.3);
  display:block;animation:glitch 6s infinite}
@keyframes glitch{0%,88%,100%{transform:none;filter:none}89%{transform:translate(-2px,0);filter:drop-shadow(3px 0 var(--r))}90%{transform:translate(2px,0);filter:drop-shadow(-3px 0 var(--c))}91%{transform:none;filter:none}}
.logo-sub{font-family:'Press Start 2P',monospace;font-size:.35rem;color:var(--mut);letter-spacing:.18em;display:block;margin-top:.3rem}
/* Coin display */
.coin-display{position:absolute;top:1rem;right:0;display:flex;align-items:center;gap:.4rem;
  background:rgba(11,11,22,.9);border:1px solid var(--coin);padding:.35rem .8rem}
.coin-icon{font-size:1.1rem}
.coin-val{font-family:'Press Start 2P',monospace;font-size:.45rem;color:var(--coin)}

/* Nav tabs */
.tabs{display:flex;border-bottom:2px solid var(--bdr);margin-bottom:1.2rem}
.tab{font-family:'Press Start 2P',monospace;font-size:.32rem;padding:.65rem 1.1rem;cursor:pointer;
  color:var(--mut);letter-spacing:.08em;border-bottom:2px solid transparent;margin-bottom:-2px;transition:all .18s}
.tab:hover{color:var(--txt)}
.tab.on{color:var(--y);border-bottom-color:var(--y)}
.tab-panel{display:none}.tab-panel.on{display:block}

/* Play tab */
.section-label{font-family:'Press Start 2P',monospace;font-size:.32rem;color:var(--mut);
  letter-spacing:.18em;display:block;margin-bottom:.55rem}
.two-col{display:grid;grid-template-columns:1fr 1fr;gap:.8rem;margin-bottom:.9rem}
@media(max-width:560px){.two-col{grid-template-columns:1fr}}
.card{background:var(--card);border:1px solid var(--bdr);padding:.8rem}
.name-in{width:100%;background:transparent;border:none;border-bottom:2px solid var(--bdr);
  color:var(--txt);font-family:'Rajdhani',sans-serif;font-weight:700;font-size:1.2rem;
  padding:.3rem 0;outline:none;transition:border-color .2s;letter-spacing:.04em}
.name-in:focus{border-color:var(--y)}.name-in::placeholder{color:var(--mut)}
/* Team */
.team-row{display:grid;grid-template-columns:1fr 1fr;gap:.45rem}
.tbt{font-family:'Press Start 2P',monospace;font-size:.38rem;padding:.65rem;
  border:2px solid;background:transparent;cursor:pointer;transition:all .18s;letter-spacing:.04em}
.tbt.r{border-color:var(--r);color:var(--r)}.tbt.r.on,.tbt.r:hover{background:var(--r);color:#fff;box-shadow:0 0 18px rgba(255,49,49,.4)}
.tbt.b{border-color:var(--b);color:var(--b)}.tbt.b.on,.tbt.b:hover{background:var(--b);color:#fff;box-shadow:0 0 18px rgba(30,144,255,.4)}
/* Modes */
.mode-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:.4rem;margin-bottom:.9rem}
@media(max-width:650px){.mode-grid{grid-template-columns:repeat(3,1fr)}}
.mbt{border:1px solid var(--bdr);padding:.5rem .2rem;cursor:pointer;transition:all .18s;text-align:center;background:var(--card)}
.mbt:hover{border-color:rgba(255,230,0,.4)}.mbt.on{border-color:var(--y);background:rgba(255,230,0,.06)}
.mbt i{font-size:1.3rem;display:block;margin-bottom:.25rem}
.mbt s{font-family:'Press Start 2P',monospace;font-size:.26rem;color:var(--y);display:block;margin-bottom:.18rem;line-height:1.5}
.mbt d{font-size:.8rem;color:var(--mut);display:block;line-height:1.3}
/* Play button */
.play-btn{display:block;width:100%;font-family:'Press Start 2P',monospace;font-size:.6rem;
  letter-spacing:.12em;background:var(--y);color:#000;border:none;cursor:pointer;
  padding:1rem;margin-bottom:.8rem;transition:transform .12s,filter .12s}
.play-btn:hover{transform:translateY(-3px);filter:brightness(1.12)}
.rpg-btn{display:none;width:100%;font-family:'Press Start 2P',monospace;font-size:.5rem;
  letter-spacing:.1em;background:linear-gradient(135deg,#6D28D9,#BE185D);
  color:#fff;border:none;cursor:pointer;padding:.9rem;margin-bottom:.8rem;transition:transform .12s}
.rpg-btn:hover{transform:translateY(-2px);filter:brightness(1.1)}
.secret-toast{display:none;text-align:center;font-family:'Press Start 2P',monospace;
  font-size:.35rem;color:var(--p);text-shadow:0 0 18px rgba(168,85,247,.8);
  letter-spacing:.1em;padding:.5rem;margin-bottom:.5rem}
.hints{display:flex;gap:1.2rem;flex-wrap:wrap;justify-content:center}
.hint{font-family:'Press Start 2P',monospace;font-size:.28rem;color:var(--mut);text-align:center;line-height:2.2}
kbd{background:var(--card);border:1px solid var(--bdr);padding:.1rem .3rem;border-radius:2px;color:#888;font-family:inherit}

/* ‚ïê‚ïê‚ïê INVENTORY TAB ‚ïê‚ïê‚ïê */
.inv-tabs{display:flex;gap:.4rem;margin-bottom:1rem}
.inv-tab{font-family:'Press Start 2P',monospace;font-size:.3rem;padding:.5rem .9rem;
  border:1px solid var(--bdr);cursor:pointer;color:var(--mut);transition:all .18s;background:var(--card)}
.inv-tab.on{border-color:var(--y);color:var(--y);background:rgba(255,230,0,.06)}
.inv-panel{display:none}.inv-panel.on{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:.6rem}
.inv-item{background:var(--card);border:1px solid var(--bdr);padding:.7rem;text-align:center;position:relative}
.inv-item.equipped{border-color:var(--y);background:rgba(255,230,0,.05)}
.inv-item.equipped::after{content:'EQUIPPED';font-family:'Press Start 2P',monospace;font-size:.22rem;
  color:#000;background:var(--y);padding:.1rem .3rem;position:absolute;top:.3rem;right:.3rem}
.inv-icon{font-size:1.8rem;display:block;margin-bottom:.4rem}
.inv-name{font-family:'Press Start 2P',monospace;font-size:.28rem;color:var(--y);display:block;margin-bottom:.3rem}
.inv-stat{font-size:.78rem;color:var(--mut);display:block;margin-bottom:.4rem;line-height:1.5}
.equip-btn{font-family:'Press Start 2P',monospace;font-size:.26rem;padding:.3rem .5rem;
  background:transparent;border:1px solid var(--y);color:var(--y);cursor:pointer;width:100%;transition:all .15s}
.equip-btn:hover{background:var(--y);color:#000}
.inv-empty{grid-column:1/-1;text-align:center;padding:2rem;font-family:'Press Start 2P',monospace;
  font-size:.35rem;color:var(--mut)}

/* ‚ïê‚ïê‚ïê SHOP TAB ‚ïê‚ïê‚ïê */
.shop-tabs{display:flex;gap:.4rem;margin-bottom:1rem}
.shop-tab{font-family:'Press Start 2P',monospace;font-size:.3rem;padding:.5rem .9rem;
  border:1px solid var(--bdr);cursor:pointer;color:var(--mut);transition:all .18s;background:var(--card)}
.shop-tab.on{border-color:var(--coin);color:var(--coin);background:rgba(245,158,11,.06)}
.shop-panel{display:none}.shop-panel.on{display:grid;grid-template-columns:repeat(auto-fill,minmax(155px,1fr));gap:.7rem}
.shop-item{background:var(--card);border:1px solid var(--bdr);padding:.8rem;text-align:center;position:relative;transition:border-color .18s}
.shop-item:hover{border-color:rgba(245,158,11,.5)}
.shop-item.owned{border-color:#2a2a3e;opacity:.6}
.shop-item.owned::after{content:'OWNED';font-family:'Press Start 2P',monospace;font-size:.22rem;
  color:var(--mut);padding:.1rem .3rem;position:absolute;top:.3rem;right:.3rem;border:1px solid var(--bdr)}
.shop-badge{position:absolute;top:.3rem;left:.3rem;font-family:'Press Start 2P',monospace;
  font-size:.2rem;padding:.15rem .3rem;letter-spacing:.05em}
.badge-hot{background:#DC2626;color:#fff}
.badge-new{background:#7C3AED;color:#fff}
.badge-bundle{background:#0891B2;color:#fff}
.shop-icon{font-size:2rem;display:block;margin:.3rem 0 .4rem}
.shop-name{font-family:'Press Start 2P',monospace;font-size:.28rem;color:var(--txt);display:block;margin-bottom:.25rem;line-height:1.5}
.shop-desc{font-size:.8rem;color:var(--mut);display:block;margin-bottom:.6rem;line-height:1.4}
.shop-price{display:flex;align-items:center;justify-content:center;gap:.3rem;margin-bottom:.5rem}
.shop-price-val{font-family:'Press Start 2P',monospace;font-size:.4rem;color:var(--coin)}
.buy-btn{font-family:'Press Start 2P',monospace;font-size:.26rem;padding:.35rem;
  background:var(--coin);color:#000;border:none;cursor:pointer;width:100%;transition:all .15s;letter-spacing:.06em}
.buy-btn:hover{filter:brightness(1.12)}
.buy-btn:disabled{background:var(--bdr);color:var(--mut);cursor:not-allowed}

/* ‚ïê‚ïê‚ïê GAME ‚ïê‚ïê‚ïê */
#s-game{overflow:hidden}
#gc{position:fixed;inset:0;width:100%;height:100%;display:block;cursor:crosshair}
#hud{position:fixed;inset:0;pointer-events:none;z-index:10}
/* Score */
#scorebar{position:absolute;top:.75rem;left:50%;transform:translateX(-50%);
  display:flex;align-items:center;gap:.8rem;white-space:nowrap;
  background:rgba(4,4,10,.93);border:1px solid rgba(255,255,255,.05);
  padding:.45rem 1.2rem;backdrop-filter:blur(10px)}
.sc{font-family:'Press Start 2P',monospace;font-size:1.4rem;line-height:1;transition:all .3s}
.sc.r{color:var(--r);text-shadow:0 0 14px rgba(255,49,49,.7)}
.sc.b{color:var(--b);text-shadow:0 0 14px rgba(30,144,255,.7)}
.sc.y{color:var(--y);text-shadow:0 0 14px rgba(255,230,0,.7)}
#mode-tag{font-family:'Press Start 2P',monospace;font-size:.27rem;color:rgba(255,255,255,.18);
  display:block;text-align:center;margin-bottom:.12rem}
.sep{font-family:'Press Start 2P',monospace;font-size:.32rem;color:var(--mut);text-align:center;line-height:1.9}
#koth-bar{margin-top:.3rem;display:none}.koth-bar.show{display:block}
.koth-track{width:180px;height:7px;background:rgba(255,255,255,.04);border:1px solid var(--bdr);position:relative;overflow:hidden}
.kfr{position:absolute;left:0;top:0;height:100%;background:var(--r);transition:width .3s}
.kfb{position:absolute;right:0;top:0;height:100%;background:var(--b);transition:width .3s}
/* Stats */
#stats{position:absolute;top:.75rem;left:.75rem;font-family:'Press Start 2P',monospace;
  font-size:.28rem;color:var(--mut);background:rgba(4,4,10,.9);
  border:1px solid rgba(255,255,255,.04);padding:.35rem .6rem;line-height:2.3;letter-spacing:.04em}
#stats span{color:var(--y)}
/* Coin HUD */
#coin-hud{position:absolute;top:.75rem;right:.75rem;font-family:'Press Start 2P',monospace;
  font-size:.38rem;background:rgba(4,4,10,.9);border:1px solid var(--coin);
  padding:.35rem .7rem;display:flex;align-items:center;gap:.4rem}
.coin-hud-ico{font-size:.9rem}
#coin-hud-val{color:var(--coin)}
/* Feed */
#feed{position:absolute;top:4rem;right:.75rem;display:flex;flex-direction:column;gap:.22rem;align-items:flex-end;max-width:200px}
.fi{font-family:'Press Start 2P',monospace;font-size:.26rem;padding:.18rem .4rem;
  background:rgba(4,4,10,.92);border-right:3px solid;white-space:nowrap;animation:fiin .2s ease}
.fi.r{border-color:var(--r)}.fi.b{border-color:var(--b)}.fi.y{border-color:var(--y)}
@keyframes fiin{from{opacity:0;transform:translateX(10px)}to{opacity:1;transform:none}}
/* Bottom */
#bot-hud{position:absolute;bottom:.9rem;left:50%;transform:translateX(-50%);
  display:flex;flex-direction:column;align-items:center;gap:.3rem}
#hp-row{display:flex;align-items:center;gap:.3rem;background:rgba(4,4,10,.9);
  border:1px solid rgba(255,255,255,.04);padding:.3rem .7rem}
.hl{font-family:'Press Start 2P',monospace;font-size:.28rem;color:var(--mut);margin-right:.15rem}
.hrt{font-size:.95rem;transition:all .18s}.hrt.gone{opacity:.12;transform:scale(.7)}
#shld-hud{font-size:.95rem}
#ammo-row{display:flex;align-items:center;gap:.5rem;background:rgba(4,4,10,.9);
  border:1px solid rgba(255,255,255,.04);padding:.28rem .7rem}
#g-lbl{font-family:'Press Start 2P',monospace;font-size:.28rem}
#bpips{display:flex;gap:2px;flex-wrap:wrap;max-width:130px}
.bpip{width:4px;height:8px;border-radius:1px;transition:background .08s}
#reload-lbl{font-family:'Press Start 2P',monospace;font-size:.28rem;color:var(--y);
  animation:rp .85s ease-in-out infinite;display:none}
@keyframes rp{0%,100%{opacity:1}50%{opacity:.25}}
#pow-row{min-height:26px;display:flex;align-items:center;gap:.3rem;
  background:rgba(4,4,10,.9);border:1px solid rgba(255,255,255,.04);
  padding:.22rem .6rem;font-size:.85rem}
/* Respawn */
#respawn{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
  text-align:center;display:none}
#respawn.show{display:block}
#rs-lbl{font-family:'Press Start 2P',monospace;font-size:.5rem;color:var(--r);letter-spacing:.15em;margin-bottom:.5rem}
#rs-n{font-family:'Press Start 2P',monospace;font-size:3rem;color:var(--y);
  text-shadow:0 0 30px rgba(255,230,0,.9);animation:pulse .85s ease-in-out infinite}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
/* Streak */
#streak{position:absolute;top:33%;left:50%;transform:translateX(-50%);pointer-events:none;display:none;text-align:center}
#streak.show{display:block}
#streak-txt{font-family:'Press Start 2P',monospace;font-size:clamp(.6rem,2vw,1rem);
  color:var(--y);text-shadow:0 0 30px rgba(255,230,0,.9);animation:pop .4s ease}
@keyframes pop{from{opacity:0;transform:scale(.3)}to{opacity:1;transform:scale(1)}}
/* Coin pop */
#coin-pop{position:absolute;pointer-events:none;display:none;font-family:'Press Start 2P',monospace;font-size:.38rem;color:var(--coin);text-shadow:0 0 12px rgba(245,158,11,.8);animation:coinpop .8s ease forwards}
@keyframes coinpop{0%{opacity:1;transform:translateY(0)}100%{opacity:0;transform:translateY(-40px)}}
/* Map label */
#map-lbl{position:absolute;bottom:.75rem;right:.75rem;font-family:'Press Start 2P',monospace;font-size:.26rem;color:rgba(255,255,255,.13)}
/* Flash */
#flash{position:fixed;inset:0;pointer-events:none;z-index:5;opacity:0;transition:opacity .1s}

/* ‚ïê‚ïê‚ïê PAUSE ‚ïê‚ïê‚ïê */
#s-pause{background:rgba(4,4,10,.93);backdrop-filter:blur(18px);z-index:100;
  display:flex;flex-direction:column;align-items:center;justify-content:center}
.pause-title{font-family:'Press Start 2P',monospace;font-size:1.8rem;color:var(--y);
  text-shadow:0 0 30px rgba(255,230,0,.8);margin-bottom:.4rem}
.pause-sub{font-family:'Press Start 2P',monospace;font-size:.32rem;color:var(--mut);
  letter-spacing:.14em;margin-bottom:2rem}
.pause-btn{font-family:'Press Start 2P',monospace;font-size:.42rem;
  background:transparent;border:2px solid;padding:.75rem 2rem;cursor:pointer;
  letter-spacing:.08em;width:240px;margin-bottom:.5rem;transition:all .15s}
.pause-btn.green{border-color:var(--g);color:var(--g)}.pause-btn.green:hover{background:var(--g);color:#000}
.pause-btn.red{border-color:var(--r);color:var(--r)}.pause-btn.red:hover{background:var(--r);color:#fff}

/* ‚ïê‚ïê‚ïê END ‚ïê‚ïê‚ïê */
#s-end{background:rgba(4,4,10,.97);backdrop-filter:blur(20px);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  min-height:100%;padding:2rem;overflow-y:auto}
#end-title{font-family:'Press Start 2P',monospace;font-size:clamp(.9rem,3vw,1.8rem);
  margin-bottom:.35rem;text-align:center}
#end-title.r{color:var(--r);text-shadow:0 0 35px rgba(255,49,49,.8)}
#end-title.b{color:var(--b);text-shadow:0 0 35px rgba(30,144,255,.8)}
#end-title.y{color:var(--y);text-shadow:0 0 35px rgba(255,230,0,.8)}
#end-sub{font-family:'Press Start 2P',monospace;font-size:.35rem;color:var(--mut);
  letter-spacing:.14em;margin-bottom:.6rem;text-align:center}
#end-coins{font-family:'Press Start 2P',monospace;font-size:.42rem;color:var(--coin);
  margin-bottom:1.4rem;text-align:center}
table{border-collapse:collapse;width:100%;max-width:620px;margin-bottom:1.4rem}
th{font-family:'Press Start 2P',monospace;font-size:.26rem;color:var(--mut);
  padding:.4rem .55rem;text-align:left;border-bottom:2px solid var(--y)}
td{padding:.5rem .55rem;font-size:.92rem;font-weight:700;border-bottom:1px solid var(--bdr)}
tr.me td{background:rgba(255,230,0,.05)}tr.me td:first-child{border-left:3px solid var(--y)}
.tk{color:#FF0080}.tkd{color:var(--c)}.ts{color:var(--y)}.tr2{color:var(--r)}.tb2{color:var(--b)}
#again-btn{font-family:'Press Start 2P',monospace;font-size:.45rem;letter-spacing:.08em;
  background:var(--y);color:#000;border:none;cursor:pointer;padding:.8rem 2.2rem;
  transition:transform .12s,filter .12s}
#again-btn:hover{transform:translateY(-3px);filter:brightness(1.1)}
</style>
</head>
<body>
<div id="flash"></div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MENU ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="s-menu" class="screen active">
<div class="menu-wrap">

  <div class="logo-row">
    <span class="logo-eye">‚Äî SEASON 1 ‚Äî</span>
    <span class="logo">RIVALS</span>
    <span class="logo-sub">PICK YOUR LOADOUT</span>
    <div class="coin-display"><span class="coin-icon">ü™ô</span><span class="coin-val" id="menu-coins">0</span></div>
  </div>

  <div id="secret-toast" class="secret-toast">üîÆ RPG REALM UNLOCKED! üîÆ</div>

  <!-- Tabs -->
  <div class="tabs">
    <div class="tab on" onclick="switchTab('play')">‚öîÔ∏è PLAY</div>
    <div class="tab" onclick="switchTab('inventory')">üéí INVENTORY</div>
    <div class="tab" onclick="switchTab('shop')">üõí SHOP</div>
  </div>

  <!-- PLAY TAB -->
  <div id="tab-play" class="tab-panel on">
    <div class="two-col">
      <div class="card">
        <span class="section-label">YOUR NAME</span>
        <input id="name-in" class="name-in" type="text" placeholder="ENTER NAME" maxlength="12" autocomplete="off" spellcheck="false"/>
      </div>
      <div class="card">
        <span class="section-label">TEAM</span>
        <div class="team-row">
          <button class="tbt r on" id="tbr" onclick="pickTeam('red')">üî¥ RED</button>
          <button class="tbt b" id="tbb" onclick="pickTeam('blue')">üîµ BLUE</button>
        </div>
      </div>
    </div>
    <span class="section-label">GAME MODE</span>
    <div class="mode-grid" id="mode-grid"></div>
    <button class="play-btn" onclick="startGame()">‚ö° PLAY NOW</button>
    <button class="rpg-btn" id="rpg-btn" onclick="startRPG()">üîÆ ENTER THE RPG REALM ‚öîÔ∏è</button>
    <div class="hints">
      <div class="hint"><kbd>WASD</kbd><br>MOVE</div>
      <div class="hint">MOUSE<br>AIM</div>
      <div class="hint"><kbd>LMB</kbd><br>SHOOT</div>
      <div class="hint"><kbd>F</kbd> / <kbd>RMB</kbd><br>SWORD</div>
      <div class="hint"><kbd>R</kbd><br>RELOAD</div>
      <div class="hint"><kbd>Q</kbd><br>PAUSE</div>
    </div>
  </div>

  <!-- INVENTORY TAB -->
  <div id="tab-inventory" class="tab-panel">
    <div class="inv-tabs">
      <div class="inv-tab on" data-id="weapons" onclick="switchInvTab('weapons')">üî´ WEAPONS</div>
      <div class="inv-tab" data-id="skins" onclick="switchInvTab('skins')">üé® SKINS</div>
    </div>
    <div id="inv-weapons" class="inv-panel on"></div>
    <div id="inv-skins" class="inv-panel"></div>
  </div>

  <!-- SHOP TAB -->
  <div id="tab-shop" class="tab-panel">
    <div class="shop-tabs">
      <div class="shop-tab on" data-id="weapons" onclick="switchShopTab('weapons')">üî´ WEAPONS</div>
      <div class="shop-tab" data-id="skins" onclick="switchShopTab('skins')">üé® SKINS</div>
      <div class="shop-tab" data-id="bundles" onclick="switchShopTab('bundles')">üì¶ BUNDLES</div>
    </div>
    <div id="shop-weapons" class="shop-panel on"></div>
    <div id="shop-skins" class="shop-panel"></div>
    <div id="shop-bundles" class="shop-panel"></div>
  </div>

</div><!-- /menu-wrap -->
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê GAME ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="s-game" class="screen">
  <canvas id="gc"></canvas>
  <div id="hud">
    <div id="scorebar">
      <div>
        <div id="mode-tag"></div>
        <div style="display:flex;align-items:center;gap:.8rem">
          <span class="sc r" id="sc-r">0</span>
          <div class="sep" id="sep-txt">KILLS<br>TO 30</div>
          <span class="sc b" id="sc-b">0</span>
        </div>
        <div id="koth-bar" style="display:none;margin-top:.3rem">
          <div class="koth-track"><div class="kfr" id="kfr" style="width:0%"></div><div class="kfb" id="kfb" style="width:0%"></div></div>
        </div>
      </div>
    </div>
    <div id="stats">K&nbsp;<span id="s-k">0</span>&nbsp;&nbsp;D&nbsp;<span id="s-d">0</span>&nbsp;&nbsp;STK&nbsp;<span id="s-s">0</span></div>
    <div id="coin-hud"><span class="coin-hud-ico">ü™ô</span><span id="coin-hud-val">0</span></div>
    <div id="feed"></div>
    <div id="bot-hud">
      <div id="hp-row"><span class="hl">HP</span><span class="hrt" id="h1">‚ù§Ô∏è</span><span class="hrt" id="h2">‚ù§Ô∏è</span><span class="hrt" id="h3">‚ù§Ô∏è</span><span id="shld-hud"></span></div>
      <div id="pow-row"></div>
      <div id="ammo-row"><span id="g-lbl">PISTOL</span><div id="bpips"></div><span id="reload-lbl">RELOADING‚Ä¶</span></div>
    </div>
    <div id="map-lbl"></div>
    <div id="respawn"><div id="rs-lbl">‚Äî ELIMINATED ‚Äî</div><div id="rs-n">3</div></div>
    <div id="streak"><div id="streak-txt"></div></div>
    <div id="coin-pop"></div>
    <div id="flash2" style="position:fixed;inset:0;pointer-events:none;z-index:4;opacity:0;transition:opacity .1s;background:rgba(255,49,49,.18)"></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PAUSE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="s-pause" class="screen">
  <div class="pause-title">PAUSED</div>
  <div class="pause-sub">Q / ESC TO RESUME</div>
  <button class="pause-btn green" onclick="togglePause()">‚ñ∂ RESUME</button>
  <button class="pause-btn red" onclick="exitToMenu()">‚úï EXIT TO MENU</button>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê END ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="s-end" class="screen">
  <div id="end-title">RED WINS!</div>
  <div id="end-sub">ROUND OVER</div>
  <div id="end-coins"></div>
  <table><thead><tr><th>#</th><th>PLAYER</th><th>TEAM</th><th>K</th><th>D</th><th>K/D</th><th>SCORE</th></tr></thead>
    <tbody id="end-sb"></tbody></table>
  <button id="again-btn" onclick="goMenu()">PLAY AGAIN</button>
</div>

<script>
'use strict';
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PERSISTENCE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function lsGet(k,def){try{const v=localStorage.getItem(k);return v===null?def:JSON.parse(v);}catch(e){return def;}}
function lsSet(k,v){try{localStorage.setItem(k,JSON.stringify(v));}catch(e){}}

let coins       = lsGet('rv_coins',0);
let ownedWeapons= lsGet('rv_weapons',['pistol']);
let ownedSkins  = lsGet('rv_skins',['default']);
let equippedWeapon = lsGet('rv_eq_weapon','pistol');
let equippedSkin   = lsGet('rv_eq_skin','default');
let rpgUnlocked = lsGet('rv_rpg',false);

function saveAll(){
  lsSet('rv_coins',coins);lsSet('rv_weapons',ownedWeapons);lsSet('rv_skins',ownedSkins);
  lsSet('rv_eq_weapon',equippedWeapon);lsSet('rv_eq_skin',equippedSkin);lsSet('rv_rpg',rpgUnlocked);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DATA ‚Äî WEAPONS (10 total)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const ALL_WEAPONS=[
  {id:'pistol',  name:'PISTOL',    icon:'üî´', price:0,   col:'#94A3B8',dmg:1,rate:.42,spd:620,spread:.07,ammo:12,reload:1.3,pel:1,range:1.5,tw:2.5, desc:'Reliable sidearm',badge:''},
  {id:'smg',     name:'SMG',       icon:'‚öôÔ∏è', price:150, col:'#22D3EE',dmg:1,rate:.09,spd:560,spread:.19,ammo:30,reload:2.0,pel:1,range:1.2,tw:2,   desc:'High fire rate',badge:'HOT'},
  {id:'shotgun', name:'SHOTGUN',   icon:'üí•', price:200, col:'#F97316',dmg:1,rate:.88,spd:420,spread:.34,ammo:6, reload:1.9,pel:5,range:.6, tw:3,   desc:'Devastating close-up',badge:''},
  {id:'sniper',  name:'SNIPER',    icon:'üéØ', price:300, col:'#A3E635',dmg:3,rate:1.3,spd:1150,spread:.01,ammo:5,reload:2.2,pel:1,range:2.1,tw:2.5, desc:'One-shot power',badge:''},
  {id:'assault', name:'ASSAULT',   icon:'üî¥', price:250, col:'#FB7185',dmg:1,rate:.19,spd:680,spread:.10,ammo:20,reload:1.6,pel:1,range:1.4,tw:2.5, desc:'Balanced all-rounder',badge:''},
  {id:'revolver',name:'REVOLVER',  icon:'üåÄ', price:180, col:'#FCD34D',dmg:2,rate:.7, spd:780,spread:.04,ammo:6, reload:1.4,pel:1,range:1.7,tw:3,   desc:'High damage, slow fire',badge:'NEW'},
  {id:'minigun', name:'MINIGUN',   icon:'üå™Ô∏è', price:400, col:'#DC2626',dmg:1,rate:.055,spd:500,spread:.28,ammo:80,reload:3.2,pel:1,range:1.0,tw:2,  desc:'Unstoppable barrage',badge:'HOT'},
  {id:'crossbow',name:'CROSSBOW',  icon:'‚ö°', price:350, col:'#06B6D4',dmg:2,rate:.85,spd:950,spread:.02,ammo:8, reload:1.8,pel:1,range:1.9,tw:3.5, desc:'Silent & deadly',badge:''},
  {id:'plasma',  name:'PLASMA',    icon:'üîµ', price:450, col:'#818CF8',dmg:2,rate:.32,spd:740,spread:.06,ammo:15,reload:1.7,pel:1,range:1.6,tw:3.5, desc:'Pierces through enemies',pierce:true,badge:'NEW'},
  {id:'rpg_gun', name:'ROCKET',    icon:'üöÄ', price:500, col:'#FF6600',dmg:3,rate:1.8,spd:480,spread:.03,ammo:3, reload:2.8,pel:1,range:1.2,tw:4,   desc:'Explosive damage',aoe:55,badge:'HOT'},
];
const GUN_ORDER=['pistol','smg','shotgun','assault','sniper']; // gun game order

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DATA ‚Äî SKINS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const ALL_SKINS=[
  {id:'default', name:'DEFAULT',  icon:'‚ö™', price:0,   col:'#94A3B8',glow:'rgba(150,160,190,.5)',badge:''},
  {id:'phantom', name:'PHANTOM',  icon:'üëª', price:100, col:'#8B5CF6',glow:'rgba(139,92,246,.7)', badge:''},
  {id:'demon',   name:'DEMON',    icon:'üòà', price:150, col:'#DC2626',glow:'rgba(220,38,38,.7)',  badge:'HOT'},
  {id:'ghost',   name:'GHOST',    icon:'ü§ç', price:120, col:'#CBD5E1',glow:'rgba(200,210,225,.5)',badge:''},
  {id:'blaze',   name:'BLAZE',    icon:'üî•', price:200, col:'#F97316',glow:'rgba(249,115,22,.7)', badge:''},
  {id:'void',    name:'VOID',     icon:'‚ö´', price:250, col:'#4338CA',glow:'rgba(99,102,241,.7)', badge:''},
  {id:'storm',   name:'STORM',    icon:'‚ö°', price:180, col:'#0891B2',glow:'rgba(8,145,178,.7)',  badge:'NEW'},
  {id:'neon',    name:'NEON',     icon:'üåà', price:320, col:'#EC4899',glow:'rgba(236,72,153,.7)', badge:'NEW'},
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DATA ‚Äî BUNDLES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const BUNDLES=[
  {id:'assassin',  name:'ASSASSIN',   icon:'ü•∑', price:380, weapons:['sniper'],  skins:['ghost'],   badge:'',    desc:'Sniper + Ghost skin (save 120)'},
  {id:'inferno',   name:'INFERNO',    icon:'üî•', price:300, weapons:['shotgun'], skins:['blaze'],   badge:'HOT', desc:'Shotgun + Blaze skin (save 100)'},
  {id:'cyber',     name:'CYBER OPS',  icon:'ü§ñ', price:500, weapons:['plasma'],  skins:['storm'],   badge:'NEW', desc:'Plasma + Storm skin (save 130)'},
  {id:'heavy',     name:'HEAVY METAL',icon:'üí™', price:480, weapons:['minigun'], skins:['demon'],   badge:'HOT', desc:'Minigun + Demon skin (save 70)'},
  {id:'rocket',    name:'ROCKETEER',  icon:'üöÄ', price:550, weapons:['rpg_gun'], skins:['blaze'],   badge:'',    desc:'Rocket + Blaze skin (save 150)'},
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DATA ‚Äî MODES / SKINS / etc
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const MODES=[
  {id:'tdm', icon:'‚öîÔ∏è',  name:'TEAM DM',    desc:'First to 30 kills', target:30, teams:true},
  {id:'ffa', icon:'üíÄ',  name:'FREE 4 ALL',  desc:'First to 8 kills',  target:8,  teams:false},
  {id:'koth',icon:'üëë',  name:'KING OF HILL',desc:'Hold zone 20s',     target:20, teams:true},
  {id:'ctf', icon:'üö©',  name:'CAPTURE FLAG',desc:'Capture 3 flags',   target:3,  teams:true},
  {id:'gun', icon:'üî´',  name:'GUN GAME',    desc:'Cycle 5 weapons',   target:null,teams:false},
  {id:'1v1', icon:'ü•ä',  name:'1 VS 1',      desc:'You vs bot, 5 kills',target:5, teams:true},
];
const BOT_NAMES_R=['REAPER','BLOODAX','VORTEX','INFERNO'];
const BOT_NAMES_B=['SPECTER','NOCTUA','CIPHER','WRAITH'];
const BOT_NAMES_F=['ROGUE','BLADE','APEX','VIPER','SHADOW','RONIN'];
const THEMES=[
  {fl:'#050a0a',gr:'rgba(255,140,0,.025)',wf:'#0a0e12',ws:'rgba(255,140,50,.25)',wa:'rgba(255,140,50,.7)',st:'rgba(255,100,0,.06)',name:'INDUSTRIAL'},
  {fl:'#080710',gr:'rgba(180,150,70,.025)',wf:'#0f0a06',ws:'rgba(190,140,60,.28)',wa:'rgba(210,170,80,.7)',st:'rgba(160,110,40,.06)',name:'RUINS'},
  {fl:'#040810',gr:'rgba(0,210,90,.025)',wf:'#040a06',ws:'rgba(0,180,80,.25)',wa:'rgba(0,220,100,.7)',st:'rgba(0,170,70,.06)',name:'BUNKER'},
  {fl:'#050408',gr:'rgba(160,0,255,.025)',wf:'#0a0510',ws:'rgba(140,0,230,.28)',wa:'rgba(170,0,255,.7)',st:'rgba(130,0,210,.06)',name:'VOID'},
  {fl:'#060408',gr:'rgba(255,0,130,.025)',wf:'#0d0410',ws:'rgba(255,0,100,.25)',wa:'rgba(255,0,130,.7)',st:'rgba(210,0,95,.06)',name:'NEON'},
];
const POWS=[
  {id:'health',icon:'‚ù§Ô∏è',col:'#EF4444',lbl:'HEALTH +1'},
  {id:'speed', icon:'‚ö°',col:'#FFE600',lbl:'SPEED BOOST'},
  {id:'damage',icon:'üî•',col:'#F97316',lbl:'DAMAGE AMP'},
  {id:'shield',icon:'üõ°Ô∏è',col:'#00F5FF',lbl:'SHIELD'},
];
const STREAKS={2:'DOUBLE KILL!!',3:'TRIPLE KILL!!!',4:'QUAD KILL!!!!',5:'RAMPAGE!!!!!',6:'GODLIKE!!!!'};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GAME CONSTANTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const AW=1400,AH=800,RAD=15,MAX_HP=3;
const SR=68,SARC=Math.PI*.68,ADR=.25,SCD=0.9;
const PSPD=250,BSPD=155,RSP=3;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GAME STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let cvs,ctx,map;
let ents=[],bullets=[],particles=[],pups=[],flags={};
let player=null;
let keys={},mouse={x:700,y:400},mdown=false;
let shakeX=0,shakeY=0,shakeMag=0,scl=1,ox=0,oy=0;
let running=false,paused=false,gameOver=false,lastT=0;
let feedList=[],feedItems=[];
let kills={red:0,blue:0},ffaK={},kothT={red:0,blue:0},ctfC={red:0,blue:0};
let pup_t=0,roundCoins=0;
let mode=MODES[0],myTeam='red';
let _secretBuf='';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MAP GEN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function mkObs(){
  const sets=[
    [{x:645,y:345,w:110,h:110},{x:295,y:140,w:85,h:170},{x:295,y:490,w:85,h:170},{x:AW-380,y:140,w:85,h:170},{x:AW-380,y:490,w:85,h:170},{x:490,y:65,w:130,h:65},{x:490,y:AH-130,w:130,h:65},{x:AW-620,y:65,w:130,h:65},{x:AW-620,y:AH-130,w:130,h:65}],
    [{x:225,y:245,w:350,h:40},{x:825,y:245,w:350,h:40},{x:225,y:AH-285,w:350,h:40},{x:825,y:AH-285,w:350,h:40},{x:AW/2-35,y:150,w:70,h:165},{x:AW/2-35,y:AH-315,w:70,h:165},{x:AW/2-35,y:AH/2-35,w:70,h:70}],
    [{x:385,y:185,w:75,h:195},{x:385,y:185,w:195,h:75},{x:385,y:AH-380,w:75,h:195},{x:385,y:AH-260,w:195,h:75},{x:AW-460,y:185,w:75,h:195},{x:AW-580,y:185,w:195,h:75},{x:AW-460,y:AH-380,w:75,h:195},{x:AW-580,y:AH-260,w:195,h:75},{x:AW/2-45,y:AH/2-90,w:90,h:180}],
    [{x:AW/2-55,y:AH/2-55,w:110,h:110},{x:330,y:180,w:75,h:75},{x:330,y:AH-255,w:75,h:75},{x:AW-405,y:180,w:75,h:75},{x:AW-405,y:AH-255,w:75,h:75},{x:540,y:AH/2-38,w:95,h:76},{x:AW-635,y:AH/2-38,w:95,h:76}],
  ];
  return sets[Math.floor(Math.random()*sets.length)];
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ENTITY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
class Entity {
  constructor(x,y,team,name,isP,skinId,gunId){
    this.x=x;this.y=y;this.team=team;this.name=name;this.isP=!!isP;
    this.skin=ALL_SKINS.find(s=>s.id===skinId)||ALL_SKINS[0];
    this.setGun(gunId||'pistol');
    this.hp=MAX_HP;this.dead=false;this.hitF=0;
    this.vx=0;this.vy=0;this.angle=team==='red'?.1:Math.PI-.1;
    this.kills=0;this.deaths=0;this.score=0;this.streak=0;
    this.shield=0;this.swordHits=0;
    this.powSpd=false;this.powSpdT=0;this.powDmg=false;this.powDmgT=0;
    this.atk=false;this.atkA=0;this.atkT=0;this.atkCD=0;this.hitSet=new Set();
    this.gunIdx=0;this.respT=0;
    // Bot AI state
    this.aggro=.4+Math.random()*.6;
    this.target=null;this.wAngle=Math.random()*Math.PI*2;this.wT=0;
    this.bGunCD=0;this.stT=0;this.state='chase';
    this._sx=x;this._sy=y;this._stk=0;this._fw=0;
  }
  setGun(id){
    const g=ALL_WEAPONS.find(w=>w.id===id)||ALL_WEAPONS[0];
    this.gun=g;this.ammo=g.ammo;
    this.reloading=false;this.reloadT=0;this.fireCD=0;
    return this;
  }
  get tc(){return this.team==='red'?'#FF3131':this.team==='blue'?'#1E90FF':'#FFE600';}
  get tg(){return this.team==='red'?'rgba(255,49,49,.5)':this.team==='blue'?'rgba(30,144,255,.5)':'rgba(255,230,0,.4)';}

  takeDmg(src,dmg,isSword=false){
    if(this.dead)return;
    if(isSword){
      if(this.shield>0){
        this.shield=Math.max(0,this.shield-1);this.hitF=.2;
        burst(this.x,this.y,'#00F5FF',6);if(this.isP)upHp();return;
      }
      this.swordHits++;this.hitF=.2;
      burst(this.x,this.y,'rgba(255,220,50,.8)',4);
      if(this.swordHits<2){if(this.isP)upHp();return;}
      this.swordHits=0;dmg=1;
    } else {
      if(this.shield>0){
        this.shield=Math.max(0,this.shield-dmg);this.hitF=.18;
        burst(this.x,this.y,'#00F5FF',5);if(this.isP)upHp();return;
      }
    }
    this.hp=Math.max(0,this.hp-dmg);this.hitF=.2;
    if(this.hp<=0)this.die(src);
    else if(this.isP){shakeIt(isSword?4:2);upHp();}
  }

  die(src){
    this.dead=true;this.hp=0;this.deaths++;this.streak=0;this.swordHits=0;
    this.respT=RSP;
    burst(this.x,this.y,this.tc,28,true);burst(this.x,this.y,'#FFE600',8,true);
    if(src){
      src.kills++;src.streak++;src.score+=100;
      // Update all score trackers
      if(mode.teams)kills[src.team]++;
      else ffaK[src.name]=(ffaK[src.name]||0)+1;
      // Gun game: ALL killers advance weapon
      if(mode.id==='gun'){
        src.gunIdx=Math.min(GUN_ORDER.length-1,src.gunIdx+1);
        src.setGun(GUN_ORDER[src.gunIdx]);
        if(src.isP)upAmmo();
      }
      addFeed(src.name,this.name,src.team||'ffa');
      if(src.isP){
        // Coins: 10 per kill
        coins+=10;roundCoins+=10;saveAll();
        upCoinHud();showCoinPop(src.x,src.y);
        if(STREAKS[src.streak])showStreak(STREAKS[src.streak]);
        upStats();
      }
      upScore();checkWin();
    }
    if(this.isP){
      shakeIt(12);upHp();upStats();
      const fl=document.getElementById('flash2');fl.style.opacity='.7';setTimeout(()=>fl.style.opacity='0',200);
      setTimeout(()=>showRespawn(Math.ceil(this.respT)),10);
    }
  }

  respawn(){
    let x,y,safe,t=0;
    do{
      safe=true;
      if(mode.id==='ffa'||mode.id==='gun'){
        x=Math.random()<.5?55+Math.random()*110:AW-55-Math.random()*110;
      }else{
        x=this.team==='red'?55+Math.random()*130:AW-55-Math.random()*130;
      }
      y=80+Math.random()*(AH-160);
      for(const o of map.obs)if(x>o.x-RAD&&x<o.x+o.w+RAD&&y>o.y-RAD&&y<o.y+o.h+RAD){safe=false;break;}
    }while(!safe&&++t<40);
    this.x=x;this.y=y;this.hp=MAX_HP;this.dead=false;this.hitF=0;
    this.shield=0;this.swordHits=0;
    this.ammo=this.gun.ammo;this.reloading=false;this.reloadT=0;this.fireCD=0;this.atkCD=0;
    if(this.isP){upHp();upAmmo();hideRespawn();}
  }

  shoot(a){
    if(this.fireCD>0||this.reloading||this.ammo<=0||this.dead)return;
    const dmg=this.gun.dmg*(this.powDmg?2:1);
    for(let i=0;i<this.gun.pel;i++){
      const sp=(Math.random()-.5)*this.gun.spread*2+(this.gun.pel>1?(i-2)*.06:0);
      bullets.push(new Bullet(this.x,this.y,a+sp,this,this.gun,dmg));
    }
    this.ammo--;this.fireCD=this.gun.rate;
    if(this.ammo===0){this.reloading=true;this.reloadT=this.gun.reload;}
    if(this.isP){shakeIt(this.gun.id==='shotgun'?5:this.gun.id==='sniper'?4:this.gun.id==='minigun'?2:1);upAmmo();}
  }

  startAtk(){
    if(this.atkCD>0||this.atk||this.dead)return;
    this.atk=true;this.atkA=this.angle;this.atkT=ADR;this.atkCD=SCD;this.hitSet.clear();
  }

  checkMelee(){
    for(const e of ents){
      if(e===this||e.dead||this.hitSet.has(e))continue;
      if(mode.teams&&e.team===this.team)continue;
      const d=Math.hypot(e.x-this.x,e.y-this.y);if(d>SR+RAD)continue;
      let df=Math.atan2(e.y-this.y,e.x-this.x)-this.atkA;
      while(df>Math.PI)df-=Math.PI*2;while(df<-Math.PI)df+=Math.PI*2;
      if(Math.abs(df)<=SARC){this.hitSet.add(e);e.takeDmg(this,1,true);}
    }
  }

  update(dt){
    if(this.hitF>0)this.hitF=Math.max(0,this.hitF-dt);
    if(this.powSpd){this.powSpdT-=dt;if(this.powSpdT<=0)this.powSpd=false;}
    if(this.powDmg){this.powDmgT-=dt;if(this.powDmgT<=0)this.powDmg=false;}
    if(this.fireCD>0)this.fireCD-=dt;
    if(this.atkCD>0)this.atkCD-=dt;
    if(this.reloading){this.reloadT-=dt;if(this.reloadT<=0){this.reloading=false;this.ammo=this.gun.ammo;if(this.isP)upAmmo();}}
    if(this.atk){this.atkT-=dt;if(this.atkT<=0)this.atk=false;else this.checkMelee();}
    if(this.dead){this.respT-=dt;if(this.respT<=0)this.respawn();return;}
    this.isP?this.upPlayer():this.upBot(dt);
    this.x+=this.vx*dt;this.y+=this.vy*dt;
    this.x=Math.max(RAD,Math.min(AW-RAD,this.x));
    this.y=Math.max(RAD,Math.min(AH-RAD,this.y));
    for(const o of map.obs)pushOut(this,o);
    // Powerups
    for(const p of pups){
      if(p.dead)continue;
      if(Math.hypot(p.x-this.x,p.y-this.y)<22){p.dead=true;applyPow(this,p.type);}
    }
  }

  upPlayer(){
    let dx=0,dy=0;
    if(keys['w']||keys['arrowup'])dy=-1;if(keys['s']||keys['arrowdown'])dy=1;
    if(keys['a']||keys['arrowleft'])dx=-1;if(keys['d']||keys['arrowright'])dx=1;
    const l=Math.hypot(dx,dy);if(l>0){dx/=l;dy/=l;}
    const sp=PSPD*(this.powSpd?1.55:1);
    this.vx=dx*sp;this.vy=dy*sp;
    const wx=(mouse.x-ox)/scl,wy=(mouse.y-oy)/scl;
    this.angle=Math.atan2(wy-this.y,wx-this.x);
    if(mdown)this.shoot(this.angle);
  }

  upBot(dt){
    // Edge + obstacle avoidance
    const AR=70;let ax=0,ay=0;
    const ep=55;
    if(this.x<ep)ax+=(ep-this.x)/ep;if(this.x>AW-ep)ax-=(this.x-(AW-ep))/ep;
    if(this.y<ep)ay+=(ep-this.y)/ep;if(this.y>AH-ep)ay-=(this.y-(AH-ep))/ep;
    for(const o of map.obs){
      const cx=Math.max(o.x,Math.min(o.x+o.w,this.x)),cy=Math.max(o.y,Math.min(o.y+o.h,this.y));
      const dx=this.x-cx,dy=this.y-cy,d=Math.hypot(dx,dy);
      if(d<AR&&d>0){const s=(AR-d)/AR;ax+=dx/d*s*2;ay+=dy/d*s*2;}
    }
    const al=Math.hypot(ax,ay);if(al>1){ax/=al;ay/=al;}
    // Stuck detection
    this._stk+=dt;
    if(this._stk>0.6){
      if(Math.hypot(this.x-this._sx,this.y-this._sy)<8){this.wAngle=Math.random()*Math.PI*2;this._fw=0.7;}
      this._sx=this.x;this._sy=this.y;this._stk=0;
    }
    if(this._fw>0){
      this._fw-=dt;
      this.vx=Math.cos(this.wAngle)*BSPD+ax*BSPD;this.vy=Math.sin(this.wAngle)*BSPD+ay*BSPD;
      this.angle=this.wAngle;return;
    }
    // Target
    if(!this.target||this.target.dead){
      this.target=null;
      let best=Infinity;
      for(const e of ents){
        if(e===this||e.dead)continue;
        if(mode.teams&&e.team===this.team)continue;
        const d=Math.hypot(e.x-this.x,e.y-this.y);
        // Prefer player
        const w=e.isP?0.5:1;
        if(d*w<best){best=d*w;this.target=e;}
      }
    }
    if(!this.target){
      this.wT-=dt;if(this.wT<=0){this.wAngle=(Math.random()-.5)*Math.PI*2;this.wT=.5+Math.random()*.8;}
      this.vx=Math.cos(this.wAngle)*BSPD*.5+ax*BSPD*.5;this.vy=Math.sin(this.wAngle)*BSPD*.5+ay*BSPD*.5;return;
    }
    const tx=this.target.x,ty=this.target.y;
    const d=Math.hypot(tx-this.x,ty-this.y);
    const toT=Math.atan2(ty-this.y,tx-this.x);
    this.angle=toT;
    this.stT-=dt;if(this.stT<=0){
      this.state=this.hp<=1&&d>120?'retreat':d<SR+22?'strafe':'chase';
      this.stT=.35+Math.random()*.5;
    }
    this.bGunCD-=dt;
    if(d>SR+20&&d<900&&!this.reloading&&this.ammo>0&&this.bGunCD<=0){
      const lead=d/this.gun.spd;
      const aimA=Math.atan2(ty+this.target.vy*lead-this.y,tx+this.target.vx*lead-this.x);
      this.shoot(aimA+(Math.random()-.5)*.25*(1-this.aggro));
      this.bGunCD=this.gun.rate*(1+Math.random()*.4);
    }
    if(d<SR+8)this.startAtk();
    const sp=BSPD*(this.powSpd?1.55:1),aw=Math.min(1,al*1.4);
    const cx2=Math.cos(toT),cy2=Math.sin(toT);
    const sdir=this.kills%2===0?1:-1;
    switch(this.state){
      case'chase':this.vx=(cx2*(1-aw)+ax*aw)*sp;this.vy=(cy2*(1-aw)+ay*aw)*sp;break;
      case'strafe':{const s=toT+Math.PI/2*sdir;this.vx=(Math.cos(s)*(1-aw)+ax*aw)*sp*.85;this.vy=(Math.sin(s)*(1-aw)+ay*aw)*sp*.85;break;}
      case'retreat':this.vx=(-cx2+ax*aw)*sp*.9;this.vy=(-cy2+ay*aw)*sp*.9;break;
    }
  }

  draw(){
    if(this.dead)return;
    const c=ctx;c.save();c.translate(this.x,this.y);
    // Sword arc
    if(this.atk){
      const prog=1-this.atkT/ADR;
      c.beginPath();c.moveTo(0,0);c.arc(0,0,SR,this.atkA-SARC,this.atkA-SARC+prog*SARC*2);c.closePath();
      c.fillStyle=this.isP?'rgba(255,230,0,.15)':this.team==='red'?'rgba(255,49,49,.15)':'rgba(30,144,255,.15)';c.fill();
    }
    // Body
    c.shadowColor=this.isP?this.skin.glow:this.tg;c.shadowBlur=this.isP?24:10;
    c.beginPath();c.arc(0,0,RAD,0,Math.PI*2);
    c.fillStyle=this.hitF>0?'#ffffff':this.tc;
    if(this.hitF>0)c.globalAlpha=.7;
    c.fill();c.globalAlpha=1;c.shadowBlur=0;
    // Inner skin color
    c.beginPath();c.arc(0,0,RAD*.65,0,Math.PI*2);c.fillStyle=this.skin.col;c.fill();
    // Skin emoji in center
    c.font='10px sans-serif';c.textAlign='center';c.textBaseline='middle';
    c.fillText(this.skin.icon,0,.5);
    // Shield ring
    if(this.shield>0){
      c.beginPath();c.arc(0,0,RAD+6,0,Math.PI*2);
      c.strokeStyle='rgba(0,245,255,.75)';c.lineWidth=2.5;c.shadowColor='#00F5FF';c.shadowBlur=10;c.stroke();c.shadowBlur=0;
    }
    // Player ring
    if(this.isP){
      c.beginPath();c.arc(0,0,RAD+5,0,Math.PI*2);c.strokeStyle='rgba(255,230,0,.75)';c.lineWidth=2;c.stroke();
    }
    // Sword
    const sa=this.atk?this.atkA-SARC+(1-this.atkT/ADR)*SARC*2:this.angle;
    c.save();c.rotate(sa);
    c.shadowColor=this.atk?'rgba(255,230,0,.8)':'transparent';c.shadowBlur=this.atk?12:0;
    c.beginPath();c.moveTo(RAD-1,-1.5);c.lineTo(SR*.85,0);
    c.strokeStyle=this.atk?'#FFE600':'rgba(210,215,230,.75)';c.lineWidth=this.atk?3:2;c.stroke();
    c.beginPath();c.moveTo(RAD+9,-7);c.lineTo(RAD+9,7);
    c.strokeStyle=this.atk?'rgba(255,230,0,.85)':'rgba(190,200,220,.65)';c.lineWidth=2.5;c.stroke();
    c.shadowBlur=0;c.restore();
    c.restore();
    // HP bar
    const bw=38,bh=4;
    ctx.fillStyle='rgba(0,0,0,.65)';ctx.fillRect(this.x-bw/2-1,this.y-RAD-13,bw+2,bh+2);
    ctx.fillStyle=this.hp<=1?'#EF4444':'#22C55E';
    ctx.fillRect(this.x-bw/2,this.y-RAD-12,bw*(this.hp/MAX_HP),bh);
    // Name label
    ctx.font=this.isP?'bold 11px Rajdhani,sans-serif':'700 9px Rajdhani,sans-serif';
    ctx.textAlign='center';
    ctx.fillStyle=this.isP?'rgba(255,230,0,.95)':'rgba(200,210,235,.5)';
    ctx.fillText(this.isP?'‚ñ∂ YOU':(this.name+(this.isP?'':' ü§ñ')),this.x,this.y-RAD-17);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BULLET
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
class Bullet{
  constructor(x,y,a,owner,g,dmg){
    this.x=x;this.y=y;
    this.vx=Math.cos(a)*g.spd;this.vy=Math.sin(a)*g.spd;
    this.owner=owner;this.team=owner.team;
    this.dmg=dmg||g.dmg;this.gid=g.id;this.spd=g.spd;
    this.col=g.col;this.tw=g.tw||2.5;this.life=g.range;
    this.pierce=!!g.pierce;this.aoe=g.aoe||0;
    this.dead=false;this.hitEnts=new Set();
    // Trail
    this.trail=[];
  }
  update(dt){
    if(this.dead)return;
    // Store trail point
    this.trail.push({x:this.x,y:this.y});
    if(this.trail.length>4)this.trail.shift();
    this.x+=this.vx*dt;this.y+=this.vy*dt;
    this.life-=dt;
    if(this.life<=0||this.x<-10||this.x>AW+10||this.y<-10||this.y>AH+10){this.dead=true;return;}
    // Wall hit
    for(const o of map.obs){
      if(this.x>o.x&&this.x<o.x+o.w&&this.y>o.y&&this.y<o.y+o.h){
        this.dead=true;burst(this.x,this.y,this.col,4);return;
      }
    }
    // Entity hit
    for(const e of ents){
      if(e===this.owner||e.dead||this.hitEnts.has(e))continue;
      if(mode.teams&&e.team===this.team)continue;
      if(Math.hypot(e.x-this.x,e.y-this.y)<RAD+3){
        // AOE (rockets)
        if(this.aoe>0){
          for(const e2 of ents){
            if(e2===this.owner||e2.dead)continue;
            if(mode.teams&&e2.team===this.team)continue;
            if(Math.hypot(e2.x-this.x,e2.y-this.y)<this.aoe)e2.takeDmg(this.owner,this.dmg);
          }
          burst(this.x,this.y,this.col,18,true);shakeIt(8);
          this.dead=true;return;
        }
        e.takeDmg(this.owner,this.dmg);
        burst(this.x,this.y,this.col,8);
        shakeIt(this.gid==='sniper'?8:this.gid==='shotgun'?6:2);
        if(this.pierce){this.hitEnts.add(e);}
        else{this.dead=true;return;}
      }
    }
  }
  draw(){
    if(this.dead)return;
    const c=ctx;
    const a=Math.min(1,this.life*3);
    c.save();c.globalAlpha=a;
    // Trail
    if(this.trail.length>=2){
      c.beginPath();
      c.moveTo(this.trail[0].x,this.trail[0].y);
      for(let i=1;i<this.trail.length;i++)c.lineTo(this.trail[i].x,this.trail[i].y);
      c.lineTo(this.x,this.y);
      c.strokeStyle=this.col+'66';c.lineWidth=this.tw*.6;c.stroke();
    }
    // Bullet body
    c.shadowColor=this.col;c.shadowBlur=this.gid==='sniper'?14:this.gid==='plasma'?10:6;
    c.strokeStyle=this.col;c.lineWidth=this.tw;
    c.beginPath();
    // Draw as line in direction of travel for clear visibility
    const blen=this.gid==='sniper'?18:this.gid==='shotgun'?6:10;
    const ang=Math.atan2(this.vy,this.vx);
    c.moveTo(this.x-Math.cos(ang)*blen,this.y-Math.sin(ang)*blen);
    c.lineTo(this.x+Math.cos(ang)*2,this.y+Math.sin(ang)*2);
    c.stroke();
    // Bright tip
    c.shadowBlur=16;c.fillStyle='#ffffff';
    c.beginPath();c.arc(this.x,this.y,this.tw*.8,0,Math.PI*2);c.fill();
    c.shadowBlur=0;c.restore();
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PARTICLES / POWERUPS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
class Particle{
  constructor(x,y,col,big){
    this.x=x;this.y=y;this.col=col;
    const a=Math.random()*Math.PI*2,s=big?100+Math.random()*260:40+Math.random()*140;
    this.vx=Math.cos(a)*s;this.vy=Math.sin(a)*s;
    this.life=big?.4+Math.random()*.5:.18+Math.random()*.28;
    this.ml=this.life;this.r=big?2+Math.random()*5:1.5+Math.random()*3;
  }
  update(dt){this.x+=this.vx*dt;this.y+=this.vy*dt;this.vx*=.87;this.vy*=.87;this.life-=dt;}
  draw(){
    const a=Math.max(0,this.life/this.ml);
    ctx.globalAlpha=a*.85;ctx.beginPath();ctx.arc(this.x,this.y,this.r*Math.sqrt(a),0,Math.PI*2);
    ctx.fillStyle=this.col;ctx.fill();ctx.globalAlpha=1;
  }
}
function burst(x,y,col,n,big=false){for(let i=0;i<n;i++)particles.push(new Particle(x,y,col,big));}

class Powerup{
  constructor(x,y,t){this.x=x;this.y=y;this.type=t;this.anim=Math.random()*Math.PI*2;this.dead=false;}
  draw(){
    const bob=Math.sin(Date.now()*.0022+this.anim)*4;
    ctx.save();ctx.translate(this.x,this.y+bob);
    ctx.shadowColor=this.type.col;ctx.shadowBlur=14;
    ctx.beginPath();ctx.arc(0,0,11,0,Math.PI*2);ctx.fillStyle='rgba(4,4,10,.9)';ctx.fill();
    ctx.strokeStyle=this.type.col;ctx.lineWidth=2;ctx.stroke();ctx.shadowBlur=0;
    ctx.font='12px sans-serif';ctx.textAlign='center';ctx.textBaseline='middle';
    ctx.fillText(this.type.icon,0,0);ctx.restore();
  }
}
function applyPow(e,t){
  switch(t.id){
    case'health':e.hp=Math.min(MAX_HP,e.hp+1);if(e.isP)upHp();break;
    case'speed':e.powSpd=true;e.powSpdT=5;break;
    case'damage':e.powDmg=true;e.powDmgT=5;break;
    case'shield':e.shield=2;if(e.isP)upHp();break;
  }
  if(e.isP)upPow();burst(e.x,e.y,t.col,8);
}
function spawnPup(){
  let x,y,safe,t=0;
  do{safe=true;x=240+Math.random()*(AW-480);y=60+Math.random()*(AH-120);
    for(const o of map.obs)if(x>o.x-20&&x<o.x+o.w+20&&y>o.y-20&&y<o.y+o.h+20){safe=false;break;}
  }while(!safe&&++t<30);
  pups.push(new Powerup(x,y,POWS[Math.floor(Math.random()*POWS.length)]));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MAP DRAW
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function pushOut(e,o){
  const cx=Math.max(o.x,Math.min(o.x+o.w,e.x)),cy=Math.max(o.y,Math.min(o.y+o.h,e.y));
  const dx=e.x-cx,dy=e.y-cy,d=Math.hypot(dx,dy);
  if(d<RAD&&d>0){const v=RAD-d;e.x+=dx/d*v;e.y+=dy/d*v;}
  else if(d===0){e.x+=RAD;}
}

function drawMap(){
  const t=map.theme,c=ctx;
  c.fillStyle=t.fl;c.fillRect(0,0,AW,AH);
  c.strokeStyle=t.gr;c.lineWidth=1;
  for(let x=0;x<=AW;x+=50){c.beginPath();c.moveTo(x,0);c.lineTo(x,AH);c.stroke();}
  for(let y=0;y<=AH;y+=50){c.beginPath();c.moveTo(0,y);c.lineTo(AW,y);c.stroke();}
  c.strokeStyle=t.wa;c.lineWidth=2.5;c.strokeRect(3,3,AW-6,AH-6);
  // Spawn zones
  c.fillStyle='rgba(255,49,49,.03)';c.fillRect(0,0,210,AH);
  c.fillStyle='rgba(30,144,255,.03)';c.fillRect(AW-210,0,210,AH);
  c.setLineDash([8,10]);
  c.strokeStyle='rgba(255,49,49,.09)';c.lineWidth=1;c.beginPath();c.moveTo(210,0);c.lineTo(210,AH);c.stroke();
  c.strokeStyle='rgba(30,144,255,.09)';c.beginPath();c.moveTo(AW-210,0);c.lineTo(AW-210,AH);c.stroke();
  c.setLineDash([]);
  // RIVIALS watermark
  c.save();c.globalAlpha=.015;c.font='bold 180px Rajdhani,sans-serif';c.textAlign='center';c.fillStyle='#fff';c.fillText('RIVALS',AW/2,AH/2+55);c.restore();
  // KOTH zone
  if(mode.id==='koth'){
    c.beginPath();c.arc(AW/2,AH/2,85,0,Math.PI*2);
    c.fillStyle='rgba(255,230,0,.04)';c.fill();
    c.strokeStyle='rgba(255,230,0,.28)';c.lineWidth=2;c.setLineDash([10,8]);c.stroke();c.setLineDash([]);
  }
  // Obstacles
  for(const o of map.obs){
    c.fillStyle=t.wf;c.fillRect(o.x,o.y,o.w,o.h);
    c.strokeStyle=t.ws;c.lineWidth=2;c.strokeRect(o.x,o.y,o.w,o.h);
    c.save();c.beginPath();c.rect(o.x,o.y,o.w,o.h);c.clip();
    c.strokeStyle=t.st;c.lineWidth=1;
    for(let d=-o.h;d<o.w+o.h;d+=18){c.beginPath();c.moveTo(o.x+d,o.y);c.lineTo(o.x+d+o.h,o.y+o.h);c.stroke();}
    c.restore();
    const cs=9;c.strokeStyle=t.wa;c.lineWidth=2;
    [[o.x,o.y,1,1],[o.x+o.w,o.y,-1,1],[o.x,o.y+o.h,1,-1],[o.x+o.w,o.y+o.h,-1,-1]].forEach(([bx,by,sx,sy])=>{
      c.beginPath();c.moveTo(bx+sx*cs,by);c.lineTo(bx,by);c.lineTo(bx,by+sy*cs);c.stroke();
    });
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  WIN CHECK
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function checkWin(){
  if(gameOver)return;
  const t=mode.target;
  if(mode.id==='tdm'||mode.id==='1v1'){
    if(kills.red>=t)endGame(mode.id==='1v1'&&myTeam==='red'?'üèÜ YOU WIN!':'RED TEAM','r');
    else if(kills.blue>=t)endGame(mode.id==='1v1'&&myTeam==='blue'?'üèÜ YOU WIN!':'BLUE TEAM','b');
  }else if(mode.id==='ffa'){
    const top=Object.entries(ffaK).sort((a,b)=>b[1]-a[1])[0];
    if(top&&top[1]>=t)endGame(top[0]+' WINS!',top[0]===player?.name?'y':'b');
  }else if(mode.id==='koth'){
    if(kothT.red>=t)endGame('RED TEAM','r');
    else if(kothT.blue>=t)endGame('BLUE TEAM','b');
  }else if(mode.id==='ctf'){
    if(ctfC.red>=t)endGame('RED TEAM','r');
    else if(ctfC.blue>=t)endGame('BLUE TEAM','b');
  }else if(mode.id==='gun'){
    for(const e of ents){
      if(e.gunIdx>=GUN_ORDER.length-1&&e.kills>=1){
        endGame(e.isP?'üèÜ YOU WIN!':e.name+' WINS',e.isP?'y':e.team==='red'?'r':'b');return;
      }
    }
  }
}

function endGame(txt,cls){
  if(gameOver)return;gameOver=true;running=false;
  const won=(cls==='y')||(cls==='r'&&myTeam==='red')||(cls==='b'&&myTeam==='blue');
  const fl=document.getElementById('flash');
  fl.style.background=won?'rgba(255,230,0,.15)':'rgba(255,49,49,.18)';
  fl.style.opacity='1';setTimeout(()=>fl.style.opacity='0',700);
  setTimeout(()=>{
    document.getElementById('end-title').textContent=txt;
    document.getElementById('end-title').className=cls;
    document.getElementById('end-sub').textContent=mode.name+' ‚Äî ROUND OVER';
    document.getElementById('end-coins').textContent='ü™ô +'+roundCoins+' COINS EARNED THIS ROUND';
    buildSB();showScreen('s-end');
  },900);
}

function buildSB(){
  const sorted=[...ents].sort((a,b)=>b.kills-a.kills);
  const tb=document.getElementById('end-sb');tb.innerHTML='';
  sorted.forEach((e,i)=>{
    const kd=e.deaths>0?(e.kills/e.deaths).toFixed(2):e.kills+'.00';
    const tr=document.createElement('tr');if(e.isP)tr.className='me';
    const tm=e.team==='red'?'<span class="tr2">RED</span>':'<span class="tb2">BLUE</span>';
    tr.innerHTML=`<td>${i===0?'üëë':'#'+(i+1)}</td><td>${e.isP?'<b>'+e.name+' ‚óÄ</b>':e.name+(e.isP?'':' ü§ñ')}</td><td>${tm}</td><td class="tk">${e.kills}</td><td>${e.deaths}</td><td class="tkd">${kd}</td><td class="ts">${e.score.toLocaleString()}</td>`;
    tb.appendChild(tr);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  HUD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function upScore(){
  const r=document.getElementById('sc-r'),b=document.getElementById('sc-b'),sep=document.getElementById('sep-txt');
  if(mode.id==='tdm'||mode.id==='1v1'){
    r.textContent=kills.red;b.textContent=kills.blue;r.className='sc r';b.className='sc b';
    sep.innerHTML='KILLS<br>TO '+mode.target;
  }else if(mode.id==='ffa'){
    const top=Object.entries(ffaK).sort((a,b)=>b[1]-a[1])[0];
    r.textContent=top?top[1]:0;b.textContent=mode.target;r.className='sc y';b.className='sc y';
    sep.innerHTML='TOP<br>KILLS';
  }else if(mode.id==='koth'){
    r.textContent=Math.floor(kothT.red)+'s';b.textContent=Math.floor(kothT.blue)+'s';r.className='sc r';b.className='sc b';
    sep.innerHTML='ZONE<br>'+mode.target+'s';
    const pct=v=>Math.min(100,v/mode.target*100).toFixed(1)+'%';
    const kb=document.getElementById('koth-bar');if(kb)kb.style.display='block';
    const kfr=document.getElementById('kfr');if(kfr)kfr.style.width=pct(kothT.red);
    const kfb=document.getElementById('kfb');if(kfb)kfb.style.width=pct(kothT.blue);
  }else if(mode.id==='ctf'){
    r.textContent=ctfC.red;b.textContent=ctfC.blue;r.className='sc r';b.className='sc b';
    sep.innerHTML='CAPS<br>OF '+mode.target;
  }else if(mode.id==='gun'){
    r.textContent=player?player.gunIdx+1:1;b.textContent=GUN_ORDER.length;r.className='sc y';b.className='sc y';
    sep.innerHTML='GUN<br>TIER';
  }
}
function upStats(){if(!player)return;document.getElementById('s-k').textContent=player.kills;document.getElementById('s-d').textContent=player.deaths;document.getElementById('s-s').textContent=player.streak;}
function upHp(){
  if(!player)return;
  for(let i=1;i<=3;i++){const el=document.getElementById('h'+i);if(el)el.className='hrt'+(i>player.hp?' gone':'');}
  const shld=document.getElementById('shld-hud');if(shld)shld.textContent=player.shield>0?'üõ°Ô∏è'.repeat(player.shield):'';
}
function upAmmo(){
  if(!player)return;
  const g=player.gun;
  const lbl=document.getElementById('g-lbl');if(lbl){lbl.textContent=g.name;lbl.style.color=g.col;}
  const bd=document.getElementById('bpips');if(!bd)return;bd.innerHTML='';
  for(let i=0;i<Math.min(g.ammo,30);i++){
    const d=document.createElement('div');d.className='bpip';
    d.style.cssText=`background:${i<player.ammo?g.col:'rgba(255,255,255,.1)'};height:${g.id==='sniper'?'12':'8'}px`;
    bd.appendChild(d);
  }
  const rl=document.getElementById('reload-lbl');if(rl)rl.style.display=player.reloading?'block':'none';
}
function upPow(){
  if(!player)return;
  const el=document.getElementById('pow-row');if(!el)return;el.innerHTML='';
  if(player.powSpd)el.insertAdjacentHTML('beforeend','<span title="Speed boost">‚ö°</span>');
  if(player.powDmg)el.insertAdjacentHTML('beforeend','<span title="Damage amp">üî•</span>');
}
function upCoinHud(){
  const el=document.getElementById('coin-hud-val');if(el)el.textContent=coins;
  const mel=document.getElementById('menu-coins');if(mel)mel.textContent=coins;
}
function showCoinPop(x,y){
  const cp=document.getElementById('coin-pop');if(!cp)return;
  // Convert game coords to screen coords
  const sx=x*scl+ox,sy=y*scl+oy;
  cp.style.left=sx+'px';cp.style.top=(sy-30)+'px';
  cp.textContent='+10 ü™ô';cp.style.display='none';
  void cp.offsetWidth;cp.style.display='block';
  cp.style.animation='none';void cp.offsetWidth;cp.style.animation='coinpop .8s ease forwards';
}
let stTO;
function showStreak(txt){
  clearTimeout(stTO);
  const el=document.getElementById('streak');const t=document.getElementById('streak-txt');
  if(!el||!t)return;
  t.textContent=txt;el.classList.remove('show');void el.offsetWidth;el.classList.add('show');
  stTO=setTimeout(()=>el.classList.remove('show'),2100);
}
function showRespawn(n){const el=document.getElementById('respawn');if(el)el.classList.add('show');const c=document.getElementById('rs-n');if(c)c.textContent=Math.max(0,n);}
function hideRespawn(){const el=document.getElementById('respawn');if(el)el.classList.remove('show');}
function shakeIt(m){shakeMag=Math.max(shakeMag,m);}
function addFeed(k,v,team){
  feedList.unshift({k,v,team,life:4.5});if(feedList.length>5)feedList.pop();
  const el=document.getElementById('feed');if(!el)return;
  el.innerHTML=feedList.map(f=>`<div class="fi ${f.team==='red'?'r':f.team==='blue'?'b':'y'}"><span style="color:#e8e8f8">${f.k.slice(0,9)}</span> ‚öî <span style="color:#484870">${f.v.slice(0,9)}</span></div>`).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MAIN LOOP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function loop(ts){
  if(!running||paused)return;
  const dt=Math.min((ts-lastT)/1000,.065);lastT=ts;
  // Shake
  if(shakeMag>.1){shakeX=(Math.random()-.5)*shakeMag*2;shakeY=(Math.random()-.5)*shakeMag*2;shakeMag*=.78;}
  else{shakeX=0;shakeY=0;shakeMag=0;}
  // Powerup spawn
  pup_t+=dt;if(pup_t>9){pup_t=0;if(pups.filter(p=>!p.dead).length<4)spawnPup();}
  pups=pups.filter(p=>!p.dead);
  // KOTH
  if(mode.id==='koth'){
    for(const e of ents){
      if(e.dead)continue;
      if(Math.hypot(e.x-AW/2,e.y-AH/2)<85)kothT[e.team]=(kothT[e.team]||0)+dt;
    }
    upScore();if(!gameOver)checkWin();
  }
  // CTF
  if(mode.id==='ctf'){
    for(const team of ['red','blue']){
      const f=flags[team];if(!f)continue;
      const enemy=team==='red'?'blue':'red';
      if(f.dropped){f.dropT-=dt;if(f.dropT<=0){f.dropped=false;}}
      for(const e of ents){
        if(e.dead)continue;
        const fx=f.carrier?f.carrier.x:(f.dropped?f.dropX:f.homeX);
        const fy=f.carrier?f.carrier.y:(f.dropped?f.dropY:f.homeY);
        if(!f.carrier&&e.team===enemy&&Math.hypot(e.x-fx,e.y-fy)<24){
          f.carrier=e;burst(e.x,e.y,team==='red'?'#FF3131':'#1E90FF',10);
        }
        if(f.carrier===e){
          const own=flags[e.team];
          if(own&&!own.carrier&&!own.dropped&&Math.hypot(e.x-own.homeX,e.y-own.homeY)<40){
            ctfC[e.team]++;f.carrier=null;f.dropped=false;
            burst(e.x,e.y,'#FFE600',20,true);addFeed(e.name,'FLAG',e.team);
            upScore();if(!gameOver)checkWin();
          }
        }
      }
      if(f.carrier&&f.carrier.dead){f.dropped=true;f.dropX=f.carrier.x;f.dropY=f.carrier.y;f.dropT=8;f.carrier=null;}
    }
  }
  // Update all entities
  for(const e of ents)e.update(dt);
  // Entity-entity collision (push apart)
  for(let i=0;i<ents.length;i++){
    for(let j=i+1;j<ents.length;j++){
      const a=ents[i],b=ents[j];if(a.dead||b.dead)continue;
      const dx=b.x-a.x,dy=b.y-a.y,d=Math.hypot(dx,dy),mn=RAD*2+1;
      if(d<mn&&d>0){const p=(mn-d)/2;a.x-=dx/d*p;a.y-=dy/d*p;b.x+=dx/d*p;b.y+=dy/d*p;}
    }
  }
  // Bullets
  bullets=bullets.filter(b=>{if(b.dead)return false;b.update(dt);return!b.dead;});
  // Particles
  particles=particles.filter(p=>p.life>0);for(const p of particles)p.update(dt);
  // Feed decay
  feedList=feedList.filter(f=>{f.life-=dt;return f.life>0;});
  if(player&&!player.dead)upPow();
  render();
  requestAnimationFrame(loop);
}

function render(){
  scl=Math.min(cvs.width/AW,cvs.height/AH);
  ox=(cvs.width-AW*scl)/2;oy=(cvs.height-AH*scl)/2;
  ctx.clearRect(0,0,cvs.width,cvs.height);
  ctx.fillStyle='#000';ctx.fillRect(0,0,cvs.width,cvs.height);
  ctx.save();ctx.translate(ox+shakeX,oy+shakeY);ctx.scale(scl,scl);
  drawMap();
  pups.forEach(p=>p.draw());
  particles.forEach(p=>p.draw());
  bullets.forEach(b=>b.draw());
  ents.forEach(e=>e.draw());
  // CTF flags
  if(mode.id==='ctf'){
    for(const [team,f] of Object.entries(flags)){
      if(!f)continue;
      const col=team==='red'?'#FF3131':'#1E90FF';
      let fx,fy;
      if(f.carrier){fx=f.carrier.x;fy=f.carrier.y-28;}
      else if(f.dropped){fx=f.dropX;fy=f.dropY;}
      else{fx=f.homeX;fy=f.homeY;}
      ctx.save();ctx.translate(fx,fy);
      ctx.shadowColor=col;ctx.shadowBlur=14;
      ctx.font='20px sans-serif';ctx.textAlign='center';ctx.textBaseline='middle';
      ctx.fillText(team==='red'?'üö©':'üè≥',0,0);ctx.restore();
      ctx.beginPath();ctx.arc(f.homeX,f.homeY,36,0,Math.PI*2);
      ctx.strokeStyle=col+'55';ctx.lineWidth=2;ctx.setLineDash([6,6]);ctx.stroke();ctx.setLineDash([]);
    }
  }
  ctx.restore();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  START GAME
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startGame(){
  const playerName=(document.getElementById('name-in').value.trim().toUpperCase()||'PLAYER').slice(0,12);
  showScreen('s-game');
  map={theme:THEMES[Math.floor(Math.random()*THEMES.length)],obs:mkObs()};
  const modeTag=document.getElementById('mode-tag');
  if(modeTag)modeTag.textContent={tdm:'‚öîÔ∏è TDM',ffa:'üíÄ FFA',koth:'üëë KOTH',ctf:'üö© CTF',gun:'üî´ GUN GAME','1v1':'ü•ä 1VS1'}[mode.id];
  const kb=document.getElementById('koth-bar');if(kb)kb.style.display=mode.id==='koth'?'block':'none';
  document.getElementById('map-lbl').textContent=map.theme.name;
  // RESET STATE ‚Äî must happen before creating entities
  ents=[];bullets=[];particles=[];pups=[];feedList=[];
  kills={red:0,blue:0};kothT={red:0,blue:0};ctfC={red:0,blue:0};
  ffaK={};flags={};gameOver=false;paused=false;shakeMag=0;pup_t=0;roundCoins=0;
  document.getElementById('feed').innerHTML='';hideRespawn();
  // Player ‚Äî use equipped weapon & skin
  const px=myTeam==='red'?100:AW-100,py=AH/2+(Math.random()-.5)*200;
  player=new Entity(px,py,myTeam,playerName,true,equippedSkin,mode.id==='gun'?'pistol':equippedWeapon);
  ffaK[playerName]=0;
  ents.push(player); // player is always index 0
  // Bots ‚Äî spawn AFTER clearing ents
  const botCount=mode.id==='1v1'?1:8;
  for(let i=0;i<botCount;i++){
    let t;
    if(mode.id==='1v1'){t=myTeam==='red'?'blue':'red';}
    else if(mode.teams){t=i<botCount/2?myTeam:(myTeam==='red'?'blue':'red');}
    else{t=i%2===0?'red':'blue';}
    const nm=mode.id==='1v1'?(t==='red'?BOT_NAMES_R:BOT_NAMES_B)[0]:
             mode.teams?(t==='red'?BOT_NAMES_R:BOT_NAMES_B)[i%4]:BOT_NAMES_F[i%BOT_NAMES_F.length];
    const sk=ALL_SKINS[Math.floor(Math.random()*ALL_SKINS.length)].id;
    // Bots use random weapons from their "pool" (all weapons)
    const botGun=mode.id==='gun'?'pistol':ALL_WEAPONS[Math.floor(Math.random()*ALL_WEAPONS.length)].id;
    const bx=t==='red'?80+Math.random()*120:AW-80-Math.random()*120;
    const by=80+Math.random()*(AH-160);
    const bot=new Entity(bx,by,t,nm,false,sk,botGun);
    bot.aggro=.4+Math.random()*.6;
    ffaK[nm]=0;
    ents.push(bot);
  }
  // CTF flags
  if(mode.id==='ctf'){
    flags={
      red:{homeX:120,homeY:AH/2,carrier:null,dropped:false,dropX:0,dropY:0,dropT:0},
      blue:{homeX:AW-120,homeY:AH/2,carrier:null,dropped:false,dropX:0,dropY:0,dropT:0}
    };
  }
  // Powerups
  for(let i=0;i<3;i++)spawnPup();
  upScore();upStats();upHp();upAmmo();upPow();upCoinHud();
  running=true;lastT=performance.now();
  requestAnimationFrame(loop);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PAUSE / EXIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function togglePause(){
  if(gameOver)return;
  paused=!paused;
  if(paused){showScreen('s-pause');}
  else{showScreen('s-game');running=true;lastT=performance.now();requestAnimationFrame(loop);}
}
function exitToMenu(){paused=false;running=false;gameOver=true;goMenu();}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MENU SCREENS / TABS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showScreen(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}
function goMenu(){
  running=false;paused=false;
  upCoinHud();
  buildInventory();buildShop();
  showScreen('s-menu');
}
function switchTab(id){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('on'));
  document.querySelectorAll('.tab-panel').forEach(t=>t.classList.remove('on'));
  document.getElementById('tab-'+id).classList.add('on');
  const tabs=document.querySelectorAll('.tab');
  const idx=['play','inventory','shop'].indexOf(id);
  if(tabs[idx])tabs[idx].classList.add('on');
  if(id==='inventory')buildInventory();
  if(id==='shop')buildShop();
}
function switchInvTab(id){
  document.querySelectorAll('.inv-tab').forEach(t=>t.classList.remove('on'));
  document.querySelectorAll('.inv-panel').forEach(t=>t.classList.remove('on'));
  document.getElementById('inv-'+id).classList.add('on');
  document.querySelectorAll('.inv-tab').forEach(t=>{if(t.dataset.id===id)t.classList.add('on');});
}
function switchShopTab(id){
  document.querySelectorAll('.shop-tab').forEach(t=>t.classList.remove('on'));
  document.querySelectorAll('.shop-panel').forEach(t=>t.classList.remove('on'));
  document.getElementById('shop-'+id).classList.add('on');
  document.querySelectorAll('.shop-tab').forEach(t=>{if(t.dataset.id===id)t.classList.add('on');});
}
function pickTeam(t){
  myTeam=t;
  document.getElementById('tbr').classList.toggle('on',t==='red');
  document.getElementById('tbb').classList.toggle('on',t==='blue');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INVENTORY BUILD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildInventory(){
  // Weapons panel
  const wp=document.getElementById('inv-weapons');wp.innerHTML='';
  const myWeapons=ALL_WEAPONS.filter(w=>ownedWeapons.includes(w.id));
  if(myWeapons.length===0){wp.innerHTML='<div class="inv-empty">No weapons owned.<br><br>Visit the shop!</div>';}
  myWeapons.forEach(w=>{
    const eq=equippedWeapon===w.id;
    const d=document.createElement('div');d.className='inv-item'+(eq?' equipped':'');
    d.innerHTML=`<span class="inv-icon">${w.icon}</span><span class="inv-name">${w.name}</span><span class="inv-stat">DMG ${w.dmg} ¬∑ AMM ${w.ammo}<br>RATE ${Math.round(1/w.rate)}/s</span>${eq?'':'<button class="equip-btn" onclick="equipWeapon(\''+w.id+'\')">EQUIP</button>'}`;
    wp.appendChild(d);
  });
  // Skins panel
  const sp=document.getElementById('inv-skins');sp.innerHTML='';
  const mySkins=ALL_SKINS.filter(s=>ownedSkins.includes(s.id));
  mySkins.forEach(s=>{
    const eq=equippedSkin===s.id;
    const d=document.createElement('div');d.className='inv-item'+(eq?' equipped':'');
    d.innerHTML=`<span class="inv-icon">${s.icon}</span><span class="inv-name">${s.name}</span><span class="inv-stat" style="color:${s.col}">${s.col}</span>${eq?'':'<button class="equip-btn" onclick="equipSkin(\''+s.id+'\')">EQUIP</button>'}`;
    sp.appendChild(d);
  });
}
function equipWeapon(id){equippedWeapon=id;saveAll();buildInventory();}
function equipSkin(id){equippedSkin=id;saveAll();buildInventory();}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SHOP BUILD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildShop(){
  upCoinHud();
  // Weapons
  const wPanel=document.getElementById('shop-weapons');wPanel.innerHTML='';
  ALL_WEAPONS.forEach(w=>{
    const owned=ownedWeapons.includes(w.id);
    const d=document.createElement('div');d.className='shop-item'+(owned?' owned':'');
    const badge=w.badge?`<div class="shop-badge badge-${w.badge.toLowerCase()}">${w.badge}</div>`:'';
    const btn=owned?'':`<button class="buy-btn" onclick="buyWeapon('${w.id}')" ${coins<w.price?'disabled':''}>BUY ‚Äî ü™ô${w.price}</button>`;
    d.innerHTML=`${badge}<span class="shop-icon">${w.icon}</span><span class="shop-name">${w.name}</span><span class="shop-desc">${w.desc}</span><div class="shop-price"><span class="shop-price-val">${w.price===0?'FREE':'ü™ô '+w.price}</span></div>${btn}`;
    wPanel.appendChild(d);
  });
  // Skins
  const sPanel=document.getElementById('shop-skins');sPanel.innerHTML='';
  ALL_SKINS.forEach(s=>{
    const owned=ownedSkins.includes(s.id);
    const d=document.createElement('div');d.className='shop-item'+(owned?' owned':'');
    const badge=s.badge?`<div class="shop-badge badge-${s.badge.toLowerCase()}">${s.badge}</div>`:'';
    const btn=owned?'':`<button class="buy-btn" onclick="buySkin('${s.id}')" ${coins<s.price?'disabled':''}>BUY ‚Äî ü™ô${s.price}</button>`;
    d.innerHTML=`${badge}<span class="shop-icon">${s.icon}</span><span class="shop-name">${s.name}</span><span class="shop-desc" style="color:${s.col}">SKIN COLOR</span><div class="shop-price"><span class="shop-price-val">${s.price===0?'FREE':'ü™ô '+s.price}</span></div>${btn}`;
    sPanel.appendChild(d);
  });
  // Bundles
  const bPanel=document.getElementById('shop-bundles');bPanel.innerHTML='';
  BUNDLES.forEach(bundle=>{
    const allOwned=bundle.weapons.every(w=>ownedWeapons.includes(w))&&bundle.skins.every(s=>ownedSkins.includes(s));
    const d=document.createElement('div');d.className='shop-item'+(allOwned?' owned':'');
    const badge=bundle.badge?`<div class="shop-badge badge-${bundle.badge.toLowerCase()}">${bundle.badge}</div>`:'<div class="shop-badge badge-bundle">BUNDLE</div>';
    const btn=allOwned?'':`<button class="buy-btn" onclick="buyBundle('${bundle.id}')" ${coins<bundle.price?'disabled':''}>BUY BUNDLE ‚Äî ü™ô${bundle.price}</button>`;
    d.innerHTML=`${badge}<span class="shop-icon">${bundle.icon}</span><span class="shop-name">${bundle.name}</span><span class="shop-desc">${bundle.desc}</span><div class="shop-price"><span class="shop-price-val">ü™ô ${bundle.price}</span></div>${btn}`;
    bPanel.appendChild(d);
  });
}
function buyWeapon(id){
  const w=ALL_WEAPONS.find(x=>x.id===id);if(!w||ownedWeapons.includes(id))return;
  if(coins<w.price){alert('Not enough coins! Earn more by playing matches (10 per kill).');return;}
  coins-=w.price;ownedWeapons.push(id);saveAll();buildShop();buildInventory();upCoinHud();
}
function buySkin(id){
  const s=ALL_SKINS.find(x=>x.id===id);if(!s||ownedSkins.includes(id))return;
  if(coins<s.price){alert('Not enough coins! Earn more by playing (10 per kill).');return;}
  coins-=s.price;ownedSkins.push(id);saveAll();buildShop();buildInventory();upCoinHud();
}
function buyBundle(id){
  const b=BUNDLES.find(x=>x.id===id);if(!b)return;
  if(coins<b.price){alert('Not enough coins!');return;}
  coins-=b.price;
  b.weapons.forEach(w=>{if(!ownedWeapons.includes(w))ownedWeapons.push(w);});
  b.skins.forEach(s=>{if(!ownedSkins.includes(s))ownedSkins.push(s);});
  saveAll();buildShop();buildInventory();upCoinHud();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MENU BUILD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildMenu(){
  // Modes
  const mg=document.getElementById('mode-grid');mg.innerHTML='';
  MODES.forEach((m,i)=>{
    const d=document.createElement('div');d.className='mbt'+(i===0?' on':'');
    d.innerHTML=`<i>${m.icon}</i><s>${m.name}</s><d>${m.desc}</d>`;
    d.onclick=()=>{mode=m;document.querySelectorAll('.mbt').forEach(b=>b.classList.remove('on'));d.classList.add('on');};
    mg.appendChild(d);
  });
  mode=MODES[0];
  // RPG button
  if(rpgUnlocked)document.getElementById('rpg-btn').style.display='block';
  upCoinHud();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SECRET CODE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function checkSecret(ch){
  _secretBuf+=ch.toLowerCase();_secretBuf=_secretBuf.slice(-8);
  if(_secretBuf.endsWith('ven1234')){
    rpgUnlocked=true;saveAll();_secretBuf='';
    document.getElementById('rpg-btn').style.display='block';
    const toast=document.getElementById('secret-toast');
    toast.style.display='block';setTimeout(()=>toast.style.display='none',3500);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INPUT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.addEventListener('keydown',e=>{
  const k=e.key.toLowerCase();
  // Secret code (on menu)
  if(document.getElementById('s-menu').classList.contains('active')&&e.key.length===1){
    checkSecret(e.key);
  }
  // Pause toggle
  if((k==='q'||e.key==='Escape')){
    if(document.getElementById('s-game').classList.contains('active')){e.preventDefault();togglePause();return;}
    if(document.getElementById('s-pause').classList.contains('active')){e.preventDefault();togglePause();return;}
  }
  if(paused)return;
  keys[k]=true;
  if(!player||player.dead||!running)return;
  if(e.key===' '){e.preventDefault();player.shoot(player.angle);}
  if(k==='f')player.startAtk();
  if(k==='r'&&!player.reloading&&player.ammo<player.gun.ammo){player.reloading=true;player.reloadT=player.gun.reload;}
});
window.addEventListener('keyup',e=>keys[e.key.toLowerCase()]=false);
window.addEventListener('mousemove',e=>{mouse.x=e.clientX;mouse.y=e.clientY;});
window.addEventListener('load',()=>{
  cvs=document.getElementById('gc');ctx=cvs.getContext('2d');
  const resize=()=>{cvs.width=window.innerWidth;cvs.height=window.innerHeight;};
  resize();window.addEventListener('resize',resize);
  cvs.addEventListener('mousedown',e=>{
    mdown=true;
    if(!player||player.dead||!running||paused)return;
    if(e.button===0)player.shoot(player.angle);
    if(e.button===2){e.preventDefault();player.startAtk();}
  });
  cvs.addEventListener('mouseup',()=>mdown=false);
  cvs.addEventListener('contextmenu',e=>e.preventDefault());
  buildMenu();buildShop();buildInventory();
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RPG MODE (stub ‚Äî full version via secret code)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startRPG(){
  if(!rpgUnlocked)return;
  // Quick RPG - wave survival using the same canvas
  alert('üîÆ RPG REALM: Coming in Season 2!\n\nYou unlocked early access ‚Äî check back soon!\n\nFor now, the code grants you: unlimited respect üòé');
}
</script>
</body>
</html>
