<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>RIVALS</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Barlow+Condensed:wght@700;800&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--y:#FFE600;--r:#FF3131;--b:#1E90FF;--c:#00F5FF;--g:#00E5A0;--bg:#050508;--card:#0d0d1a;--bdr:#1e1e35}
html,body{width:100%;height:100%;overflow:hidden;background:var(--bg);font-family:'Barlow Condensed',sans-serif;color:#f0f0ff}
.screen{position:fixed;inset:0;display:none;overflow-y:auto}
.screen.active{display:block}

/* ‚îÄ‚îÄ MENU ‚îÄ‚îÄ */
#menu{background:var(--bg);min-height:100%;padding:2rem 1rem;
  background-image:linear-gradient(rgba(255,230,0,.03) 1px,transparent 1px),linear-gradient(90deg,rgba(255,230,0,.03) 1px,transparent 1px);
  background-size:50px 50px}
.wrap{max-width:780px;margin:0 auto}
h1{font-family:'Press Start 2P',monospace;font-size:clamp(2.2rem,8vw,4.5rem);color:var(--y);text-align:center;text-shadow:0 0 40px rgba(255,230,0,.8);margin-bottom:.3rem}
.sub{font-family:'Press Start 2P',monospace;font-size:.4rem;color:#5a5a90;text-align:center;letter-spacing:.15em;margin-bottom:2rem}
.row{display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1rem}
@media(max-width:600px){.row{grid-template-columns:1fr}}
.lbl{font-family:'Press Start 2P',monospace;font-size:.35rem;color:#5a5a90;letter-spacing:.15em;display:block;margin-bottom:.5rem}
.card{background:var(--card);border:2px solid var(--bdr);padding:.8rem}
#name-in,#code-in{width:100%;background:transparent;border:none;border-bottom:2px solid var(--bdr);color:#f0f0ff;font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:1.3rem;padding:.4rem 0;outline:none;letter-spacing:.05em;transition:border-color .2s}
#name-in:focus,#code-in:focus{border-color:var(--y)}
#name-in::placeholder,#code-in::placeholder{color:#3a3a60}
#room-box{background:var(--card);border:2px solid var(--bdr);padding:.8rem;margin-bottom:1rem}
.room-row{display:grid;grid-template-columns:1fr 1fr;gap:.6rem;margin-top:.6rem}
@media(max-width:500px){.room-row{grid-template-columns:1fr}}
.room-btn{font-family:'Press Start 2P',monospace;font-size:.38rem;padding:.7rem;border:2px solid;background:transparent;cursor:pointer;transition:all .18s;letter-spacing:.06em}
.room-btn.make{border-color:var(--g);color:var(--g)}.room-btn.make:hover{background:var(--g);color:#000;box-shadow:0 0 18px rgba(0,229,160,.4)}
.room-btn.join{border-color:var(--b);color:var(--b)}.room-btn.join:hover{background:var(--b);color:#fff;box-shadow:0 0 18px rgba(30,144,255,.4)}
#room-status{font-family:'Press Start 2P',monospace;font-size:.32rem;margin-top:.6rem;min-height:1.4em;text-align:center;letter-spacing:.05em}
#room-code-display{font-family:'Press Start 2P',monospace;font-size:2rem;color:var(--y);text-shadow:0 0 20px rgba(255,230,0,.7);text-align:center;letter-spacing:.3em;margin:.5rem 0;display:none}
.team-row{display:grid;grid-template-columns:1fr 1fr;gap:.5rem}
.tbt{font-family:'Press Start 2P',monospace;font-size:.4rem;padding:.7rem;border:2px solid;background:transparent;cursor:pointer;transition:all .18s}
.tbt.red{border-color:var(--r);color:var(--r)}.tbt.red.on,.tbt.red:hover{background:var(--r);color:#fff;box-shadow:0 0 20px rgba(255,49,49,.4)}
.tbt.blue{border-color:var(--b);color:var(--b)}.tbt.blue.on,.tbt.blue:hover{background:var(--b);color:#fff;box-shadow:0 0 20px rgba(30,144,255,.4)}
.mode-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:.4rem;margin-bottom:1rem}
@media(max-width:600px){.mode-grid{grid-template-columns:repeat(3,1fr)}}
.mbt{border:2px solid var(--bdr);padding:.5rem .3rem;cursor:pointer;transition:all .18s;text-align:center;background:var(--card)}
.mbt:hover{border-color:rgba(255,230,0,.5)}.mbt.on{border-color:var(--y);background:rgba(255,230,0,.07)}
.mbt-icon{font-size:1.4rem;display:block;margin-bottom:.25rem}
.mbt-name{font-family:'Press Start 2P',monospace;font-size:.28rem;color:var(--y);display:block;margin-bottom:.2rem;line-height:1.5}
.mbt-desc{font-size:.78rem;color:#5a5a90;line-height:1.3}
.skin-row{display:grid;grid-template-columns:repeat(6,1fr);gap:.4rem;margin-bottom:1rem}
@media(max-width:500px){.skin-row{grid-template-columns:repeat(3,1fr)}}
.skt{border:2px solid var(--bdr);padding:.45rem .2rem;cursor:pointer;transition:all .18s;text-align:center;background:var(--card)}
.skt:hover{border-color:rgba(255,230,0,.5)}.skt.on{border-color:var(--y);background:rgba(255,230,0,.07)}
.skt-ico{font-size:1.1rem;display:block;margin-bottom:.2rem}
.skt-nm{font-family:'Press Start 2P',monospace;font-size:.25rem;color:#aaa}
#play-btn{display:block;width:100%;font-family:'Press Start 2P',monospace;font-size:.65rem;letter-spacing:.12em;background:var(--y);color:#000;border:none;cursor:pointer;padding:1.1rem;margin-bottom:1.5rem;transition:transform .15s,filter .15s}
#play-btn:hover{transform:translateY(-3px);filter:brightness(1.12)}
.hints{display:flex;gap:1.5rem;justify-content:center;flex-wrap:wrap}
.hint{font-family:'Press Start 2P',monospace;font-size:.3rem;color:#5a5a90;text-align:center;line-height:2.2}
kbd{background:#0d0d1a;border:1px solid var(--bdr);padding:.1rem .3rem;border-radius:2px;color:#888;font-family:inherit;font-size:.9em}
#connect-status{font-family:'Press Start 2P',monospace;font-size:.32rem;text-align:center;padding:.5rem;margin-bottom:.7rem;display:none}
#connect-status.ok{color:var(--g)}#connect-status.err{color:var(--r)}

/* ‚îÄ‚îÄ GAME ‚îÄ‚îÄ */
#game{padding:0;overflow:hidden}
#gc{position:fixed;inset:0;width:100%;height:100%;display:block;cursor:crosshair}
#hud{position:fixed;inset:0;pointer-events:none;z-index:10}
#scorebar{position:absolute;top:.8rem;left:50%;transform:translateX(-50%);display:flex;align-items:center;gap:.8rem;white-space:nowrap;background:rgba(5,5,8,.92);border:1px solid rgba(255,255,255,.06);padding:.5rem 1.3rem;backdrop-filter:blur(8px)}
.sc{font-family:'Press Start 2P',monospace;font-size:1.5rem;line-height:1;transition:all .3s}
.sc.r{color:var(--r);text-shadow:0 0 12px rgba(255,49,49,.7)}.sc.b{color:var(--b);text-shadow:0 0 12px rgba(30,144,255,.7)}.sc.f{color:var(--y)}
#mode-tag{font-family:'Press Start 2P',monospace;font-size:.3rem;color:rgba(255,255,255,.2);display:block;text-align:center;margin-bottom:.15rem}
.sep{font-family:'Press Start 2P',monospace;font-size:.34rem;color:#5a5a90;text-align:center;line-height:1.8}
#stats{position:absolute;top:.8rem;left:.8rem;font-family:'Press Start 2P',monospace;font-size:.3rem;color:#5a5a90;background:rgba(5,5,8,.88);border:1px solid rgba(255,255,255,.04);padding:.35rem .6rem;line-height:2.2;letter-spacing:.05em}
#stats span{color:var(--y)}
#coins-hud{position:absolute;top:.8rem;left:.8rem;margin-top:5.5rem;font-family:'Press Start 2P',monospace;font-size:.35rem;color:var(--y);background:rgba(5,5,8,.88);border:1px solid rgba(255,230,0,.15);padding:.3rem .6rem;letter-spacing:.05em}
#feed{position:absolute;top:.8rem;right:.8rem;display:flex;flex-direction:column;gap:.25rem;align-items:flex-end;max-width:240px}
.fi{font-family:'Press Start 2P',monospace;font-size:.28rem;padding:.2rem .45rem;background:rgba(5,5,8,.92);border-right:3px solid;white-space:nowrap;animation:fiin .25s ease}
.fi.r{border-color:var(--r)}.fi.b{border-color:var(--b)}.fi.f{border-color:var(--y)}
@keyframes fiin{from{opacity:0;transform:translateX(12px)}to{opacity:1;transform:none}}
#bot-hud{position:absolute;bottom:1rem;left:50%;transform:translateX(-50%);display:flex;flex-direction:column;align-items:center;gap:.3rem}
#hp-bar{display:flex;align-items:center;gap:.3rem;background:rgba(5,5,8,.88);border:1px solid rgba(255,255,255,.04);padding:.35rem .8rem}
.hl{font-family:'Press Start 2P',monospace;font-size:.3rem;color:#5a5a90;margin-right:.2rem}
.hrt{font-size:1rem;transition:all .2s}.hrt.empty{opacity:.13;transform:scale(.75)}
#ammo-bar{display:flex;align-items:center;gap:.5rem;background:rgba(5,5,8,.88);border:1px solid rgba(255,255,255,.04);padding:.3rem .8rem}
#gun-lbl{font-family:'Press Start 2P',monospace;font-size:.3rem}
#bullets{display:flex;gap:2px;flex-wrap:wrap;max-width:140px}
.bl{width:4px;height:8px;border-radius:1px;transition:opacity .1s}
#reload-txt{font-family:'Press Start 2P',monospace;font-size:.3rem;color:var(--y);animation:rp .9s ease-in-out infinite;display:none}
@keyframes rp{0%,100%{opacity:1}50%{opacity:.3}}
#pow-hud{display:flex;gap:.3rem;background:rgba(5,5,8,.88);border:1px solid rgba(255,255,255,.04);padding:.25rem .7rem;min-height:28px;align-items:center;font-size:.85rem}
#respawn-screen{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;display:none}
#respawn-screen.show{display:block}
#rs-label{font-family:'Press Start 2P',monospace;font-size:.5rem;color:var(--r);letter-spacing:.18em;margin-bottom:.6rem}
#rs-count{font-family:'Press Start 2P',monospace;font-size:3rem;color:var(--y);text-shadow:0 0 35px rgba(255,230,0,.9);animation:pulse .9s ease-in-out infinite}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.08)}}
#streak-pop{position:absolute;top:34%;left:50%;transform:translateX(-50%);pointer-events:none;display:none;text-align:center}
#streak-pop.show{display:block}
#streak-txt{font-family:'Press Start 2P',monospace;font-size:clamp(.7rem,2.2vw,1.1rem);color:var(--y);text-shadow:0 0 35px rgba(255,230,0,.9);animation:pop .45s ease}
@keyframes pop{from{opacity:0;transform:scale(.4)}to{opacity:1;transform:scale(1)}}
#map-lbl{position:absolute;bottom:1rem;right:.8rem;font-family:'Press Start 2P',monospace;font-size:.28rem;color:rgba(255,255,255,.14)}
#flash{position:fixed;inset:0;pointer-events:none;z-index:5;opacity:0;transition:opacity .12s}

/* ‚îÄ‚îÄ SHOP OVERLAY ‚îÄ‚îÄ */
#shop-overlay{position:fixed;inset:0;background:rgba(5,5,8,.95);backdrop-filter:blur(14px);z-index:50;display:none;flex-direction:column;align-items:center;justify-content:center;pointer-events:all}
#shop-overlay.open{display:flex}
#shop-title{font-family:'Press Start 2P',monospace;font-size:clamp(.8rem,2.5vw,1.5rem);color:var(--y);text-shadow:0 0 30px rgba(255,230,0,.7);margin-bottom:.4rem}
#shop-coins-disp{font-family:'Press Start 2P',monospace;font-size:.45rem;color:var(--g);margin-bottom:1.5rem;letter-spacing:.1em}
.shop-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:1rem;max-width:700px;width:100%;padding:0 1rem}
@media(max-width:560px){.shop-grid{grid-template-columns:1fr 1fr}}
.shop-card{background:var(--card);border:2px solid var(--bdr);padding:1rem .6rem;text-align:center;cursor:pointer;transition:all .2s;position:relative}
.shop-card:hover{border-color:rgba(255,230,0,.5);transform:translateY(-3px)}
.shop-card.owned{border-color:var(--g)}
.shop-card.active-gun{border-color:var(--g);background:rgba(0,229,160,.06)}
.shop-gun-name{font-family:'Press Start 2P',monospace;font-size:.35rem;display:block;margin-bottom:.4rem}
.shop-price{font-family:'Press Start 2P',monospace;font-size:.3rem;color:var(--y);display:block;margin-bottom:.6rem}
.shop-stat{font-size:.85rem;color:#5a5a90;margin-bottom:.15rem;line-height:1.4}
.shop-buy-btn{font-family:'Press Start 2P',monospace;font-size:.28rem;background:var(--y);color:#000;border:none;cursor:pointer;padding:.4rem .8rem;margin-top:.4rem;transition:all .15s;width:100%}
.shop-buy-btn:hover{filter:brightness(1.15)}
.shop-buy-btn:disabled{background:var(--bdr);color:#555;cursor:not-allowed}
#shop-msg{font-family:'Press Start 2P',monospace;font-size:.35rem;margin-top:1rem;min-height:1.5em;text-align:center}
#shop-close{font-family:'Press Start 2P',monospace;font-size:.4rem;background:transparent;border:2px solid var(--bdr);color:#5a5a90;padding:.6rem 1.5rem;cursor:pointer;margin-top:1rem;transition:all .15s}
#shop-close:hover{border-color:var(--y);color:var(--y)}
#shop-pistol-note{font-family:'Press Start 2P',monospace;font-size:.28rem;color:#5a5a90;margin-bottom:1rem;text-align:center;letter-spacing:.08em}

/* ‚îÄ‚îÄ END SCREEN ‚îÄ‚îÄ */
#end{background:rgba(5,5,8,.97);backdrop-filter:blur(18px);flex-direction:column;align-items:center;justify-content:center;min-height:100%;padding:2rem;overflow-y:auto}
#end.active{display:flex}
#end-title{font-family:'Press Start 2P',monospace;font-size:clamp(.9rem,3vw,2rem);margin-bottom:.4rem;text-align:center}
#end-title.r{color:var(--r);text-shadow:0 0 40px rgba(255,49,49,.8)}
#end-title.b{color:var(--b);text-shadow:0 0 40px rgba(30,144,255,.8)}
#end-title.y{color:var(--y);text-shadow:0 0 40px rgba(255,230,0,.8)}
#end-sub{font-family:'Press Start 2P',monospace;font-size:.38rem;color:#5a5a90;letter-spacing:.15em;margin-bottom:1.5rem;text-align:center}
table{border-collapse:collapse;width:100%;max-width:700px;margin-bottom:1.5rem}
th{font-family:'Press Start 2P',monospace;font-size:.28rem;color:#5a5a90;padding:.45rem .6rem;text-align:left;border-bottom:2px solid var(--y)}
td{padding:.55rem .6rem;font-size:.92rem;font-weight:700;border-bottom:1px solid var(--bdr)}
tr.me td{background:rgba(255,230,0,.06)}
tr.me td:first-child{border-left:3px solid var(--y)}
.tk{color:#FF0080}.tkd{color:var(--c)}.ts{color:var(--y)}.co{color:var(--g)}
.tr2{color:var(--r)}.tb2{color:var(--b)}
#again-btn{font-family:'Press Start 2P',monospace;font-size:.5rem;letter-spacing:.08em;background:var(--y);color:#000;border:none;cursor:pointer;padding:.85rem 2.5rem;transition:transform .15s,filter .15s}
#again-btn:hover{transform:translateY(-3px);filter:brightness(1.1)}
#mp-badge{font-family:'Press Start 2P',monospace;font-size:.3rem;color:var(--g);border:1px solid rgba(0,229,160,.3);padding:.2rem .5rem;margin-bottom:1rem;display:inline-block}

/* ‚îÄ‚îÄ MENU TABS ‚îÄ‚îÄ */
#menu-tabs{display:grid;grid-template-columns:repeat(4,1fr);gap:0;margin-bottom:1.5rem;border:2px solid var(--bdr);overflow:hidden}
.mtab{font-family:'Press Start 2P',monospace;font-size:.32rem;padding:.75rem .3rem;background:var(--card);border:none;color:#5a5a90;cursor:pointer;transition:all .2s;display:flex;flex-direction:column;align-items:center;gap:.35rem;letter-spacing:.06em;border-right:1px solid var(--bdr)}
.mtab:last-child{border-right:none}
.mtab .ticon{font-size:1.3rem;display:block}
.mtab:hover{color:#aaa;background:rgba(255,255,255,.03)}
.mtab.on{background:rgba(255,230,0,.07);color:var(--y);border-bottom:3px solid var(--y);position:relative}
.mtab.on::after{content:'';position:absolute;bottom:-2px;left:0;right:0;height:3px;background:var(--y)}
.tab-panel{display:none}
.tab-panel.on{display:block;animation:tpfade .25s ease}
@keyframes tpfade{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

/* ‚îÄ‚îÄ INVENTORY (pre-game skin + loadout) ‚îÄ‚îÄ */
.inv-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:.7rem;margin-bottom:1rem}
@media(max-width:500px){.inv-grid{grid-template-columns:1fr 1fr}}
.inv-card{background:var(--card);border:2px solid var(--bdr);padding:.9rem .5rem;text-align:center;cursor:pointer;transition:all .2s;position:relative}
.inv-card:hover{border-color:rgba(255,230,0,.4);transform:translateY(-2px)}
.inv-card.on{border-color:var(--y);background:rgba(255,230,0,.07)}
.inv-card .ic-icon{font-size:2rem;display:block;margin-bottom:.4rem}
.inv-card .ic-name{font-family:'Press Start 2P',monospace;font-size:.28rem;color:#aaa;display:block}
.inv-card .ic-check{position:absolute;top:6px;right:8px;font-size:.7rem;color:var(--y);display:none}
.inv-card.on .ic-check{display:block}

/* ‚îÄ‚îÄ SHOP (pre-game gun purchase preview) ‚îÄ‚îÄ */
.pre-shop-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:.7rem;margin-bottom:1rem}
@media(max-width:500px){.pre-shop-grid{grid-template-columns:1fr}}
.psg-card{background:var(--card);border:2px solid var(--bdr);padding:.9rem .7rem;transition:all .2s}
.psg-card .pg-name{font-family:'Press Start 2P',monospace;font-size:.35rem;display:block;margin-bottom:.3rem}
.psg-card .pg-stat{font-size:.85rem;color:#5a5a90;margin-bottom:.15rem}
.psg-card .pg-note{font-family:'Press Start 2P',monospace;font-size:.25rem;color:rgba(255,230,0,.5);margin-top:.4rem;display:block}

/* ‚îÄ‚îÄ CODE TAB ‚îÄ‚îÄ */
.code-section{margin-bottom:1rem}
.code-section .lbl{margin-bottom:.6rem}
.big-code-display{font-family:'Press Start 2P',monospace;font-size:2.5rem;color:var(--y);text-shadow:0 0 25px rgba(255,230,0,.7);text-align:center;letter-spacing:.35em;padding:1rem;background:rgba(255,230,0,.04);border:2px solid rgba(255,230,0,.15);margin-bottom:.6rem;display:none}
.code-btns{display:grid;grid-template-columns:1fr 1fr;gap:.6rem}
@media(max-width:500px){.code-btns{grid-template-columns:1fr}}
</style>
</head>
<body>
<div id="flash"></div>

<!-- ‚îÄ‚îÄ MENU ‚îÄ‚îÄ -->
<div id="menu" class="screen active">
<div class="wrap">
  <h1>RIVALS</h1>
  <p class="sub">START WITH A PISTOL ¬∑ EARN COINS ¬∑ DOMINATE</p>

  <!-- TOP: name + team always visible -->
  <div class="row" style="margin-bottom:1rem">
    <div class="card">
      <span class="lbl">YOUR NAME</span>
      <input id="name-in" type="text" placeholder="ENTER NAME" maxlength="12" autocomplete="off" spellcheck="false"/>
    </div>
    <div class="card">
      <span class="lbl">TEAM</span>
      <div class="team-row">
        <button class="tbt red on" id="tbr" onclick="pickTeam('red')">üî¥ RED</button>
        <button class="tbt blue" id="tbb" onclick="pickTeam('blue')">üîµ BLUE</button>
      </div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ 4 TABS ‚îÄ‚îÄ -->
  <div id="menu-tabs">
    <button class="mtab on" onclick="switchTab('play',this)"><span class="ticon">‚öîÔ∏è</span>PLAY</button>
    <button class="mtab" onclick="switchTab('inventory',this)"><span class="ticon">üéí</span>INVENTORY</button>
    <button class="mtab" onclick="switchTab('shop',this)"><span class="ticon">üõí</span>SHOP</button>
    <button class="mtab" onclick="switchTab('code',this)"><span class="ticon">üîó</span>CODE</button>
  </div>

  <!-- ‚ïê‚ïê TAB: PLAY ‚ïê‚ïê -->
  <div id="tab-play" class="tab-panel on">
    <span class="lbl">GAME MODE</span>
    <div class="mode-grid" id="mode-grid" style="margin-bottom:1.2rem"></div>
    <button id="play-btn" onclick="startGame(false)" style="margin-bottom:.6rem">‚ö° PLAY SOLO vs BOTS</button>
    <div style="background:rgba(0,229,160,.06);border:1px solid rgba(0,229,160,.15);padding:.6rem .8rem;margin-bottom:1.2rem;font-family:'Press Start 2P',monospace;font-size:.28rem;color:var(--g);line-height:2.2">
      üî´ START WITH PISTOL &nbsp;¬∑&nbsp; üí∞ 50 COINS PER KILL &nbsp;¬∑&nbsp; üõí [B] OPENS SHOP IN-GAME
    </div>
    <div class="hints">
      <div class="hint"><kbd>WASD</kbd><br>MOVE</div>
      <div class="hint">MOUSE<br>AIM</div>
      <div class="hint"><kbd>CLICK</kbd><br>SHOOT</div>
      <div class="hint"><kbd>F</kbd><br>SWORD</div>
      <div class="hint"><kbd>R</kbd><br>RELOAD</div>
      <div class="hint"><kbd>B</kbd><br>SHOP</div>
    </div>
  </div>

  <!-- ‚ïê‚ïê TAB: INVENTORY ‚ïê‚ïê -->
  <div id="tab-inventory" class="tab-panel">
    <span class="lbl" style="margin-bottom:.8rem;display:block">CHOOSE YOUR SKIN</span>
    <div class="inv-grid" id="inv-skin-grid"></div>
    <div style="margin-top:.5rem;padding:.5rem .7rem;background:var(--card);border:1px solid var(--bdr);font-family:'Press Start 2P',monospace;font-size:.28rem;color:#5a5a90;line-height:2">
      üí° MORE SKINS UNLOCK AS YOU PLAY ¬∑ CURRENTLY ALL UNLOCKED
    </div>
  </div>

  <!-- ‚ïê‚ïê TAB: SHOP ‚ïê‚ïê -->
  <div id="tab-shop" class="tab-panel">
    <span class="lbl" style="margin-bottom:.3rem;display:block">WEAPON INFO</span>
    <p style="font-family:'Press Start 2P',monospace;font-size:.28rem;color:#5a5a90;margin-bottom:.8rem;line-height:2">BUY GUNS IN-GAME WITH [B] AFTER EARNING COINS</p>
    <div class="pre-shop-grid" id="pre-shop-grid"></div>
  </div>

  <!-- ‚ïê‚ïê TAB: CODE ‚ïê‚ïê -->
  <div id="tab-code" class="tab-panel">
    <div class="code-section">
      <span class="lbl">CREATE A ROOM</span>
      <p style="font-family:'Press Start 2P',monospace;font-size:.27rem;color:#5a5a90;margin-bottom:.7rem;line-height:2">TYPE A 4-DIGIT CODE OR LEAVE BLANK TO AUTO-GENERATE</p>
      <input id="code-in" type="text" placeholder="0000" maxlength="4" autocomplete="off" spellcheck="false"
        style="font-family:'Press Start 2P',monospace;font-size:1.4rem;letter-spacing:.25em;width:100%;background:transparent;border:none;border-bottom:2px solid var(--bdr);color:var(--y);padding:.4rem 0;outline:none;margin-bottom:.7rem;text-align:center"
        oninput="this.value=this.value.replace(/[^0-9]/g,'').slice(0,4)"/>
      <div class="code-btns">
        <button class="room-btn make" onclick="makeRoom()">üåê CREATE ROOM</button>
        <button class="room-btn join" onclick="joinRoom()">üîó JOIN WITH CODE</button>
      </div>
    </div>
    <div id="big-code-display" class="big-code-display"></div>
    <div id="room-status" style="font-family:'Press Start 2P',monospace;font-size:.32rem;text-align:center;margin-top:.5rem;min-height:1.4em;letter-spacing:.05em"></div>
    <div style="margin-top:1rem;padding:.6rem .7rem;background:var(--card);border:1px solid var(--bdr);font-family:'Press Start 2P',monospace;font-size:.27rem;color:#5a5a90;line-height:2.2">
      1Ô∏è‚É£ ONE PLAYER CREATES A ROOM<br>2Ô∏è‚É£ SHARES THE 4-DIGIT CODE<br>3Ô∏è‚É£ FRIEND ENTERS CODE AND JOINS<br>4Ô∏è‚É£ GAME STARTS AUTOMATICALLY
    </div>
  </div>

</div><!-- end .wrap -->
</div><!-- end #menu -->

<!-- ‚îÄ‚îÄ GAME ‚îÄ‚îÄ -->
<div id="game" class="screen">
  <canvas id="gc"></canvas>
  <div id="hud">
    <div id="scorebar">
      <div>
        <div id="mode-tag"></div>
        <div style="display:flex;align-items:center;gap:.8rem">
          <span class="sc r" id="sc-r">0</span>
          <div class="sep" id="sep-txt">KILLS<br>TO 30</div>
          <span class="sc b" id="sc-b">0</span>
        </div>
      </div>
    </div>
    <div id="stats">K &nbsp;<span id="s-k">0</span>&nbsp; D &nbsp;<span id="s-d">0</span>&nbsp; STK <span id="s-s">0</span></div>
    <div id="coins-hud">üí∞ <span id="coin-count">0</span></div>
    <div id="feed"></div>
    <div id="bot-hud">
      <div id="hp-bar"><span class="hl">HP</span><span class="hrt" id="h1">‚ù§Ô∏è</span><span class="hrt" id="h2">‚ù§Ô∏è</span><span class="hrt" id="h3">‚ù§Ô∏è</span><span id="shld"></span></div>
      <div id="pow-hud"></div>
      <div id="ammo-bar"><span id="gun-lbl">PISTOL</span><div id="bullets"></div><span id="reload-txt">RELOADING‚Ä¶</span></div>
    </div>
    <div id="map-lbl"></div>
    <div id="respawn-screen"><div id="rs-label">‚Äî ELIMINATED ‚Äî</div><div id="rs-count">3</div></div>
    <div id="streak-pop"><div id="streak-txt"></div></div>
    <div id="flash2" style="position:fixed;inset:0;pointer-events:none;z-index:4;opacity:0;transition:opacity .12s;background:rgba(255,49,49,.18)"></div>
    <!-- B key hint -->
    <div id="shop-hint" style="position:absolute;bottom:5rem;left:50%;transform:translateX(-50%);font-family:'Press Start 2P',monospace;font-size:.3rem;color:rgba(255,230,0,.45);pointer-events:none">
      [B] OPEN SHOP
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ SHOP ‚îÄ‚îÄ -->
<div id="shop-overlay">
  <div id="shop-title">‚öô GUN SHOP</div>
  <div id="shop-pistol-note">PISTOL IS FREE ‚Äî ALWAYS AVAILABLE</div>
  <div id="shop-coins-disp">üí∞ 0 COINS</div>
  <div class="shop-grid" id="shop-grid"></div>
  <div id="shop-msg"></div>
  <button id="shop-close" onclick="closeShop()">‚úï CLOSE [B]</button>
</div>

<!-- ‚îÄ‚îÄ END ‚îÄ‚îÄ -->
<div id="end" class="screen">
  <div id="mp-badge" style="display:none">MULTIPLAYER MATCH</div>
  <div id="end-title">RED WINS!</div>
  <div id="end-sub">ROUND OVER</div>
  <table><thead><tr><th>#</th><th>PLAYER</th><th>TEAM</th><th>K</th><th>D</th><th>K/D</th><th>SCORE</th><th>üí∞</th></tr></thead>
  <tbody id="sb"></tbody></table>
  <button id="again-btn" onclick="goMenu()">PLAY AGAIN ‚ö°</button>
</div>

<!-- ‚îÄ‚îÄ PAUSE ‚îÄ‚îÄ -->
<div id="pause" style="display:none;position:fixed;inset:0;background:rgba(5,5,8,.92);backdrop-filter:blur(16px);z-index:100;flex-direction:column;align-items:center;justify-content:center">
  <div style="font-family:'Press Start 2P',monospace;font-size:clamp(1rem,3vw,2rem);color:#FFE600;text-shadow:0 0 30px rgba(255,230,0,.8);margin-bottom:.5rem">PAUSED</div>
  <div style="font-family:'Press Start 2P',monospace;font-size:.35rem;color:#5a5a90;letter-spacing:.15em;margin-bottom:2rem">ESC TO RESUME ¬∑ B = SHOP</div>
  <div style="display:flex;flex-direction:column;gap:.7rem;width:100%;max-width:280px">
    <button onclick="togglePause()" style="font-family:'Press Start 2P',monospace;font-size:.45rem;background:transparent;border:2px solid #FFE600;color:#FFE600;padding:.8rem;cursor:pointer;letter-spacing:.08em;transition:all .15s" onmouseover="this.style.background='rgba(255,230,0,.12)'" onmouseout="this.style.background='transparent'">‚ñ∂ RESUME</button>
    <button onclick="openShop()" style="font-family:'Press Start 2P',monospace;font-size:.45rem;background:transparent;border:2px solid var(--g);color:var(--g);padding:.8rem;cursor:pointer;letter-spacing:.08em;transition:all .15s" onmouseover="this.style.background='rgba(0,229,160,.1)'" onmouseout="this.style.background='transparent'">üõí GUN SHOP</button>
    <button onclick="exitToMenu()" style="font-family:'Press Start 2P',monospace;font-size:.45rem;background:transparent;border:2px solid #FF3131;color:#FF3131;padding:.8rem;cursor:pointer;letter-spacing:.08em;transition:all .15s" onmouseover="this.style.background='rgba(255,49,49,.12)'" onmouseout="this.style.background='transparent'">‚úï EXIT TO MENU</button>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DATA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const MODES=[
  {id:'tdm', icon:'‚öîÔ∏è',  name:'TEAM DM',    desc:'First to 30 kills',target:30,teams:true},
  {id:'ffa', icon:'üíÄ',  name:'FREE 4 ALL', desc:'First to 8 kills', target:8, teams:false},
  {id:'koth',icon:'üëë',  name:'KING OF HILL',desc:'Hold zone 20s',   target:20,teams:true},
  {id:'ctf', icon:'üö©',  name:'CAPTURE FLAG',desc:'Capture 3 flags', target:3, teams:true},
  {id:'gun', icon:'üî´',  name:'GUN GAME',   desc:'Cycle all weapons',target:null,teams:false},
];
const SKINS=[
  {id:'phantom',col:'#8B5CF6',glow:'rgba(139,92,246,.7)',emoji:'üëª',name:'PHANTOM'},
  {id:'demon',  col:'#DC2626',glow:'rgba(220,38,38,.7)', emoji:'üòà',name:'DEMON'},
  {id:'ghost',  col:'#94A3B8',glow:'rgba(200,210,230,.5)',emoji:'ü§ç',name:'GHOST'},
  {id:'blaze',  col:'#F97316',glow:'rgba(249,115,22,.7)',emoji:'üî•',name:'BLAZE'},
  {id:'void',   col:'#312E81',glow:'rgba(99,102,241,.7)',emoji:'‚ö´',name:'VOID'},
  {id:'storm',  col:'#0891B2',glow:'rgba(8,145,178,.7)', emoji:'‚ö°',name:'STORM'},
];
// All guns with balanced stats
const GUNS=[
  {id:'pistol', name:'PISTOL', col:'#94A3B8',dmg:1,rate:.42,spd:620,spread:.07,ammo:12,reload:1.3,pel:1,range:1.5,tw:2,  price:0,   desc:'Starter weapon. Reliable.'},
  {id:'smg',    name:'SMG',    col:'#22D3EE',dmg:1,rate:.09,spd:560,spread:.19,ammo:30,reload:2.0,pel:1,range:1.2,tw:1.5,price:150, desc:'Fast fire, close range.'},
  {id:'shotgun',name:'SHOTGUN',col:'#F97316',dmg:1,rate:.88,spd:420,spread:.34,ammo:6, reload:1.9,pel:5,range:.55, tw:2.5,price:200, desc:'Devastating up close.'},
  {id:'assault',name:'ASSAULT',col:'#FB7185',dmg:1,rate:.19,spd:680,spread:.10,ammo:20,reload:1.6,pel:1,range:1.4,tw:2,  price:250, desc:'Balanced & versatile.'},
  {id:'sniper', name:'SNIPER', col:'#A3E635',dmg:3,rate:1.3,spd:1150,spread:.01,ammo:5,reload:2.2,pel:1,range:2.0,tw:3,  price:350, desc:'One-shot power. Slow.'},
];
const GUN_MAP=Object.fromEntries(GUNS.map(g=>[g.id,g]));
const GUN_ORDER=['pistol','smg','shotgun','assault','sniper'];
const POWS=[
  {id:'health',icon:'‚ù§Ô∏è',col:'#FF3131',lbl:'HEALTH +1'},
  {id:'speed', icon:'‚ö°',col:'#FFE600',lbl:'SPEED BOOST'},
  {id:'damage',icon:'üî•',col:'#F97316',lbl:'DAMAGE AMP'},
  {id:'shield',icon:'üõ°Ô∏è',col:'#00F5FF',lbl:'SHIELD'},
];
const STREAKS={2:'DOUBLE KILL!',3:'TRIPLE KILL!',4:'QUAD KILL!',5:'RAMPAGE!!',6:'UNSTOPPABLE!!',7:'GODLIKE!!'};
const BOT_NAMES_R=['REAPER','BLOODAX','VORTEX','INFERNO'];
const BOT_NAMES_B=['SPECTER','NOCTUA','CIPHER','WRAITH'];
const BOT_NAMES_F=['GHOST','RONIN','BLADE','ROGUE','APEX','VIPER','SHADOW'];
const AW=1400,AH=800,RAD=15,MAX_HP=3;
const SR=68,SARC=Math.PI*.68,ADR=.25,SCD=0.9;
const PSPD=250,BSPD=155,RSP=3;
const THEMES=[
  {name:'INDUSTRIAL',fl:'#050a0a',gr:'rgba(255,140,0,.03)',wf:'#0a0e12',ws:'rgba(255,140,50,.28)',wa:'rgba(255,140,50,.75)',st:'rgba(255,100,0,.07)'},
  {name:'RUINS',     fl:'#080710',gr:'rgba(180,150,70,.03)',wf:'#0f0a06',ws:'rgba(190,140,60,.3)',wa:'rgba(210,170,80,.75)',st:'rgba(160,110,40,.07)'},
  {name:'BUNKER',    fl:'#040810',gr:'rgba(0,210,90,.03)',  wf:'#040a06',ws:'rgba(0,180,80,.27)', wa:'rgba(0,220,100,.75)',st:'rgba(0,170,70,.07)'},
  {name:'VOID',      fl:'#050408',gr:'rgba(160,0,255,.03)', wf:'#0a0510',ws:'rgba(140,0,230,.3)', wa:'rgba(170,0,255,.75)',st:'rgba(130,0,210,.07)'},
  {name:'NEON',      fl:'#060408',gr:'rgba(255,0,130,.03)', wf:'#0d0410',ws:'rgba(255,0,100,.27)',wa:'rgba(255,0,130,.75)',st:'rgba(210,0,95,.07)'},
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MAP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function mkObs(){
  const sets=[[
    {x:645,y:345,w:110,h:110},{x:295,y:140,w:85,h:170},{x:295,y:490,w:85,h:170},
    {x:AW-380,y:140,w:85,h:170},{x:AW-380,y:490,w:85,h:170},{x:490,y:65,w:130,h:65},
    {x:490,y:AH-130,w:130,h:65},{x:AW-620,y:65,w:130,h:65},{x:AW-620,y:AH-130,w:130,h:65}
  ],[
    {x:225,y:245,w:350,h:40},{x:825,y:245,w:350,h:40},{x:225,y:AH-285,w:350,h:40},
    {x:825,y:AH-285,w:350,h:40},{x:AW/2-35,y:150,w:70,h:165},{x:AW/2-35,y:AH-315,w:70,h:165},
    {x:AW/2-35,y:AH/2-35,w:70,h:70}
  ],[
    {x:385,y:185,w:75,h:195},{x:385,y:185,w:195,h:75},{x:385,y:AH-380,w:75,h:195},
    {x:385,y:AH-260,w:195,h:75},{x:AW-460,y:185,w:75,h:195},{x:AW-580,y:185,w:195,h:75},
    {x:AW-460,y:AH-380,w:75,h:195},{x:AW-580,y:AH-260,w:195,h:75},{x:AW/2-45,y:AH/2-90,w:90,h:180}
  ],[
    {x:AW/2-55,y:AH/2-55,w:110,h:110},{x:330,y:180,w:75,h:75},{x:330,y:AH-255,w:75,h:75},
    {x:AW-405,y:180,w:75,h:75},{x:AW-405,y:AH-255,w:75,h:75},{x:540,y:AH/2-38,w:95,h:76},
    {x:AW-635,y:AH/2-38,w:95,h:76}
  ]];
  return sets[Math.floor(Math.random()*sets.length)];
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GAME STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let cvs,ctx,map,ents=[],bullets=[],particles=[],pups=[];
let player,keys={},mouse={x:700,y:400},mdown=false;
let shakeX=0,shakeY=0,shakeMag=0;
let scl=1,ox=0,oy=0;
let running=false,gameOver=false,paused=false,lastT=0;
let feedList=[];
let flags={};
let kills={red:0,blue:0},ffaK={},kothT={red:0,blue:0},ctfC={red:0,blue:0};
let pup_t=0;
let mode=MODES[0],myTeam='red',mySkin=SKINS[0];
let playerName='PLAYER';
let isMultiplayer=false;
let ownedGuns=new Set(['pistol']); // always have pistol

// ‚îÄ‚îÄ Multiplayer remote players ‚îÄ‚îÄ
let myPid=null;
let remotePlayers={}; // pid ‚Üí {x,y,angle,name,team,skin,hp,dead,gun,kills,deaths,score,coins}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ENTITY (local simulation)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
class Entity{
  constructor(x,y,team,name,isP,skin,gun){
    this.x=x;this.y=y;this.px=x;this.py=y;
    this.team=team;this.name=name;this.isP=!!isP;
    this.skin=skin||SKINS[0];
    this.setGun(gun||GUNS[0]);  // always pistol at start
    this.hp=MAX_HP;this.dead=false;this.hitF=0;
    this.vx=0;this.vy=0;this.angle=team==='red'?.1:Math.PI-.1;
    this.kills=0;this.deaths=0;this.score=0;this.streak=0;this.coins=0;
    this.shield=0;this.swordHits=0;
    this.powSpd=false;this.powSpdT=0;
    this.powDmg=false;this.powDmgT=0;
    this.atk=false;this.atkA=0;this.atkT=0;this.atkCD=0;this.hitSet=new Set();
    this.gunIdx=0;
    this.respT=0;
    this.aggro=.4+Math.random()*.6;
    this.target=null;this.wAngle=Math.random()*Math.PI*2;this.wT=0;
    this.bGunCD=0;this.stT=0;this.state='chase';
    this._sx=x;this._sy=y;this._stk=0;this._fw=0;
    this.ownedGuns=new Set(['pistol']); // bots also track owned guns
  }
  setGun(g){
    this.gun=g;this.ammo=g.ammo;
    this.reloading=false;this.reloadT=0;this.fireCD=0;
  }
  get tc(){return this.team==='red'?'#FF3131':this.team==='blue'?'#1E90FF':'#FFE600';}
  get tg(){return this.team==='red'?'rgba(255,49,49,.5)':this.team==='blue'?'rgba(30,144,255,.5)':'rgba(255,230,0,.4)';}

  takeDmg(src,dmg,isSword=false){
    if(this.dead)return;
    if(isSword){
      if(this.shield>0){this.shield=Math.max(0,this.shield-1);this.hitF=.2;burst(this.x,this.y,'#00F5FF',6);if(this.isP){shakeIt(4);upHp();}return;}
      this.swordHits++;this.hitF=.2;
      if(this.swordHits<2){burst(this.x,this.y,'rgba(255,220,50,.8)',4);shakeIt(3);if(this.isP)upHp();return;}
      this.swordHits=0;dmg=1;
    }else{
      if(this.shield>0){this.shield=Math.max(0,this.shield-dmg);this.hitF=.18;burst(this.x,this.y,'#00F5FF',5);if(this.isP)upHp();return;}
    }
    this.hp=Math.max(0,this.hp-dmg);this.hitF=.2;
    if(this.hp<=0)this.die(src);
    else if(this.isP){shakeIt(isSword?4:3);upHp();}
  }

  die(src){
    this.dead=true;this.hp=0;this.deaths++;this.streak=0;this.swordHits=0;
    this.respT=RSP;
    burst(this.x,this.y,this.tc,28,true);burst(this.x,this.y,'#FFE600',8,true);
    if(src){
      src.kills++;src.streak++;src.score+=100;
      src.coins+=50; // earn coins per kill
      if(mode.teams)kills[src.team]++;
      else ffaK[src.name]=(ffaK[src.name]||0)+1;
      // Gun game: advance weapon
      if(mode.id==='gun'){
        const nextIdx=Math.min(GUN_ORDER.length-1,(src.gunIdx||0)+1);
        src.gunIdx=nextIdx;
        src.setGun(GUN_MAP[GUN_ORDER[nextIdx]]);
        if(src.isP)upAmmo();
      }
      addFeed(src.name,this.name,src.team||'ffa');
      if(isMultiplayer&&src.isP)peerSend({type:'kill',name:src.name,victim:this.name,team:src.team||'ffa'});
      if(src.isP){
        if(STREAKS[src.streak])showStreak(STREAKS[src.streak]);
        upStats();upCoins();
      }
      upScore();checkWin();
    }
    if(this.isP){
      shakeIt(12);upHp();upStats();
      if(isMultiplayer)peerSend({type:'dead'});
      setTimeout(()=>setRespawn(Math.ceil(this.respT)),10);
    }
  }

  respawn(){
    let x,y,safe,t=0;
    do{
      safe=true;
      if(mode.id==='ffa'||mode.id==='gun'){
        x=Math.random()<.5?55+Math.random()*120:AW-55-Math.random()*120;
      }else{
        x=this.team==='red'?55+Math.random()*130:AW-55-Math.random()*130;
      }
      y=80+Math.random()*(AH-160);
      for(const o of map.obs)if(x>o.x-RAD&&x<o.x+o.w+RAD&&y>o.y-RAD&&y<o.y+o.h+RAD){safe=false;break;}
    }while(!safe&&++t<40);
    this.x=x;this.y=y;this.hp=MAX_HP;this.dead=false;this.hitF=0;
    this.shield=0;this.swordHits=0;this.reloading=false;this.reloadT=0;this.fireCD=0;this.atkCD=0;
    // Reset to pistol on respawn (not in gun game)
    if(mode.id!=='gun'){
      this.setGun(GUN_MAP['pistol']);
      if(this.isP){ownedGuns=new Set(['pistol']);}
    }else{
      this.ammo=this.gun.ammo;
    }
    if(this.isP){upHp();upAmmo();hideRespawn();upCoins();if(isMultiplayer)peerSend({type:'respawn'});}
  }

  shoot(a){
    if(this.fireCD>0||this.reloading||this.ammo<=0||this.dead)return;
    for(let i=0;i<this.gun.pel;i++){
      const sp=(Math.random()-.5)*this.gun.spread*2+(this.gun.pel>1?(i-2)*.06:0);
      bullets.push(new Bullet(this.x,this.y,a+sp,this,this.gun));
    }
    this.ammo--;this.fireCD=this.gun.rate;
    if(this.ammo===0){this.reloading=true;this.reloadT=this.gun.reload;}
    if(this.isP){shakeIt(this.gun.id==='shotgun'?5:this.gun.id==='sniper'?4:1);upAmmo();}
    // Send to friend in mp
    if(isMultiplayer&&this.isP)peerSend({type:'shoot',x:this.x,y:this.y,angle:a,gun:this.gun.id});
  }

  startAtk(){
    if(this.atkCD>0||this.atk||this.dead)return;
    this.atk=true;this.atkA=this.angle;this.atkT=ADR;this.atkCD=SCD;this.hitSet.clear();
  }
  checkMelee(){
    for(const e of ents){
      if(e===this||e.dead||this.hitSet.has(e))continue;
      if(mode.teams&&e.team===this.team)continue;
      const d=Math.hypot(e.x-this.x,e.y-this.y);if(d>SR+RAD)continue;
      let df=Math.atan2(e.y-this.y,e.x-this.x)-this.atkA;
      while(df>Math.PI)df-=Math.PI*2;while(df<-Math.PI)df+=Math.PI*2;
      if(Math.abs(df)<=SARC){this.hitSet.add(e);e.takeDmg(this,1,true);}
    }
  }

  updatePows(dt){
    if(this.powSpd){this.powSpdT-=dt;if(this.powSpdT<=0)this.powSpd=false;}
    if(this.powDmg){this.powDmgT-=dt;if(this.powDmgT<=0)this.powDmg=false;}
  }

  update(dt){
    this.updatePows(dt);
    if(this.hitF>0)this.hitF=Math.max(0,this.hitF-dt);
    if(this.fireCD>0)this.fireCD-=dt;
    if(this.atkCD>0)this.atkCD-=dt;
    if(this.reloading){
      this.reloadT-=dt;
      if(this.reloadT<=0){this.reloading=false;this.ammo=this.gun.ammo;if(this.isP)upAmmo();}
    }
    if(this.atk){this.atkT-=dt;if(this.atkT<=0)this.atk=false;else this.checkMelee();}
    if(this.dead){
      this.respT-=dt;
      if(this.isP)setRespawn(Math.ceil(this.respT));
      if(this.respT<=0)this.respawn();
      return;
    }
    this.isP?this.upPlayer():this.upBot(dt);
    this.x+=this.vx*dt;this.y+=this.vy*dt;
    this.x=Math.max(RAD,Math.min(AW-RAD,this.x));
    this.y=Math.max(RAD,Math.min(AH-RAD,this.y));
    for(const o of map.obs)pushOut(this,o);
    for(const p of pups){
      if(p.dead)continue;
      if(Math.hypot(p.x-this.x,p.y-this.y)<22){p.dead=true;applyPow(this,p.type);}
    }
  }

  upPlayer(){
    let dx=0,dy=0;
    if(keys['w']||keys['arrowup'])dy-=1;if(keys['s']||keys['arrowdown'])dy+=1;
    if(keys['a']||keys['arrowleft'])dx-=1;if(keys['d']||keys['arrowright'])dx+=1;
    const l=Math.hypot(dx,dy);if(l>0){dx/=l;dy/=l;}
    const sp=PSPD*(this.powSpd?1.55:1);
    this.vx=dx*sp;this.vy=dy*sp;
    const wx=(mouse.x-ox)/scl,wy=(mouse.y-oy)/scl;
    this.angle=Math.atan2(wy-this.y,wx-this.x);
    if(mdown&&!shopOpen)this.shoot(this.angle);
    // Send position to friend
    if(isMultiplayer)peerSend({type:'state',x:this.x,y:this.y,angle:this.angle,vx:this.vx,vy:this.vy});
  }

  upBot(dt){
    const AR=70;let ax=0,ay=0;const ep=55;
    if(this.x<ep)ax+=(ep-this.x)/ep;if(this.x>AW-ep)ax-=(this.x-(AW-ep))/ep;
    if(this.y<ep)ay+=(ep-this.y)/ep;if(this.y>AH-ep)ay-=(this.y-(AH-ep))/ep;
    for(const o of map.obs){
      const cx=Math.max(o.x,Math.min(o.x+o.w,this.x)),cy=Math.max(o.y,Math.min(o.y+o.h,this.y));
      const dx=this.x-cx,dy=this.y-cy,d=Math.hypot(dx,dy);
      if(d<AR&&d>0){const s=(AR-d)/AR;ax+=dx/d*s*2.2;ay+=dy/d*s*2.2;}
    }
    const al=Math.hypot(ax,ay);if(al>1){ax/=al;ay/=al;}
    this._stk+=dt;
    if(this._stk>0.6){
      if(Math.hypot(this.x-this._sx,this.y-this._sy)<8){this.wAngle=Math.random()*Math.PI*2;this._fw=0.7;}
      this._sx=this.x;this._sy=this.y;this._stk=0;
    }
    if(this._fw>0){
      this._fw-=dt;
      this.vx=Math.cos(this.wAngle)*BSPD+ax*BSPD;
      this.vy=Math.sin(this.wAngle)*BSPD+ay*BSPD;
      this.angle=this.wAngle;return;
    }
    // Target ‚Äî always chase player if reachable
    if(!this.target||this.target.dead){
      this.target=null;
      if(player&&!player.dead&&(mode.teams?player.team!==this.team:true)){
        this.target=player;
      }else{
        let best=Infinity;
        for(const e of ents){
          if(e===this||e.dead)continue;
          if(mode.teams&&e.team===this.team)continue;
          const d=Math.hypot(e.x-this.x,e.y-this.y);
          if(d<best){best=d;this.target=e;}
        }
      }
    }
    if(!this.target){
      this.wT-=dt;if(this.wT<=0){this.wAngle=(Math.random()-.5)*Math.PI*2;this.wT=.5+Math.random()*.8;}
      this.vx=Math.cos(this.wAngle)*BSPD*.5+ax*BSPD*.5;
      this.vy=Math.sin(this.wAngle)*BSPD*.5+ay*BSPD*.5;
      return;
    }
    const tx=this.target.x,ty=this.target.y;
    const d=Math.hypot(tx-this.x,ty-this.y);
    const toT=Math.atan2(ty-this.y,tx-this.x);
    this.angle=toT;
    this.stT-=dt;if(this.stT<=0){
      if(this.hp<=1&&d>120)this.state='retreat';
      else if(d<SR+22)this.state='strafe';
      else this.state='chase';
      this.stT=.35+Math.random()*.5;
    }
    this.bGunCD-=dt;
    if(d>SR+20&&d<900&&!this.reloading&&this.ammo>0&&this.bGunCD<=0){
      const lead=d/this.gun.spd;
      const aimA=Math.atan2(ty+this.target.vy*lead-this.y,tx+this.target.vx*lead-this.x);
      this.shoot(aimA+(Math.random()-.5)*.25*(1-this.aggro));
      this.bGunCD=this.gun.rate*(1+Math.random()*.4);
    }
    if(d<SR+8)this.startAtk();
    const sp=BSPD*(this.powSpd?1.55:1);
    const aw=Math.min(1,al*1.4);
    const cx2=Math.cos(toT),cy2=Math.sin(toT);
    const sdir=this.kills%2===0?1:-1;
    switch(this.state){
      case'chase':this.vx=(cx2*(1-aw)+ax*aw)*sp;this.vy=(cy2*(1-aw)+ay*aw)*sp;break;
      case'strafe':{const s=toT+Math.PI/2*sdir;this.vx=(Math.cos(s)*(1-aw)+ax*aw)*sp*.85;this.vy=(Math.sin(s)*(1-aw)+ay*aw)*sp*.85;break;}
      case'retreat':this.vx=(-cx2+ax*aw)*sp*.9;this.vy=(-cy2+ay*aw)*sp*.9;break;
    }
    // Bots occasionally buy a better gun when they have enough "coins"
    if(mode.id!=='gun'&&this.coins>=200&&Math.random()<.001){
      const affordable=GUNS.filter(g=>g.price>0&&g.price<=this.coins&&!this.ownedGuns.has(g.id));
      if(affordable.length){
        const pick=affordable[Math.floor(Math.random()*affordable.length)];
        this.ownedGuns.add(pick.id);this.coins-=pick.price;this.setGun(pick);
      }
    }
  }

  draw(){
    if(this.dead)return;
    const c=ctx;c.save();c.translate(this.x,this.y);
    if(this.atk){
      const prog=1-this.atkT/ADR;
      c.beginPath();c.moveTo(0,0);c.arc(0,0,SR,this.atkA-SARC,this.atkA-SARC+prog*SARC*2);c.closePath();
      c.fillStyle=this.isP?'rgba(255,230,0,.15)':this.team==='red'?'rgba(255,49,49,.15)':'rgba(30,144,255,.15)';c.fill();
    }
    c.shadowColor=this.isP?this.skin.glow:this.tg;c.shadowBlur=this.isP?26:12;
    c.beginPath();c.arc(0,0,RAD,0,Math.PI*2);
    c.fillStyle=this.hitF>0?'#fff':this.tc;
    if(this.hitF>0)c.globalAlpha=.6+this.hitF*2;
    c.fill();c.globalAlpha=1;c.shadowBlur=0;
    c.beginPath();c.arc(0,0,RAD*.7,0,Math.PI*2);c.fillStyle=this.skin.col;c.fill();
    c.save();c.beginPath();c.arc(0,0,3.5,0,Math.PI*2);c.fillStyle='rgba(255,255,255,.7)';c.fill();c.restore();
    if(this.shield>0){
      c.beginPath();c.arc(0,0,RAD+6,0,Math.PI*2);
      c.strokeStyle='rgba(0,245,255,.7)';c.lineWidth=2.5;c.shadowColor='#00F5FF';c.shadowBlur=10;c.stroke();c.shadowBlur=0;
    }
    if(this.isP){c.beginPath();c.arc(0,0,RAD+5,0,Math.PI*2);c.strokeStyle='rgba(255,230,0,.8)';c.lineWidth=2;c.stroke();}
    const sa=this.atk?this.atkA-SARC+(1-this.atkT/ADR)*SARC*2:this.angle;
    c.save();c.rotate(sa);
    c.shadowColor=this.atk?'rgba(255,230,0,.8)':'transparent';c.shadowBlur=this.atk?12:0;
    // Draw gun barrel (different shapes per gun)
    const g=this.gun;
    if(g.id==='sniper'){
      c.beginPath();c.moveTo(RAD-1,-1.5);c.lineTo(SR*.9,0);c.strokeStyle=this.atk?'#FFE600':g.col;c.lineWidth=this.atk?3:3;c.stroke();
    }else if(g.id==='shotgun'){
      c.beginPath();c.moveTo(RAD-1,-3);c.lineTo(SR*.7,-3);c.moveTo(RAD-1,3);c.lineTo(SR*.7,3);c.strokeStyle=this.atk?'#FFE600':g.col;c.lineWidth=this.atk?3:2.5;c.stroke();
    }else{
      c.beginPath();c.moveTo(RAD-1,-1.5);c.lineTo(SR*.85,0);c.strokeStyle=this.atk?'#FFE600':g.col;c.lineWidth=this.atk?3:2;c.stroke();
    }
    c.beginPath();c.moveTo(RAD+9,-7);c.lineTo(RAD+9,7);c.strokeStyle=this.atk?'rgba(255,230,0,.9)':'rgba(190,200,220,.7)';c.lineWidth=2.5;c.stroke();
    c.shadowBlur=0;c.restore();
    c.restore();
    // HP bar
    const bw=36,bh=4;
    ctx.fillStyle='rgba(0,0,0,.6)';ctx.fillRect(this.x-bw/2-1,this.y-RAD-14,bw+2,bh+2);
    ctx.fillStyle=this.hp===1?'#FF3131':this.tc;
    ctx.fillRect(this.x-bw/2,this.y-RAD-13,bw*(this.hp/MAX_HP),bh);
    // Name tag with gun
    ctx.font=this.isP?'bold 11px Barlow Condensed,sans-serif':'700 9px Barlow Condensed,sans-serif';
    ctx.textAlign='center';
    ctx.fillStyle=this.isP?'rgba(255,230,0,.95)':'rgba(200,210,230,.55)';
    const tag=this.isP?'‚ñ∂ YOU':this.name+(this.isP?'':' ü§ñ');
    ctx.fillText(tag,this.x,this.y-RAD-18);
    // Gun name tag for non-pistol
    if(this.gun.id!=='pistol'&&!this.isP){
      ctx.font='700 8px Barlow Condensed,sans-serif';ctx.fillStyle=this.gun.col+'99';
      ctx.fillText('['+this.gun.name+']',this.x,this.y-RAD-27);
    }
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BULLET / PARTICLE / POWERUP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
class Bullet{
  constructor(x,y,a,owner,g){
    this.x=x;this.y=y;this.px=x;this.py=y;
    this.owner=owner;this.team=owner.team;
    this.dmg=g.dmg*(owner.powDmg?2:1);
    this.gid=g.id;this.spd=g.spd;
    this.vx=Math.cos(a)*this.spd;this.vy=Math.sin(a)*this.spd;
    this.life=g.range;this.col=g.col;this.tw=g.tw;this.dead=false;
  }
  update(dt){
    this.px=this.x;this.py=this.y;
    this.x+=this.vx*dt;this.y+=this.vy*dt;
    this.life-=dt;
    if(this.life<=0||this.x<0||this.x>AW||this.y<0||this.y>AH){this.dead=true;return;}
    for(const o of map.obs){
      if(this.x>o.x&&this.x<o.x+o.w&&this.y>o.y&&this.y<o.y+o.h){this.dead=true;burst(this.x,this.y,this.col,4);return;}
    }
    for(const e of ents){
      if(e===this.owner||e.dead)continue;
      if(mode.teams&&e.team===this.team)continue;
      if(Math.hypot(e.x-this.x,e.y-this.y)<RAD+2){
        e.takeDmg(this.owner,this.dmg,false);
        this.dead=true;burst(this.x,this.y,this.col,10);
        shakeIt(this.gid==='sniper'?9:this.gid==='shotgun'?7:3);return;
      }
    }
  }
  draw(){
    const a=Math.min(1,this.life*3);
    ctx.save();ctx.globalAlpha=a*.8;
    ctx.strokeStyle=this.col;ctx.lineWidth=this.tw;
    ctx.shadowColor=this.col;ctx.shadowBlur=this.gid==='sniper'?12:5;
    ctx.beginPath();ctx.moveTo(this.px,this.py);ctx.lineTo(this.x,this.y);ctx.stroke();
    ctx.shadowBlur=14;ctx.fillStyle='#fff';
    ctx.beginPath();ctx.arc(this.x,this.y,this.tw,0,Math.PI*2);ctx.fill();
    ctx.restore();
  }
}
class Particle{
  constructor(x,y,col,big){
    this.x=x;this.y=y;this.col=col;
    const a=Math.random()*Math.PI*2,s=big?100+Math.random()*280:40+Math.random()*160;
    this.vx=Math.cos(a)*s;this.vy=Math.sin(a)*s;
    this.life=big?.4+Math.random()*.5:.2+Math.random()*.3;
    this.ml=this.life;this.r=big?2+Math.random()*5:1.5+Math.random()*3;
  }
  update(dt){this.x+=this.vx*dt;this.y+=this.vy*dt;this.vx*=.88;this.vy*=.88;this.life-=dt;}
  draw(){const a=Math.max(0,this.life/this.ml);ctx.globalAlpha=a;ctx.beginPath();ctx.arc(this.x,this.y,this.r*Math.sqrt(a),0,Math.PI*2);ctx.fillStyle=this.col;ctx.fill();ctx.globalAlpha=1;}
}
function burst(x,y,col,n,big=false){for(let i=0;i<n;i++)particles.push(new Particle(x,y,col,big));}

class Powerup{
  constructor(x,y,t){this.x=x;this.y=y;this.type=t;this.anim=Math.random()*Math.PI*2;this.dead=false;}
  draw(){
    const bob=Math.sin(Date.now()*.002+this.anim)*4;
    ctx.save();ctx.translate(this.x,this.y+bob);
    ctx.shadowColor=this.type.col;ctx.shadowBlur=14;
    ctx.beginPath();ctx.arc(0,0,11,0,Math.PI*2);ctx.fillStyle='rgba(5,5,8,.9)';ctx.fill();
    ctx.strokeStyle=this.type.col;ctx.lineWidth=2;ctx.stroke();ctx.shadowBlur=0;
    ctx.font='12px sans-serif';ctx.textAlign='center';ctx.textBaseline='middle';
    ctx.fillText(this.type.icon,0,0);ctx.restore();
  }
}
function applyPow(e,t){
  switch(t.id){
    case'health':e.hp=Math.min(MAX_HP,e.hp+1);if(e.isP)upHp();break;
    case'speed':e.powSpd=true;e.powSpdT=5;break;
    case'damage':e.powDmg=true;e.powDmgT=5;break;
    case'shield':e.shield=2;if(e.isP)upHp();break;
  }
  if(e.isP)upPow();
  burst(e.x,e.y,t.col,8);
}
function spawnPup(){
  let x,y,safe,t=0;
  do{safe=true;x=240+Math.random()*(AW-480);y=60+Math.random()*(AH-120);
    for(const o of map.obs)if(x>o.x-20&&x<o.x+o.w+20&&y>o.y-20&&y<o.y+o.h+20){safe=false;break;}
  }while(!safe&&++t<30);
  pups.push(new Powerup(x,y,POWS[Math.floor(Math.random()*POWS.length)]));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MAP DRAW
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function pushOut(e,o){
  const cx=Math.max(o.x,Math.min(o.x+o.w,e.x)),cy=Math.max(o.y,Math.min(o.y+o.h,e.y));
  const dx=e.x-cx,dy=e.y-cy,d=Math.hypot(dx,dy);
  if(d===0)e.x+=RAD;else if(d<RAD){const v=RAD-d;e.x+=dx/d*v;e.y+=dy/d*v;}
}
function drawMap(){
  const t=map.theme,c=ctx;
  c.fillStyle=t.fl;c.fillRect(0,0,AW,AH);
  c.strokeStyle=t.gr;c.lineWidth=1;
  for(let x=0;x<=AW;x+=55){c.beginPath();c.moveTo(x,0);c.lineTo(x,AH);c.stroke();}
  for(let y=0;y<=AH;y+=55){c.beginPath();c.moveTo(0,y);c.lineTo(AW,y);c.stroke();}
  c.strokeStyle=t.wa;c.lineWidth=2.5;c.strokeRect(3,3,AW-6,AH-6);
  c.fillStyle='rgba(255,49,49,.035)';c.fillRect(0,0,210,AH);
  c.fillStyle='rgba(30,144,255,.035)';c.fillRect(AW-210,0,210,AH);
  c.setLineDash([8,10]);
  c.strokeStyle='rgba(255,49,49,.1)';c.lineWidth=1;c.beginPath();c.moveTo(210,0);c.lineTo(210,AH);c.stroke();
  c.strokeStyle='rgba(30,144,255,.1)';c.beginPath();c.moveTo(AW-210,0);c.lineTo(AW-210,AH);c.stroke();
  c.setLineDash([]);
  c.save();c.globalAlpha=.018;c.font='bold 200px Barlow Condensed,sans-serif';c.textAlign='center';c.fillStyle='#fff';c.fillText('RIVALS',AW/2,AH/2+65);c.restore();
  if(mode.id==='koth'){
    c.beginPath();c.arc(AW/2,AH/2,85,0,Math.PI*2);
    c.fillStyle='rgba(255,230,0,.04)';c.fill();
    c.strokeStyle='rgba(255,230,0,.3)';c.lineWidth=2;c.setLineDash([10,8]);c.stroke();c.setLineDash([]);
  }
  for(const o of map.obs){
    c.fillStyle=t.wf;c.fillRect(o.x,o.y,o.w,o.h);
    c.strokeStyle=t.ws;c.lineWidth=2;c.strokeRect(o.x,o.y,o.w,o.h);
    c.save();c.beginPath();c.rect(o.x,o.y,o.w,o.h);c.clip();
    c.strokeStyle=t.st;c.lineWidth=1;
    for(let d=-o.h;d<o.w+o.h;d+=18){c.beginPath();c.moveTo(o.x+d,o.y);c.lineTo(o.x+d+o.h,o.y+o.h);c.stroke();}
    c.restore();
    const cs=9;c.strokeStyle=t.wa;c.lineWidth=2;
    [[o.x,o.y,1,1],[o.x+o.w,o.y,-1,1],[o.x,o.y+o.h,1,-1],[o.x+o.w,o.y+o.h,-1,-1]].forEach(([bx,by,sx,sy])=>{
      c.beginPath();c.moveTo(bx+sx*cs,by);c.lineTo(bx,by);c.lineTo(bx,by+sy*cs);c.stroke();
    });
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  WIN CHECK
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let gameStartT=0;
let hasPlayed=false;
function checkWin(){
  if(gameOver)return;
  // HARD BLOCK: never trigger within first 5 seconds
  if(performance.now()-gameStartT<5000)return;
  const t=mode.target;
  if(mode.id==='tdm'){
    if(kills.red>=t&&kills.red>0)endGame('RED TEAM','r');
    else if(kills.blue>=t&&kills.blue>0)endGame('BLUE TEAM','b');
  }else if(mode.id==='ffa'){
    const entries=Object.entries(ffaK);
    const top=entries.sort((a,b)=>b[1]-a[1])[0];
    if(top&&top[1]>=t&&top[1]>0)endGame(top[0]+' WINS!','y');
  }else if(mode.id==='koth'){
    if(kothT.red>=t&&kothT.red>0)endGame('RED TEAM','r');
    else if(kothT.blue>=t&&kothT.blue>0)endGame('BLUE TEAM','b');
  }else if(mode.id==='ctf'){
    if(ctfC.red>=t&&ctfC.red>0)endGame('RED TEAM','r');
    else if(ctfC.blue>=t&&ctfC.blue>0)endGame('BLUE TEAM','b');
  }else if(mode.id==='gun'){
    for(const e of ents){
      if(e.gunIdx>=GUN_ORDER.length-1&&e.kills>=1){
        endGame(e.isP?'YOU WIN!':e.name+' WINS',e.isP?'y':e.team==='red'?'r':'b');return;
      }
    }
  }
}
function endGame(txt,cls){
  if(gameOver)return;
  if(!hasPlayed)return;  // never show end screen before game actually starts
  gameOver=true;running=false;closeShop();
  const won=(cls==='y')||(cls==='r'&&myTeam==='red')||(cls==='b'&&myTeam==='blue');
  const fl=document.getElementById('flash');
  fl.style.background=won?'rgba(255,230,0,.15)':'rgba(255,49,49,.18)';
  fl.style.opacity='1';setTimeout(()=>fl.style.opacity='0',700);
  setTimeout(()=>{
    document.getElementById('end-title').textContent=(won?'üèÜ VICTORY! ':'')+txt;
    document.getElementById('end-title').className=cls;
    document.getElementById('end-sub').textContent=mode.name+' ‚Äî ROUND OVER';
    document.getElementById('mp-badge').style.display=isMultiplayer?'inline-block':'none';
    buildSB();
    showScreen('end');
  },900);
}
function buildSB(){
  // Merge remote players into scoreboard
  const allPlayers=[...ents];
  const sorted=[...allPlayers].sort((a,b)=>b.kills-a.kills||(b.score-a.score));
  const tb=document.getElementById('sb');tb.innerHTML='';
  sorted.forEach((e,i)=>{
    const kd=e.deaths>0?(e.kills/e.deaths).toFixed(2):e.kills.toFixed(0)+'.00';
    const tr=document.createElement('tr');
    if(e.isP)tr.className='me';
    const tm=e.team==='red'?'<span class="tr2">RED</span>':'<span class="tb2">BLUE</span>';
    const isBot=!e.isP;
    tr.innerHTML=`<td>${i===0?'üëë':'#'+(i+1)}</td><td>${e.isP?'<b>‚ñ∂ '+e.name+'</b>':e.name+(isBot?' ü§ñ':'')}</td><td>${tm}</td><td class="tk">${e.kills}</td><td class="tkd">${e.deaths}</td><td>${kd}</td><td class="ts">${e.score.toLocaleString()}</td><td class="co">${e.coins}</td>`;
    tb.appendChild(tr);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  HUD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function upScore(){
  const r=document.getElementById('sc-r'),b=document.getElementById('sc-b'),sep=document.getElementById('sep-txt');
  if(mode.id==='tdm'){
    r.textContent=kills.red;b.textContent=kills.blue;
    r.className='sc r';b.className='sc b';
    sep.innerHTML='KILLS<br>TO '+mode.target;
  }else if(mode.id==='ffa'){
    const entries=Object.entries(ffaK).sort((a,b)=>b[1]-a[1]);
    const top=entries[0];
    r.textContent=top?top[1]:0;b.textContent=mode.target;
    r.className='sc f';b.className='sc f';
    sep.innerHTML='TOP<br>TO WIN';
  }else if(mode.id==='koth'){
    r.textContent=Math.floor(kothT.red)+'s';b.textContent=Math.floor(kothT.blue)+'s';
    r.className='sc r';b.className='sc b';
    sep.innerHTML='ZONE<br>'+mode.target+'s';
  }else if(mode.id==='ctf'){
    r.textContent=ctfC.red;b.textContent=ctfC.blue;
    r.className='sc r';b.className='sc b';
    sep.innerHTML='CAPS<br>OF '+mode.target;
  }else if(mode.id==='gun'){
    r.textContent=player?(player.gunIdx+1):1;b.textContent=GUN_ORDER.length;
    r.className='sc f';b.className='sc f';
    sep.innerHTML='GUN<br>TIER';
  }
}
function upStats(){
  if(!player)return;
  document.getElementById('s-k').textContent=player.kills;
  document.getElementById('s-d').textContent=player.deaths;
  document.getElementById('s-s').textContent=player.streak;
}
function upCoins(){
  if(!player)return;
  document.getElementById('coin-count').textContent=player.coins;
}
function upHp(){
  if(!player)return;
  for(let i=1;i<=3;i++)document.getElementById('h'+i).classList.toggle('empty',i>player.hp);
  document.getElementById('shld').textContent=player.shield>0?'üõ°Ô∏è'.repeat(player.shield):'';
}
function upAmmo(){
  if(!player)return;
  const g=player.gun;
  document.getElementById('gun-lbl').textContent=g.name;
  document.getElementById('gun-lbl').style.color=g.col;
  const bd=document.getElementById('bullets');bd.innerHTML='';
  for(let i=0;i<Math.min(g.ammo,30);i++){
    const d=document.createElement('div');d.className='bl';
    d.style.background=i<player.ammo?g.col:'rgba(255,255,255,.1)';
    d.style.height=g.id==='sniper'?'12px':'8px';
    bd.appendChild(d);
  }
  document.getElementById('reload-txt').style.display=player.reloading?'block':'none';
}
function upPow(){
  if(!player)return;
  const el=document.getElementById('pow-hud');el.innerHTML='';
  if(player.powSpd)el.insertAdjacentHTML('beforeend','<span title="Speed">‚ö°</span>');
  if(player.powDmg)el.insertAdjacentHTML('beforeend','<span title="Damage">üî•</span>');
}
let feedList2=[];
function addFeed(k,v,team){
  feedList2.unshift({k,v,team,life:4.5});
  if(feedList2.length>5)feedList2.pop();
  document.getElementById('feed').innerHTML=feedList2.map(f=>`<div class="fi ${f.team==='red'?'r':f.team==='blue'?'b':'f'}"><span style="color:#f0f0ff">${f.k.slice(0,9)}</span><span style="color:var(--y)"> ‚öî </span><span style="color:#5a5a90">${f.v.slice(0,9)}</span></div>`).join('');
}
function setRespawn(n){
  document.getElementById('respawn-screen').classList.add('show');
  document.getElementById('rs-count').textContent=Math.max(0,n);
}
function hideRespawn(){document.getElementById('respawn-screen').classList.remove('show');}
let stTO;
function showStreak(txt){
  clearTimeout(stTO);
  document.getElementById('streak-txt').textContent=txt;
  const el=document.getElementById('streak-pop');el.classList.remove('show');void el.offsetWidth;el.classList.add('show');
  stTO=setTimeout(()=>el.classList.remove('show'),2100);
}
function shakeIt(m){shakeMag=Math.max(shakeMag,m);}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SHOP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let shopOpen=false;
function buildShop(){
  const grid=document.getElementById('shop-grid');
  grid.innerHTML='';
  const barGuns=GUNS.filter(g=>g.price>0); // exclude pistol (free)
  barGuns.forEach(g=>{
    const owned=ownedGuns.has(g.id);
    const active=player&&player.gun.id===g.id;
    const canAfford=player&&player.coins>=g.price;
    const card=document.createElement('div');
    card.className='shop-card'+(active?' active-gun':owned?' owned':'');
    const btnLabel=active?'EQUIPPED':owned?'EQUIP':'BUY';
    const btnDisabled=(!owned&&!canAfford)?'disabled':'';
    card.innerHTML=`
      <span class="shop-gun-name" style="color:${g.col}">${g.name}</span>
      <span class="shop-price">${g.price===0?'FREE':'üí∞ '+g.price}</span>
      <div class="shop-stat">DMG: ${'‚ñà'.repeat(Math.min(5,g.dmg*2))}${'‚ñë'.repeat(Math.max(0,5-g.dmg*2))}</div>
      <div class="shop-stat">SPD: ${'‚ñà'.repeat(Math.round(g.spd/300))}${'‚ñë'.repeat(Math.max(0,5-Math.round(g.spd/300)))}</div>
      <div class="shop-stat">AMMO: ${g.ammo}</div>
      <div class="shop-stat" style="font-size:.75rem;color:#444;margin-top:.3rem">${g.desc}</div>
      <button class="shop-buy-btn" ${btnDisabled} onclick="buyGun('${g.id}')">${btnLabel}</button>`;
    grid.appendChild(card);
  });
  document.getElementById('shop-coins-disp').textContent='üí∞ '+(player?player.coins:0)+' COINS';
}
function openShop(){
  if(!running&&!paused)return;
  shopOpen=true;
  buildShop();
  document.getElementById('shop-overlay').classList.add('open');
  document.getElementById('shop-msg').textContent='';
}
function closeShop(){
  shopOpen=false;
  document.getElementById('shop-overlay').classList.remove('open');
}
function buyGun(gid){
  const g=GUN_MAP[gid];
  if(!g||!player)return;
  const owned=ownedGuns.has(gid);
  if(owned||gid==='pistol'){
    // Just equip
    player.setGun(g);ownedGuns.add(gid);
    upAmmo();
    document.getElementById('shop-msg').style.color='#00E5A0';
    document.getElementById('shop-msg').textContent='‚úì EQUIPPED '+g.name+'!';
    buildShop();
    if(isMultiplayer){
      peerSend({type:'gun',gun:gid});
    }
    return;
  }
  if(player.coins<g.price){
    document.getElementById('shop-msg').style.color='#FF3131';
    document.getElementById('shop-msg').textContent='‚úó NEED '+g.price+' COINS (have '+player.coins+')';
    return;
  }
  player.coins-=g.price;
  player.setGun(g);
  ownedGuns.add(gid);
  upAmmo();upCoins();
  document.getElementById('shop-msg').style.color='#00E5A0';
  document.getElementById('shop-msg').textContent='‚úì BOUGHT '+g.name+'!';
  buildShop();
  if(isMultiplayer){
    peerSend({type:'gun',gun:gid});
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  REMOTE PLAYER DRAWING (multiplayer)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function drawRemotePlayers(){
  for(const [pid,rp] of Object.entries(remotePlayers)){
    if(rp.dead)continue;
    const c=ctx;
    const tc=rp.team==='red'?'#FF3131':'#1E90FF';
    const skin=SKINS.find(s=>s.id===rp.skin)||SKINS[0];
    c.save();c.translate(rp.x,rp.y);
    c.shadowColor=tc;c.shadowBlur=12;
    c.beginPath();c.arc(0,0,RAD,0,Math.PI*2);c.fillStyle=tc;c.fill();c.shadowBlur=0;
    c.beginPath();c.arc(0,0,RAD*.7,0,Math.PI*2);c.fillStyle=skin.col;c.fill();
    // Gun barrel
    const g=GUN_MAP[rp.gun||'pistol'];
    c.save();c.rotate(rp.angle);
    c.beginPath();c.moveTo(RAD-1,-1.5);c.lineTo(SR*.85,0);c.strokeStyle=g.col;c.lineWidth=2;c.stroke();
    c.restore();
    c.restore();
    // HP bar
    const bw=36,bh=4,hp=rp.hp||3;
    ctx.fillStyle='rgba(0,0,0,.6)';ctx.fillRect(rp.x-bw/2-1,rp.y-RAD-14,bw+2,bh+2);
    ctx.fillStyle=hp===1?'#FF3131':tc;
    ctx.fillRect(rp.x-bw/2,rp.y-RAD-13,bw*(hp/MAX_HP),bh);
    ctx.font='700 9px Barlow Condensed,sans-serif';ctx.textAlign='center';
    ctx.fillStyle='rgba(200,210,230,.8)';
    ctx.fillText(rp.name||'PLAYER',rp.x,rp.y-RAD-18);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MAIN LOOP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function loop(ts){
  if(!running||paused)return;
  const dt=Math.min((ts-lastT)/1000,.065);lastT=ts;
  if(shakeMag>.1){shakeX=(Math.random()-.5)*shakeMag*2;shakeY=(Math.random()-.5)*shakeMag*2;shakeMag*=.78;}
  else{shakeX=0;shakeY=0;shakeMag=0;}
  pup_t+=dt;if(pup_t>9){pup_t=0;if(pups.filter(p=>!p.dead).length<4)spawnPup();}
  pups=pups.filter(p=>!p.dead);
  if(mode.id==='koth'){
    for(const e of ents){
      if(e.dead)continue;
      if(Math.hypot(e.x-AW/2,e.y-AH/2)<85){kothT[e.team]=(kothT[e.team]||0)+dt;}
    }
    upScore();if(!gameOver&&performance.now()-gameStartT>5000)checkWin();
  }
  if(mode.id==='ctf'){
    for(const team of['red','blue']){
      const f=flags[team];
      const enemyTeam=team==='red'?'blue':'red';
      if(f.dropped){f.dropT-=dt;if(f.dropT<=0){f.dropped=false;f.dropX=f.homeX;f.dropY=f.homeY;}}
      for(const e of ents){
        if(e.dead)continue;
        const fx=f.carrier?e.x:(f.dropped?f.dropX:f.homeX);
        const fy=f.carrier?e.y:(f.dropped?f.dropY:f.homeY);
        if(!f.carrier&&e.team===enemyTeam&&Math.hypot(e.x-fx,e.y-fy)<24){f.carrier=e;burst(e.x,e.y,team==='red'?'#FF3131':'#1E90FF',10);}
        if(f.carrier===e){
          const hf=flags[e.team];
          const ownAtHome=!hf.carrier&&!hf.dropped;
          if(ownAtHome&&Math.hypot(e.x-hf.homeX,e.y-hf.homeY)<40){
            ctfC[e.team]++;f.carrier=null;f.dropped=false;
            burst(e.x,e.y,'#FFE600',20,true);addFeed(e.name,'FLAG',e.team);
            upScore();if(!gameOver)checkWin();
          }
        }
      }
      if(f.carrier&&f.carrier.dead){f.dropped=true;f.dropX=f.carrier.x;f.dropY=f.carrier.y;f.dropT=8;f.carrier=null;}
    }
  }
  for(const e of ents)e.update(dt);
  for(let i=0;i<ents.length;i++)for(let j=i+1;j<ents.length;j++){
    const a=ents[i],b=ents[j];if(a.dead||b.dead)continue;
    const dx=b.x-a.x,dy=b.y-a.y,d=Math.hypot(dx,dy),mn=RAD*2;
    if(d<mn&&d>0){const p=(mn-d)/2;a.x-=dx/d*p;a.y-=dy/d*p;b.x+=dx/d*p;b.y+=dy/d*p;}
  }
  bullets=bullets.filter(b=>{if(b.dead)return false;b.update(dt);return!b.dead;});
  particles=particles.filter(p=>p.life>0);for(const p of particles)p.update(dt);
  feedList2=feedList2.filter(f=>{f.life-=dt;return f.life>0;});
  if(player&&!player.dead)upPow();
  render();
  requestAnimationFrame(loop);
}

function render(){
  scl=Math.min(cvs.width/AW,cvs.height/AH);
  ox=(cvs.width-AW*scl)/2;oy=(cvs.height-AH*scl)/2;
  ctx.clearRect(0,0,cvs.width,cvs.height);
  ctx.fillStyle='#000';ctx.fillRect(0,0,cvs.width,cvs.height);
  ctx.save();ctx.translate(ox+shakeX,oy+shakeY);ctx.scale(scl,scl);
  drawMap();
  pups.forEach(p=>p.draw());
  particles.forEach(p=>p.draw());
  bullets.forEach(b=>b.draw());
  if(isMultiplayer)drawRemotePlayers();
  ents.forEach(e=>e.draw());
  if(mode.id==='ctf'){
    for(const[team,f]of Object.entries(flags)){
      const col=team==='red'?'#FF3131':'#1E90FF';
      let fx,fy;
      if(f.carrier){fx=f.carrier.x;fy=f.carrier.y-28;}
      else if(f.dropped){fx=f.dropX;fy=f.dropY;}
      else{fx=f.homeX;fy=f.homeY;}
      ctx.save();ctx.translate(fx,fy);ctx.shadowColor=col;ctx.shadowBlur=12;
      ctx.font='20px sans-serif';ctx.textAlign='center';ctx.textBaseline='middle';
      ctx.fillText(team==='red'?'üö©':'üè≥',0,0);ctx.restore();
      ctx.beginPath();ctx.arc(f.homeX,f.homeY,36,0,Math.PI*2);
      ctx.strokeStyle=col+'66';ctx.lineWidth=2;ctx.setLineDash([6,6]);ctx.stroke();ctx.setLineDash([]);
    }
  }
  ctx.restore();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PEER-TO-PEER ROOM SYSTEM (WebRTC via PeerJS CDN)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Uses PeerJS public signaling ‚Äî no server needed
// Room code = 4-digit number, host peer ID = "rivals-XXXX", joiner = "rivals-XXXX-guest-N"

let peer=null,peerConn=null,roomCode='',isHost=false;

function setPeerLib(cb){
  if(window.Peer){cb();return;}
  const s=document.createElement('script');
  s.src='https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js';
  s.onload=cb;s.onerror=()=>roomStatus('‚úó Could not load PeerJS. Check internet.','#FF3131');
  document.head.appendChild(s);
}

function roomStatus(msg,col='#FFE600'){
  const el=document.getElementById('room-status');
  el.textContent=msg;el.style.color=col||'#FFE600';
}

function makeRoom(){
  const code=(document.getElementById('code-in').value.trim()||String(Math.floor(1000+Math.random()*9000)));
  if(!/^\d{4}$/.test(code)){roomStatus('‚úó Code must be 4 digits','#FF3131');return;}
  roomCode=code;isHost=true;
  roomStatus('Loading‚Ä¶');
  setPeerLib(()=>{
    if(peer){peer.destroy();}
    peer=new Peer('rivals-'+code,{debug:0});
    peer.on('open',id=>{
      const el=document.getElementById('big-code-display');
      el.style.display='block';el.textContent=code;
      roomStatus('‚úì Room open! Share code with friend. Waiting‚Ä¶','#00E5A0');
    });
    peer.on('connection',conn=>{
      peerConn=conn;
      conn.on('open',()=>{
        isMultiplayer=true;
        // Send host info to guest
        conn.send(JSON.stringify({type:'welcome',name:playerName,team:myTeam,skin:mySkin.id}));
        roomStatus('‚úì Friend connected! Starting‚Ä¶','#00E5A0');
        setTimeout(()=>startGame(false,true),800);
      });
      conn.on('data',d=>handlePeer(JSON.parse(d)));
      conn.on('close',()=>{isMultiplayer=false;addFeed('FRIEND','LEFT','ffa');});
    });
    peer.on('error',e=>{
      if(e.type==='unavailable-id')roomStatus('‚úó Code taken, try another','#FF3131');
      else roomStatus('‚úó '+e.type,'#FF3131');
    });
  });
}

function joinRoom(){
  const code=document.getElementById('code-in').value.trim();
  if(!/^\d{4}$/.test(code)){roomStatus('‚úó Enter a 4-digit code','#FF3131');return;}
  roomCode=code;isHost=false;
  roomStatus('Connecting‚Ä¶');
  setPeerLib(()=>{
    if(peer){peer.destroy();}
    const myId='rivals-'+code+'-g-'+Date.now();
    peer=new Peer(myId,{debug:0});
    peer.on('open',()=>{
      peerConn=peer.connect('rivals-'+code,{reliable:true});
      peerConn.on('open',()=>{
        isMultiplayer=true;
        peerConn.send(JSON.stringify({type:'welcome',name:playerName||'PLAYER',team:myTeam,skin:mySkin.id}));
        roomStatus('‚úì Joined! Starting‚Ä¶','#00E5A0');
        setTimeout(()=>startGame(false,true),800);
      });
      peerConn.on('data',d=>handlePeer(JSON.parse(d)));
      peerConn.on('close',()=>{isMultiplayer=false;addFeed('HOST','LEFT','ffa');});
    });
    peer.on('error',e=>{
      if(e.type==='peer-unavailable')roomStatus('‚úó Room '+code+' not found','#FF3131');
      else roomStatus('‚úó '+e.type,'#FF3131');
    });
  });
}

function peerSend(obj){
  if(peerConn&&peerConn.open)try{peerConn.send(JSON.stringify(obj));}catch(e){}
}

function handlePeer(msg){
  switch(msg.type){
    case'welcome':
      // Other player joined ‚Äî register them as remote
      remotePlayers['friend']={
        x:msg.team==='red'?100:1300,y:400,angle:0,
        name:msg.name||'FRIEND',team:msg.team||'blue',
        skin:msg.skin||'phantom',hp:3,dead:false,gun:'pistol',
        kills:0,deaths:0,score:0,coins:0,vx:0,vy:0
      };
      addFeed(msg.name||'FRIEND','JOINED',msg.team||'blue');
      break;
    case'state':
      if(remotePlayers['friend']){
        remotePlayers['friend'].x=msg.x;remotePlayers['friend'].y=msg.y;
        remotePlayers['friend'].angle=msg.angle;
        remotePlayers['friend'].vx=msg.vx||0;remotePlayers['friend'].vy=msg.vy||0;
      }
      break;
    case'shoot':{
      const rp=remotePlayers['friend'];
      const g=GUN_MAP[msg.gun]||GUN_MAP['pistol'];
      if(rp){
        const fo={x:msg.x,y:msg.y,team:rp.team,powDmg:false,vx:0,vy:0};
        bullets.push(new Bullet(msg.x,msg.y,msg.angle,fo,g));
      }
      break;
    }
    case'kill':
      if(remotePlayers['friend']){
        remotePlayers['friend'].kills=(remotePlayers['friend'].kills||0)+1;
        remotePlayers['friend'].score=(remotePlayers['friend'].score||0)+100;
      }
      addFeed(msg.name,msg.victim,msg.team);
      kills[msg.team]=(kills[msg.team]||0)+1;
      upScore();
      break;
    case'dead':
      if(remotePlayers['friend']){remotePlayers['friend'].dead=true;remotePlayers['friend'].hp=0;}
      break;
    case'respawn':
      if(remotePlayers['friend']){remotePlayers['friend'].dead=false;remotePlayers['friend'].hp=3;remotePlayers['friend'].gun='pistol';}
      break;
    case'hp':
      if(remotePlayers['friend']){remotePlayers['friend'].hp=msg.hp;}
      break;
    case'gun':
      if(remotePlayers['friend']){remotePlayers['friend'].gun=msg.gun;}
      break;
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  START GAME
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function startGame(mp=false,alreadyConnected=false){
  playerName=(document.getElementById('name-in').value.trim().toUpperCase()||'PLAYER').slice(0,12)||'PLAYER';
  if(!alreadyConnected)isMultiplayer=false;

  showScreen('game');
  map={theme:THEMES[Math.floor(Math.random()*THEMES.length)],obs:mkObs()};
  document.getElementById('map-lbl').textContent=map.theme.name+(isMultiplayer?' [ROOM '+roomCode+']':'');
  document.getElementById('mode-tag').textContent={tdm:'‚öîÔ∏è TDM',ffa:'üíÄ FFA',koth:'üëë KOTH',ctf:'üö© CTF',gun:'üî´ GUN GAME'}[mode.id];
  document.getElementById('koth-bar')&&(document.getElementById('koth-bar').style.display=mode.id==='koth'?'block':'none');
  // Reset all state
  ents=[];bullets=[];particles=[];pups=[];feedList2=[];remotePlayers={};
  kills={red:0,blue:0};kothT={red:0,blue:0};ctfC={red:0,blue:0};ffaK={};gameStartT=performance.now();
  gameOver=false;shakeMag=0;pup_t=0;paused=false;shopOpen=false;
  ownedGuns=new Set(['pistol']); // always reset to pistol
  document.getElementById('feed').innerHTML='';
  hideRespawn();closeShop();

  // Player ‚Äî always starts with PISTOL
  const px=myTeam==='red'?100:AW-100,py=AH/2+(Math.random()-.5)*200;
  player=new Entity(px,py,myTeam,playerName,true,mySkin,GUN_MAP['pistol']);
  ffaK[playerName]=0;
  ents.push(player);

  // Bots (8 bots, also start with pistol)
  for(let i=0;i<8;i++){
    const t=mode.teams?(i<4?myTeam:(myTeam==='red'?'blue':'red')):(i%2===0?'red':'blue');
    const nm=mode.teams?(t==='red'?BOT_NAMES_R:BOT_NAMES_B)[i%4]:BOT_NAMES_F[i%BOT_NAMES_F.length];
    const sk=SKINS[Math.floor(Math.random()*SKINS.length)];
    const bx=t==='red'?80+Math.random()*120:AW-80-Math.random()*120;
    const by=80+Math.random()*(AH-160);
    const bot=new Entity(bx,by,t,nm,false,sk,GUN_MAP['pistol']); // pistol start
    bot.aggro=.4+Math.random()*.6;
    bot.coins=Math.floor(Math.random()*200); // bots start with some coins
    ffaK[nm]=0;
    ents.push(bot);
  }
  for(let i=0;i<3;i++)spawnPup();
  flags={
    red:{x:120,y:AH/2,homeX:120,homeY:AH/2,carrier:null,dropped:false,dropX:0,dropY:0,dropT:0},
    blue:{x:AW-120,y:AH/2,homeX:AW-120,homeY:AH/2,carrier:null,dropped:false,dropX:0,dropY:0,dropT:0}
  };
  upScore();upStats();upHp();upAmmo();upPow();upCoins();
  running=true;hasPlayed=true;lastT=performance.now();gameStartT=performance.now();
  requestAnimationFrame(loop);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MENU LOGIC
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function pickTeam(t){
  myTeam=t;
  document.getElementById('tbr').classList.toggle('on',t==='red');
  document.getElementById('tbb').classList.toggle('on',t==='blue');
}
function switchTab(id,btn){
  document.querySelectorAll('.tab-panel').forEach(p=>p.classList.remove('on'));
  document.querySelectorAll('.mtab').forEach(b=>b.classList.remove('on'));
  document.getElementById('tab-'+id).classList.add('on');
  btn.classList.add('on');
}

function buildMenu(){
  // ‚îÄ‚îÄ PLAY tab: game modes ‚îÄ‚îÄ
  const mg=document.getElementById('mode-grid');
  MODES.forEach((m,i)=>{
    const d=document.createElement('div');d.className='mbt'+(i===0?' on':'');d.dataset.id=m.id;
    d.innerHTML=`<span class="mbt-icon">${m.icon}</span><span class="mbt-name">${m.name}</span><span class="mbt-desc">${m.desc}</span>`;
    d.onclick=()=>{mode=m;document.querySelectorAll('.mbt').forEach(b=>b.classList.remove('on'));d.classList.add('on');};
    mg.appendChild(d);
  });
  mode=MODES[0];

  // ‚îÄ‚îÄ INVENTORY tab: skins ‚îÄ‚îÄ
  const ig=document.getElementById('inv-skin-grid');
  SKINS.forEach((s,i)=>{
    const d=document.createElement('div');d.className='inv-card'+(i===0?' on':'');
    d.innerHTML=`<span class="ic-icon">${s.emoji}</span><span class="ic-name">${s.name}</span><span class="ic-check">‚úì</span>`;
    d.onclick=()=>{
      mySkin=s;
      document.querySelectorAll('.inv-card').forEach(b=>b.classList.remove('on'));
      d.classList.add('on');
    };
    ig.appendChild(d);
  });
  mySkin=SKINS[0];

  // ‚îÄ‚îÄ SHOP tab: gun info cards ‚îÄ‚îÄ
  const pg=document.getElementById('pre-shop-grid');
  const stars=(n,max)=>'‚òÖ'.repeat(n)+'‚òÜ'.repeat(max-n);
  GUNS.forEach(g=>{
    const dmgS=Math.min(5,g.dmg*2);
    const spdS=Math.round(g.spd/300);
    const d=document.createElement('div');d.className='psg-card';
    d.innerHTML=`
      <span class="pg-name" style="color:${g.col}">${g.id==='pistol'?'üî´ ':''}${g.name}</span>
      <div class="pg-stat">DMG &nbsp; ${stars(dmgS,5)}</div>
      <div class="pg-stat">SPD &nbsp; ${stars(Math.min(5,spdS),5)}</div>
      <div class="pg-stat">AMMO &nbsp; ${g.ammo} &nbsp;|&nbsp; RELOAD ${g.reload}s</div>
      <div class="pg-stat" style="color:#444;font-size:.78rem;margin-top:.3rem">${g.desc}</div>
      <span class="pg-note">${g.price===0?'‚úì FREE STARTER GUN':'üí∞ '+g.price+' COINS IN-GAME'}</span>`;
    pg.appendChild(d);
  });
}
function showScreen(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById(id).classList.add('active');}
function goMenu(){
  if(peer){try{peer.destroy();}catch(e){}}peer=null;peerConn=null;
  remotePlayers={};isMultiplayer=false;roomCode='';
  document.getElementById('big-code-display').style.display='none';
  document.getElementById('room-status').textContent='';
  running=false;gameOver=true;paused=false;hasPlayed=false;closeShop();
  showScreen('menu');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INPUT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.addEventListener('keydown',e=>{
  keys[e.key.toLowerCase()]=true;
  const inGame=document.getElementById('game').classList.contains('active');
  if(!inGame)return;
  if(e.key==='Escape'){e.preventDefault();if(shopOpen){closeShop();}else{togglePause();}return;}
  if(e.key.toLowerCase()==='b'){e.preventDefault();if(shopOpen)closeShop();else openShop();return;}
  if(shopOpen||paused)return;
  if(!player||player.dead||!running)return;
  if(e.key===' '){e.preventDefault();player.shoot(player.angle);}
  if(e.key.toLowerCase()==='f')player.startAtk();
  if(e.key.toLowerCase()==='r'&&!player.reloading&&player.ammo<player.gun.ammo){
    player.reloading=true;player.reloadT=player.gun.reload;
    if(isMultiplayer)peerSend({type:'gun',gun:player.gun.id});
  }
});
window.addEventListener('keyup',e=>keys[e.key.toLowerCase()]=false);
window.addEventListener('mousemove',e=>{mouse.x=e.clientX;mouse.y=e.clientY;});

window.addEventListener('load',()=>{
  cvs=document.getElementById('gc');ctx=cvs.getContext('2d');
  const resize=()=>{cvs.width=window.innerWidth;cvs.height=window.innerHeight;};
  resize();window.addEventListener('resize',resize);
  cvs.addEventListener('mousedown',e=>{
    if(shopOpen)return;
    mdown=true;
    if(!player||player.dead||!running)return;
    if(e.button===0)player.shoot(player.angle);
    if(e.button===2)player.startAtk();
  });
  cvs.addEventListener('mouseup',()=>mdown=false);
  cvs.addEventListener('contextmenu',e=>e.preventDefault());
  buildMenu();
});

let paused=false;
function togglePause(){
  if(!running&&!paused)return;
  paused=!paused;
  document.getElementById('pause').style.display=paused?'flex':'none';
  if(!paused){running=true;lastT=performance.now();requestAnimationFrame(loop);}
  else running=false;
}
function exitToMenu(){paused=false;document.getElementById('pause').style.display='none';goMenu();}
</script>
</body>
</html>
