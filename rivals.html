<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RIVALS</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Barlow+Condensed:wght@500;600;700;800&display=swap" rel="stylesheet">
<style>
:root{
  --y:#FFE600;--pk:#FF0080;--cy:#00F5FF;
  --red:#FF3131;--blue:#1E90FF;--green:#22C55E;--purple:#A855F7;
  --bg:#050508;--surf:#0d0d18;--bdr:#1a1a2e;--txt:#f0f0ff;--muted:#5a5a90;
}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%;overflow:hidden;background:var(--bg);font-family:'Barlow Condensed',sans-serif;color:var(--txt);font-weight:500}
.screen{position:fixed;inset:0;display:none;flex-direction:column;align-items:center;justify-content:flex-start;overflow-y:auto}
.screen.active{display:flex}

/* â”€â”€ MENU â”€â”€ */
#s-menu{
  background:var(--bg);padding:1.5rem 1rem 2rem;
  background-image:linear-gradient(rgba(255,230,0,.035) 1px,transparent 1px),linear-gradient(90deg,rgba(255,230,0,.035) 1px,transparent 1px);
  background-size:55px 55px;animation:gs 22s linear infinite;
}
@keyframes gs{from{background-position:0 0}to{background-position:55px 55px}}
.orb{position:absolute;border-radius:50%;filter:blur(90px);animation:of 9s ease-in-out infinite;pointer-events:none}
.o1{width:460px;height:460px;background:rgba(255,0,128,.09);top:-12%;left:-8%;animation-delay:0s}
.o2{width:320px;height:320px;background:rgba(0,245,255,.07);bottom:0;right:0;animation-delay:-5s}
@keyframes of{0%,100%{transform:translateY(0) scale(1)}50%{transform:translateY(-28px) scale(1.05)}}
.inner{position:relative;z-index:1;width:100%;max-width:820px;margin:0 auto;text-align:center}
@keyframes fu{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:none}}
@keyframes glitch{0%,90%,100%{transform:none;filter:none}91%{transform:translate(-3px,0);filter:drop-shadow(3px 0 var(--red))}92%{transform:translate(3px,0);filter:drop-shadow(-3px 0 var(--cy))}93%,95%{transform:none;filter:none}94%{transform:translate(2px,-1px);filter:drop-shadow(-2px 0 var(--red))}}
.me{font-family:'Press Start 2P',monospace;font-size:.44rem;color:var(--cy);letter-spacing:.25em;margin-bottom:.7rem;opacity:0;animation:fu .7s .1s forwards}
.mt{font-family:'Press Start 2P',monospace;font-size:clamp(2.5rem,8vw,5rem);color:var(--y);line-height:1;text-shadow:0 0 35px rgba(255,230,0,.9),0 0 70px rgba(255,230,0,.4);animation:glitch 5s infinite,fu .7s .15s both;margin-bottom:.3rem}
.msub{font-family:'Press Start 2P',monospace;font-size:.42rem;color:var(--muted);letter-spacing:.12em;margin-bottom:1.2rem;opacity:0;animation:fu .7s .25s forwards}
.sec-label{font-family:'Press Start 2P',monospace;font-size:.38rem;color:var(--muted);letter-spacing:.18em;display:block;margin-bottom:.55rem;text-align:left}
/* Name + Team */
.row1{display:flex;gap:.7rem;align-items:flex-end;justify-content:center;margin-bottom:1rem;flex-wrap:wrap;opacity:0;animation:fu .7s .3s forwards}
.ni{background:var(--surf);border:2px solid var(--bdr);color:var(--txt);font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:1.1rem;padding:.5rem .9rem;outline:none;width:180px;letter-spacing:.05em;transition:border-color .2s}
.ni:focus{border-color:var(--y)}.ni::placeholder{color:var(--muted)}
.team-pair{display:flex;gap:.4rem}
.bt{font-family:'Press Start 2P',monospace;font-size:.42rem;letter-spacing:.04em;padding:.65rem 1rem;border:2px solid;background:transparent;cursor:pointer;transition:all .2s;clip-path:polygon(8px 0%,100% 0%,calc(100% - 8px) 100%,0% 100%)}
.bt-r{border-color:var(--red);color:var(--red)}.bt-r:hover,.bt-r.sel{background:var(--red);color:#fff;box-shadow:0 0 28px rgba(255,49,49,.5)}
.bt-b{border-color:var(--blue);color:var(--blue)}.bt-b:hover,.bt-b.sel{background:var(--blue);color:#fff;box-shadow:0 0 28px rgba(30,144,255,.5)}
/* Modes */
.modes-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:.5rem;margin-bottom:1rem;opacity:0;animation:fu .7s .38s forwards}
.mc{border:2px solid var(--bdr);padding:.65rem .4rem;cursor:pointer;transition:all .2s;text-align:center}
.mc:hover{border-color:rgba(255,230,0,.45);transform:translateY(-2px)}.mc.sel{border-color:var(--y);background:rgba(255,230,0,.06)}
.mc-icon{font-size:1.5rem;display:block;margin-bottom:.3rem}
.mc-name{font-family:'Press Start 2P',monospace;font-size:.3rem;color:var(--y);display:block;letter-spacing:.04em;margin-bottom:.25rem;line-height:1.5}
.mc-desc{font-size:.75rem;color:var(--muted);line-height:1.3}
/* Skin grid */
.sg{display:grid;grid-template-columns:repeat(6,1fr);gap:.5rem;margin-bottom:1rem;opacity:0;animation:fu .7s .45s forwards}
.sk{border:2px solid var(--bdr);padding:.5rem .25rem;cursor:pointer;transition:all .2s;display:flex;flex-direction:column;align-items:center;gap:.3rem}
.sk:hover{border-color:rgba(255,230,0,.45);transform:translateY(-2px)}.sk.sel{border-color:var(--y);background:rgba(255,230,0,.06)}
.sp{width:30px;height:30px;border-radius:50%;border:3px solid rgba(255,255,255,.1);display:flex;align-items:center;justify-content:center;font-size:.9rem}
.sn{font-family:'Press Start 2P',monospace;font-size:.28rem;color:rgba(255,255,255,.7);letter-spacing:.05em}
/* Gun grid */
.gr{display:flex;gap:.45rem;justify-content:center;margin-bottom:1rem;flex-wrap:wrap;opacity:0;animation:fu .7s .52s forwards}
.gc{border:2px solid var(--bdr);padding:.55rem .4rem;cursor:pointer;transition:all .2s;text-align:center;min-width:100px;flex:1;max-width:130px}
.gc:hover{border-color:rgba(255,230,0,.4);transform:translateY(-2px)}.gc.sel{border-color:var(--y);background:rgba(255,230,0,.06)}
.gname{font-family:'Press Start 2P',monospace;font-size:.32rem;letter-spacing:.04em;display:block;margin-bottom:.4rem}
.srow{display:flex;align-items:center;gap:.3rem;margin-bottom:.18rem}
.slb{font-size:.7rem;color:var(--muted);min-width:20px;font-weight:700}
.pips{display:flex;gap:2px}.pip{width:7px;height:5px;border-radius:1px}
.bp{font-family:'Press Start 2P',monospace;font-size:.55rem;letter-spacing:.1em;background:var(--y);color:#000;padding:.85rem 2.8rem;border:none;cursor:pointer;clip-path:polygon(12px 0%,100% 0%,calc(100% - 12px) 100%,0% 100%);transition:transform .2s,filter .2s;visibility:hidden;margin-bottom:1rem}
.bp.show{visibility:visible}.bp:hover{transform:translateY(-3px);filter:brightness(1.15)}
.ctr{display:flex;gap:1.3rem;justify-content:center;flex-wrap:wrap;opacity:0;animation:fu .7s .65s forwards}
.ci{font-family:'Press Start 2P',monospace;font-size:.32rem;color:var(--muted);text-align:center;line-height:2.1}
kbd{display:inline-block;background:var(--surf);border:1px solid var(--bdr);padding:.1rem .3rem;border-radius:2px;color:rgba(255,255,255,.65);font-family:inherit}

/* â”€â”€ GAME â”€â”€ */
#s-game{padding:0;justify-content:flex-start;align-items:flex-start;overflow:hidden}
#gc{position:fixed;inset:0;width:100%;height:100%;display:block;cursor:crosshair}
#hud{position:fixed;inset:0;pointer-events:none;z-index:10}

/* Score bar */
#hs{position:absolute;top:1rem;left:50%;transform:translateX(-50%);display:flex;align-items:center;gap:1rem;background:rgba(5,5,8,.92);border:1px solid rgba(255,255,255,.06);padding:.55rem 1.5rem;backdrop-filter:blur(10px);white-space:nowrap}
.sn2{font-family:'Press Start 2P',monospace;font-size:1.4rem;line-height:1;transition:all .3s}
.sn2.red{color:var(--red);text-shadow:0 0 14px rgba(255,49,49,.7)}
.sn2.blue{color:var(--blue);text-shadow:0 0 14px rgba(30,144,255,.7)}
.sn2.ffa{color:var(--y);text-shadow:0 0 14px rgba(255,230,0,.7)}
.ssep{font-family:'Press Start 2P',monospace;font-size:.38rem;color:var(--muted);text-align:center;line-height:1.9;letter-spacing:.06em}
#hmode{font-family:'Press Start 2P',monospace;font-size:.36rem;color:rgba(255,255,255,.3);position:absolute;top:.25rem;left:50%;transform:translateX(-50%);white-space:nowrap}

/* Left HUD */
#hl{position:absolute;top:1rem;left:1rem;font-family:'Press Start 2P',monospace;font-size:.34rem;color:var(--muted);background:rgba(5,5,8,.88);border:1px solid rgba(255,255,255,.04);padding:.4rem .65rem;line-height:2.2;letter-spacing:.05em}
#hl .v{color:var(--y)}

/* Kill feed */
#hfeed{position:absolute;top:1rem;right:1rem;display:flex;flex-direction:column;gap:.28rem;align-items:flex-end;max-width:240px}
.kf{font-family:'Press Start 2P',monospace;font-size:.33rem;padding:.25rem .55rem;background:rgba(5,5,8,.92);border-right:3px solid;letter-spacing:.02em;white-space:nowrap;animation:kfi .3s ease;max-width:100%;overflow:hidden;text-overflow:ellipsis}
.kf.red{border-color:var(--red)}.kf.blue{border-color:var(--blue)}.kf.ffa{border-color:var(--y)}
.kk{color:rgba(255,255,255,.9)}.kv{color:var(--muted)}.ksep{color:var(--y)}
@keyframes kfi{from{opacity:0;transform:translateX(16px)}to{opacity:1;transform:none}}

/* Bottom HUD */
#hbot{position:absolute;bottom:1.2rem;left:50%;transform:translateX(-50%);display:flex;flex-direction:column;align-items:center;gap:.35rem}
#hhp{display:flex;align-items:center;gap:.4rem;background:rgba(5,5,8,.88);border:1px solid rgba(255,255,255,.04);padding:.4rem .9rem}
.hpl{font-family:'Press Start 2P',monospace;font-size:.34rem;color:var(--muted);letter-spacing:.1em;margin-right:.2rem}
.heart{font-size:1.1rem;transition:all .22s}.heart.e{opacity:.13;transform:scale(.75)}
.shield-pip{font-size:1rem;color:var(--cy)}
#hammo{display:flex;align-items:center;gap:.6rem;background:rgba(5,5,8,.88);border:1px solid rgba(255,255,255,.04);padding:.35rem .9rem}
#hgname{font-family:'Press Start 2P',monospace;font-size:.34rem;letter-spacing:.06em}
#hbullets{display:flex;gap:2px;align-items:center;max-width:160px;flex-wrap:wrap}
.bpip{width:4px;height:9px;border-radius:1px;transition:opacity .1s}
#hreload{font-family:'Press Start 2P',monospace;font-size:.34rem;color:var(--y);letter-spacing:.08em;animation:rp 1s ease-in-out infinite}
@keyframes rp{0%,100%{opacity:1}50%{opacity:.3}}
/* Powerup display */
#hpow{display:flex;gap:.3rem;background:rgba(5,5,8,.88);border:1px solid rgba(255,255,255,.04);padding:.3rem .7rem;min-height:32px;align-items:center}
.pow-pip{font-size:1rem;transition:all .3s}
/* Gun game weapon */
#hgun{font-family:'Press Start 2P',monospace;font-size:.32rem;color:var(--y);background:rgba(5,5,8,.88);border:1px solid rgba(255,255,255,.04);padding:.3rem .7rem;letter-spacing:.07em;display:none}

/* Map name */
#mapname{position:absolute;bottom:1.2rem;right:1rem;font-family:'Press Start 2P',monospace;font-size:.32rem;color:rgba(255,255,255,.18);letter-spacing:.08em}

/* KOTH zone bar */
#koth-bar{position:absolute;top:5.5rem;left:50%;transform:translateX(-50%);display:none;flex-direction:column;align-items:center;gap:.3rem}
#koth-bar.show{display:flex}
.koth-track{width:260px;height:10px;background:rgba(255,255,255,.06);border:1px solid var(--bdr);position:relative;overflow:hidden}
.koth-fill-r{position:absolute;left:0;top:0;height:100%;background:var(--red);transition:width .3s}
.koth-fill-b{position:absolute;right:0;top:0;height:100%;background:var(--blue);transition:width .3s}
.koth-label{font-family:'Press Start 2P',monospace;font-size:.3rem;color:var(--muted);letter-spacing:.1em;display:flex;gap:1.5rem}
.kl-r{color:var(--red)}.kl-b{color:var(--blue)}

/* CTF flags */
#ctf-hud{position:absolute;top:5.5rem;left:50%;transform:translateX(-50%);display:none;gap:2rem;font-family:'Press Start 2P',monospace;font-size:.38rem;background:rgba(5,5,8,.88);border:1px solid rgba(255,255,255,.04);padding:.4rem 1.2rem}
#ctf-hud.show{display:flex}
.ctf-r{color:var(--red)}.ctf-b{color:var(--blue)}

/* Respawn */
#hrespawn{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;display:none;pointer-events:none}
#hrespawn.show{display:block}
.rsd{font-family:'Press Start 2P',monospace;font-size:.55rem;color:var(--red);letter-spacing:.2em;margin-bottom:.6rem}
.rsc{font-family:'Press Start 2P',monospace;font-size:3.5rem;color:var(--y);text-shadow:0 0 40px rgba(255,230,0,.9);animation:pu 1s ease-in-out infinite}
@keyframes pu{0%,100%{transform:scale(1)}50%{transform:scale(1.07)}}

/* Kill streak banner */
#streak-banner{position:absolute;top:35%;left:50%;transform:translateX(-50%);pointer-events:none;display:none;text-align:center}
#streak-banner.show{display:block}
.sb-text{font-family:'Press Start 2P',monospace;font-size:clamp(.8rem,2.5vw,1.2rem);color:var(--y);text-shadow:0 0 40px rgba(255,230,0,.9),0 0 80px rgba(255,230,0,.5);letter-spacing:.1em;animation:sbAnim .5s ease}
@keyframes sbAnim{from{opacity:0;transform:scale(.5)}to{opacity:1;transform:scale(1)}}

/* Powerup pickup flash */
#pow-banner{position:absolute;top:40%;left:50%;transform:translateX(-50%);pointer-events:none;display:none;text-align:center}
#pow-banner.show{display:block}
.pb-text{font-family:'Press Start 2P',monospace;font-size:.55rem;color:var(--cy);letter-spacing:.1em;animation:sbAnim .4s ease}

/* â”€â”€ END SCREEN â”€â”€ */
#s-end{background:rgba(5,5,8,.97);backdrop-filter:blur(20px);justify-content:center;align-items:center;overflow-y:auto}
.ewt{font-family:'Press Start 2P',monospace;font-size:clamp(1.1rem,4vw,2.5rem);margin-bottom:.4rem;animation:fu .5s ease;text-align:center}
.ewt.red{color:var(--red);text-shadow:0 0 50px rgba(255,49,49,.8)}
.ewt.blue{color:var(--blue);text-shadow:0 0 50px rgba(30,144,255,.8)}
.ewt.you{color:var(--y);text-shadow:0 0 50px rgba(255,230,0,.8)}
.ewt.ffa{color:var(--purple);text-shadow:0 0 50px rgba(168,85,247,.8)}
.esub{font-family:'Press Start 2P',monospace;font-size:.42rem;color:var(--muted);letter-spacing:.15em;margin-bottom:1.5rem;text-align:center}
/* Scoreboard */
.sb-table{width:100%;max-width:650px;border-collapse:collapse;margin-bottom:2rem}
.sb-table th{font-family:'Press Start 2P',monospace;font-size:.32rem;color:var(--muted);letter-spacing:.08em;padding:.5rem .7rem;text-align:left;border-bottom:2px solid var(--y)}
.sb-table td{padding:.6rem .7rem;font-size:.95rem;font-weight:700;border-bottom:1px solid var(--bdr)}
.sb-table tr.highlight td{background:rgba(255,230,0,.06)}
.sb-table tr.highlight td:first-child{border-left:3px solid var(--y)}
.sb-win{color:var(--y)}.sb-kd{color:var(--cy)}.sb-k{color:var(--pk)}.sb-team-r{color:var(--red)}.sb-team-b{color:var(--blue)}
.ba{font-family:'Press Start 2P',monospace;font-size:.55rem;letter-spacing:.1em;background:var(--y);color:#000;padding:.85rem 2.8rem;border:none;cursor:pointer;clip-path:polygon(12px 0%,100% 0%,calc(100% - 12px) 100%,0% 100%);transition:transform .2s,filter .2s}
.ba:hover{transform:translateY(-3px);filter:brightness(1.1)}
#flash{position:fixed;inset:0;pointer-events:none;z-index:5;opacity:0;transition:opacity .12s}
</style>
</head>
<body>
<div id="flash"></div>

<!-- â•â•â• MENU â•â•â• -->
<div id="s-menu" class="screen active">
  <div class="orb o1"></div><div class="orb o2"></div>
  <div class="inner">
    <p class="me">âš” RED vs BLUE Â· SEASON 1 LIVE âš”</p>
    <h1 class="mt">RIVALS</h1>
    <p class="msub">PICK YOUR MODE Â· LOAD OUT Â· DOMINATE</p>

    <div class="row1">
      <div><label class="sec-label">NAME</label><input id="ni" class="ni" type="text" placeholder="ENTER NAME" maxlength="12" spellcheck="false" autocomplete="off"/></div>
      <div id="team-pick"><label class="sec-label">TEAM</label><div class="team-pair"><button class="bt bt-r" onclick="selTeam('red')">ğŸ”´ RED</button><button class="bt bt-b" onclick="selTeam('blue')">ğŸ”µ BLUE</button></div></div>
    </div>

    <label class="sec-label">GAME MODE</label>
    <div class="modes-grid" id="mg"></div>

    <label class="sec-label">SKIN</label>
    <div class="sg" id="sg"></div>

    <div id="gun-row"><label class="sec-label">WEAPON</label><div class="gr" id="gr"></div></div>

    <button id="bp" class="bp" onclick="startGame()">âš¡ ENTER ARENA</button>

    <div class="ctr">
      <div class="ci"><kbd>WASD</kbd><br>MOVE</div>
      <div class="ci">MOUSE<br>AIM</div>
      <div class="ci"><kbd>LMB</kbd><br>SHOOT</div>
      <div class="ci"><kbd>F</kbd>/<kbd>RMB</kbd><br>SWORD</div>
      <div class="ci"><kbd>R</kbd><br>RELOAD</div>
      <div class="ci"><kbd>E</kbd><br>GRAB FLAG</div>
    </div>
  </div>
</div>

<!-- â•â•â• GAME â•â•â• -->
<div id="s-game" class="screen">
  <canvas id="gc"></canvas>
  <div id="hud">
    <div id="hs">
      <span id="hmode"></span>
      <span class="sn2 red" id="sr">0</span>
      <div class="ssep" id="ssep">KILLS<br>TO 5</div>
      <span class="sn2 blue" id="sb2">0</span>
    </div>
    <div id="hl">MY KILLS &nbsp;<span class="v" id="mk">0</span><br>DEATHS &nbsp;&nbsp;<span class="v" id="md">0</span><br>STREAK &nbsp;&nbsp;<span class="v" id="ms">0</span></div>
    <div id="hfeed"></div>
    <div id="koth-bar"><div class="koth-label"><span class="kl-r" id="kr-s">0s</span><span style="color:var(--muted)">ZONE</span><span class="kl-b" id="kb-s">0s</span></div><div class="koth-track"><div class="koth-fill-r" id="kr-fill" style="width:0%"></div><div class="koth-fill-b" id="kb-fill" style="width:0%"></div></div></div>
    <div id="ctf-hud"><span class="ctf-r">ğŸš© RED: <span id="ctf-r">0</span></span><span class="ctf-b">ğŸ³ BLUE: <span id="ctf-b">0</span></span></div>
    <div id="hbot">
      <div id="hhp"><span class="hpl">HP</span><span class="heart" id="h1">â¤ï¸</span><span class="heart" id="h2">â¤ï¸</span><span class="heart" id="h3">â¤ï¸</span><span id="shield-display"></span></div>
      <div id="hpow"></div>
      <div id="hammo"><span id="hgname">PISTOL</span><div id="hbullets"></div><span id="hreload" style="display:none">RELOADINGâ€¦</span></div>
      <div id="hgun"></div>
    </div>
    <div id="mapname"></div>
    <div id="hrespawn"><div class="rsd">â€” YOU DIED â€”</div><div class="rsc" id="rsc">3</div></div>
    <div id="streak-banner"><div class="sb-text" id="sb-text"></div></div>
    <div id="pow-banner"><div class="pb-text" id="pb-text"></div></div>
  </div>
</div>

<!-- â•â•â• END â•â•â• -->
<div id="s-end" class="screen">
  <div class="ewt" id="et">RED WINS!</div>
  <div class="esub" id="es">ROUND OVER</div>
  <table class="sb-table" id="sb-table"><thead><tr><th>#</th><th>PLAYER</th><th>TEAM</th><th>K</th><th>D</th><th>K/D</th><th>SCORE</th></tr></thead><tbody id="sb-body"></tbody></table>
  <button class="ba" onclick="playAgain()">PLAY AGAIN âš¡</button>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const MODES = [
  {id:'tdm',  name:'TEAM DM',       icon:'âš”ï¸',  desc:'First team to 30 kills', target:30, teams:true,  ffaScore:false},
  {id:'ffa',  name:'FREE FOR ALL',  icon:'ğŸ’€',  desc:'Every man for himself. First to 8 kills', target:8,  teams:false, ffaScore:true},
  {id:'koth', name:'KING OF HILL',  icon:'ğŸ‘‘',  desc:'Hold center zone. First to 20 seconds', target:20, teams:true,  ffaScore:false},
  {id:'ctf',  name:'CAPTURE FLAG',  icon:'ğŸš©',  desc:'Steal the enemy flag. First to 3 caps', target:3,  teams:true,  ffaScore:false},
  {id:'gun',  name:'GUN GAME',      icon:'ğŸ”«',  desc:'Each kill = next weapon. First through all wins', target:null,teams:false, ffaScore:false},
  {id:'1v1',  name:'1V1 DUEL',       icon:'ğŸ¥Š',  desc:'You vs one opponent. Small arena. First to 5 kills', target:5,  teams:false, ffaScore:true},
];
const SKINS = [
  {id:'phantom',bodyCol:'#8B5CF6',accCol:'#C4B5FD',glowCol:'rgba(139,92,246,.7)',shape:'rings',emoji:'ğŸ‘»',name:'PHANTOM'},
  {id:'demon',  bodyCol:'#DC2626',accCol:'#FCA5A5',glowCol:'rgba(220,38,38,.7)', shape:'eyes', emoji:'ğŸ˜ˆ',name:'DEMON'},
  {id:'ghost',  bodyCol:'#94A3B8',accCol:'#F1F5F9',glowCol:'rgba(200,210,230,.5)',shape:'soft', emoji:'ğŸ¤',name:'GHOST'},
  {id:'blaze',  bodyCol:'#F97316',accCol:'#FED7AA',glowCol:'rgba(249,115,22,.7)',shape:'fire', emoji:'ğŸ”¥',name:'BLAZE'},
  {id:'void',   bodyCol:'#312E81',accCol:'#818CF8',glowCol:'rgba(99,102,241,.7)', shape:'cross',emoji:'âš«',name:'VOID'},
  {id:'storm',  bodyCol:'#0891B2',accCol:'#67E8F9',glowCol:'rgba(8,145,178,.7)',  shape:'zap',  emoji:'âš¡',name:'STORM'},
];
const GUNS = [
  {id:'pistol', name:'PISTOL', col:'#94A3B8',dmg:1,rate:.42,spd:620,spread:.07,maxAmmo:12,reload:1.3,pellets:1,range:1.5,tw:2, d:2,f:3,a:3,icon:'ğŸ”«'},
  {id:'smg',    name:'SMG',    col:'#22D3EE',dmg:1,rate:.08,spd:560,spread:.19,maxAmmo:30,reload:2.0,pellets:1,range:1.2,tw:1.5,d:1,f:5,a:5,icon:'ğŸ”§'},
  {id:'shotgun',name:'SHOTGUN',col:'#F97316',dmg:1,rate:.88,spd:420,spread:.34,maxAmmo:6, reload:1.9,pellets:5,range:.55,tw:2.5,d:5,f:1,a:1,icon:'ğŸ’¥'},
  {id:'sniper', name:'SNIPER', col:'#A3E635',dmg:3,rate:1.3,spd:1150,spread:.01,maxAmmo:5,reload:2.2,pellets:1,range:2.0,tw:3,  d:5,f:1,a:1,icon:'ğŸ¯'},
  {id:'assault',name:'ASSAULT',col:'#FB7185',dmg:1,rate:.19,spd:680,spread:.10,maxAmmo:20,reload:1.6,pellets:1,range:1.4,tw:2, d:2,f:4,a:4,icon:'ğŸ”´'},
];
const GUN_ORDER = ['pistol','smg','shotgun','assault','sniper'];
const STREAK_NAMES = {2:'DOUBLE KILL!',3:'TRIPLE KILL!',4:'QUAD KILL!',5:'RAMPAGE!!',6:'UNSTOPPABLE!!!',7:'GODLIKE!!!!!'};
const POW_TYPES = [
  {id:'health',icon:'â¤ï¸', col:'#FF3131',label:'HEALTH BOOST'},
  {id:'speed', icon:'âš¡', col:'#FFE600',label:'SPEED BOOST'},
  {id:'damage',icon:'ğŸ”¥', col:'#F97316',label:'DAMAGE AMP'},
  {id:'shield',icon:'ğŸ›¡ï¸', col:'#00F5FF',label:'SHIELD'},
];
const BOT_NAMES = {
  red: ['REAPER','BLOODAX','VORTEX','INFERNO','RAGNAR'],
  blue:['SPECTER','PHANTOM_X','NOCTUA','CIPHER','WRAITH'],
  ffa: ['GHOST','RONIN','APEX','BLADE','ROGUE','CIPHER','VIPER','THORN'],
};
const MAP_THEMES = [
  {name:'INDUSTRIAL',floor:'#050a0a',grid:'rgba(255,140,0,.03)', wf:'#0a0e12',ws:'rgba(255,140,50,.28)',wa:'rgba(255,140,50,.75)',st:'rgba(255,100,0,.07)'},
  {name:'RUINS',     floor:'#080710',grid:'rgba(180,150,70,.03)',wf:'#0f0a06',ws:'rgba(190,140,60,.3)', wa:'rgba(210,170,80,.75)',st:'rgba(160,110,40,.07)'},
  {name:'BUNKER',    floor:'#040810',grid:'rgba(0,210,90,.03)',  wf:'#040a06',ws:'rgba(0,180,80,.27)',  wa:'rgba(0,220,100,.75)', st:'rgba(0,170,70,.07)'},
  {name:'VOID',      floor:'#050408',grid:'rgba(160,0,255,.03)', wf:'#0a0510',ws:'rgba(140,0,230,.3)',  wa:'rgba(170,0,255,.75)', st:'rgba(130,0,210,.07)'},
  {name:'NEON',      floor:'#060408',grid:'rgba(255,0,130,.03)', wf:'#0d0410',ws:'rgba(255,0,100,.27)', wa:'rgba(255,0,130,.75)', st:'rgba(210,0,95,.07)'},
];

// â”€â”€ MAP GENERATORS â”€â”€
const AW=1400,AH=800,SPAWN_C=210;
function genSymmetric(){return[{x:645,y:345,w:110,h:110},{x:295,y:140,w:85,h:170},{x:295,y:490,w:85,h:170},{x:AW-380,y:140,w:85,h:170},{x:AW-380,y:490,w:85,h:170},{x:490,y:65,w:130,h:65},{x:490,y:AH-130,w:130,h:65},{x:AW-620,y:65,w:130,h:65},{x:AW-620,y:AH-130,w:130,h:65}];}
function genCorridors(){return[{x:225,y:245,w:350,h:40},{x:825,y:245,w:350,h:40},{x:225,y:AH-285,w:350,h:40},{x:825,y:AH-285,w:350,h:40},{x:AW/2-35,y:150,w:70,h:165},{x:AW/2-35,y:AH-315,w:70,h:165},{x:AW/2-35,y:AH/2-35,w:70,h:70}];}
function genFortress(){return[{x:385,y:185,w:75,h:195},{x:385,y:185,w:195,h:75},{x:385,y:AH-380,w:75,h:195},{x:385,y:AH-260,w:195,h:75},{x:AW-460,y:185,w:75,h:195},{x:AW-580,y:185,w:195,h:75},{x:AW-460,y:AH-380,w:75,h:195},{x:AW-580,y:AH-260,w:195,h:75},{x:AW/2-45,y:AH/2-90,w:90,h:180}];}
function genOpen(){return[{x:AW/2-55,y:AH/2-55,w:110,h:110},{x:330,y:180,w:75,h:75},{x:330,y:AH-255,w:75,h:75},{x:AW-405,y:180,w:75,h:75},{x:AW-405,y:AH-255,w:75,h:75},{x:540,y:AH/2-38,w:95,h:76},{x:AW-635,y:AH/2-38,w:95,h:76}];}
function genMaze(){return[{x:310,y:0,w:60,h:280},{x:310,y:400,w:60,h:400},{x:AW-370,y:0,w:60,h:280},{x:AW-370,y:400,w:60,h:400},{x:560,y:160,w:60,h:280},{x:560,y:560,w:60,h:240},{x:AW-620,y:160,w:60,h:280},{x:AW-620,y:560,w:60,h:240},{x:AW/2-35,y:0,w:70,h:160},{x:AW/2-35,y:640,w:70,h:160}];}
function gen1v1(){return[
  {x:AW/2-55,y:AH/2-55,w:110,h:110},
  {x:AW/2-160,y:AH/2-160,w:55,h:55},{x:AW/2+105,y:AH/2-160,w:55,h:55},
  {x:AW/2-160,y:AH/2+105,w:55,h:55},{x:AW/2+105,y:AH/2+105,w:55,h:55},
  {x:AW/2-250,y:AH/2-25,w:70,h:50},{x:AW/2+180,y:AH/2-25,w:70,h:50},
  {x:AW/2-25,y:AH/2-220,w:50,h:70},{x:AW/2-25,y:AH/2+150,w:50,h:70},
];};
const GEN_FNS=[genSymmetric,genCorridors,genFortress,genOpen,genMaze];

function generateMap(){
  const theme=MAP_THEMES[Math.floor(Math.random()*MAP_THEMES.length)];
  const obstacles=chosenMode&&chosenMode.id==='1v1'?gen1v1():GEN_FNS[Math.floor(Math.random()*GEN_FNS.length)]();
  return {theme,obstacles};
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GAME STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let canvas,ctx,currentMap;
let entities=[],bullets=[],particles=[],powerups=[];
let flags={red:null,blue:null};
let kothScore={red:0,blue:0},ctfCaps={red:0,blue:0};
let ffaScore={};
let kills={red:0,blue:0};
let feedItems=[];
let player=null;
let chosenTeam=null,chosenSkin=null,chosenGun=null,chosenMode=null;
let playerName='PLAYER';
let running=false,lastTs=0;
let keys={},mouse={x:AW/2,y:AH/2},mousedown=false;
let shakeX=0,shakeY=0,shakeMag=0;
let scl=1,ox=0,oy=0;
let powupTimer=0,powupInterval=8;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  POWERUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
class Powerup {
  constructor(x,y,type){
    this.x=x;this.y=y;this.type=type;
    this.anim=Math.random()*Math.PI*2;
    this.dead=false;
  }
  draw(){
    const t=currentMap.theme,c=ctx;
    const bob=Math.sin(Date.now()*.002+this.anim)*4;
    c.save();c.translate(this.x,this.y+bob);
    c.shadowColor=this.type.col;c.shadowBlur=14;
    c.beginPath();c.arc(0,0,11,0,Math.PI*2);
    c.fillStyle='rgba(5,5,8,.9)';c.fill();
    c.strokeStyle=this.type.col;c.lineWidth=2;c.stroke();
    c.shadowBlur=0;
    c.font='12px sans-serif';c.textAlign='center';c.textBaseline='middle';
    c.fillText(this.type.icon,0,0);
    c.restore();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BULLET
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
class Bullet {
  constructor(x,y,angle,shooter,gd){
    this.x=x;this.y=y;this.px=x;this.py=y;
    this.shooter=shooter;this.team=shooter.team;
    this.dmg=gd.dmg*(shooter.powDamage?2:1);
    this.gunId=gd.id;this.spd=gd.spd;
    this.vx=Math.cos(angle)*this.spd;this.vy=Math.sin(angle)*this.spd;
    this.life=gd.range;this.col=gd.col;this.tw=gd.tw;this.dead=false;
  }
  update(dt){
    this.px=this.x;this.py=this.y;
    this.x+=this.vx*dt;this.y+=this.vy*dt;
    this.life-=dt;
    if(this.life<=0||this.x<-10||this.x>AW+10||this.y<-10||this.y>AH+10){this.dead=true;return;}
    for(const ob of currentMap.obstacles){
      if(this.x>ob.x&&this.x<ob.x+ob.w&&this.y>ob.y&&this.y<ob.y+ob.h){this.dead=true;spawnBurst(this.x,this.y,this.col,4);return;}
    }
    for(const e of entities){
      if(e===this.shooter||(chosenMode&&chosenMode.teams&&e.team===this.team)||e.dead) continue;
      if(Math.hypot(e.x-this.x,e.y-this.y)<15){
        e.takeDamage(this.shooter,this.dmg);
        this.dead=true;spawnBurst(this.x,this.y,this.col,10);
        shake(this.gunId==='sniper'?9:this.gunId==='shotgun'?7:3);
        return;
      }
    }
  }
  draw(){
    const a=Math.min(1,this.life*3);
    ctx.save();ctx.globalAlpha=a*.8;
    ctx.strokeStyle=this.col;ctx.lineWidth=this.tw;
    ctx.shadowColor=this.col;ctx.shadowBlur=this.gunId==='sniper'?12:5;
    ctx.beginPath();ctx.moveTo(this.px,this.py);ctx.lineTo(this.x,this.y);ctx.stroke();
    ctx.shadowBlur=14;ctx.fillStyle='#fff';
    ctx.beginPath();ctx.arc(this.x,this.y,this.tw,0,Math.PI*2);ctx.fill();
    ctx.restore();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PARTICLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
class Particle {
  constructor(x,y,col,big){
    this.x=x;this.y=y;this.col=col;
    const a=Math.random()*Math.PI*2,s=big?110+Math.random()*290:50+Math.random()*180;
    this.vx=Math.cos(a)*s;this.vy=Math.sin(a)*s;
    this.life=big?.4+Math.random()*.5:.2+Math.random()*.3;
    this.ml=this.life;this.r=big?2+Math.random()*5:1.5+Math.random()*3;
  }
  update(dt){this.x+=this.vx*dt;this.y+=this.vy*dt;this.vx*=.87;this.vy*=.87;this.life-=dt;}
  draw(){const a=Math.max(0,this.life/this.ml);ctx.globalAlpha=a;ctx.beginPath();ctx.arc(this.x,this.y,this.r*Math.sqrt(a),0,Math.PI*2);ctx.fillStyle=this.col;ctx.fill();ctx.globalAlpha=1;}
}
function spawnBurst(x,y,col,n,big=false){for(let i=0;i<n;i++)particles.push(new Particle(x,y,col,big));}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ENTITY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const RAD=15,MAX_HP=3,SWORD_R=68,SWORD_ARC=Math.PI*.68,ATK_DUR=.25,SWORD_CD=0.9;
const P_SPEED=250,B_SPEED=155,RESPAWN_S=3;

class Entity {
  constructor(x,y,team,name,isPlayer,skinId,gunId){
    this.x=x;this.y=y;this.team=team;this.name=name;this.isPlayer=!!isPlayer;
    this.skin=SKINS.find(s=>s.id===skinId)||SKINS[0];
    this.setGun(gunId||'pistol');
    this.hp=MAX_HP;this.dead=false;
    this.angle=team==='red'?.1:Math.PI-.1;
    this.vx=0;this.vy=0;
    this.speed=isPlayer?P_SPEED:B_SPEED;
    this.kills=0;this.deaths=0;this.score=0;
    this.hitFlash=0;this.streak=0;
    // Powerup buffs
    this.powSpeed=false;this.powSpeedTimer=0;
    this.powDamage=false;this.powDamageTimer=0;
    this.shield=0;
    // Melee
    this.attacking=false;this.atkAngle=0;this.atkTimer=0;this.atkCD=0;this.hitTargets=new Set();this.swordHits=0;
    // Gun game
    this.gunIndex=0;
    // CTF
    this.hasFlag=null;
    // Bot
    this.target=null;this.wanderAngle=Math.random()*Math.PI*2;this.wanderTimer=0;
    this.aggro=.4+Math.random()*.6;this.respawnTimer=0;this.botGunCD=0;
    this.stateTimer=0;this.state='chase';
  }
  setGun(id){
    this.gun=GUNS.find(g=>g.id===id)||GUNS[0];
    this.ammo=this.gun.maxAmmo;this.reloading=false;this.reloadTimer=0;this.fireCooldown=0;
  }
  get teamCol(){return this.team==='red'?'#FF3131':this.team==='blue'?'#1E90FF':'#FFE600';}
  get teamGlow(){return this.team==='red'?'rgba(255,49,49,.55)':this.team==='blue'?'rgba(30,144,255,.55)':'rgba(255,230,0,.55)';}
  
  respawn(){
    let x,y,safe=false,t=0;
    while(!safe&&t<40){
      if(chosenMode.id==='1v1'){
        x=AW/2+(Math.random()-.5)*300;
      } else if(chosenMode.teams){
        x=this.team==='red'?55+Math.random()*130:AW-55-Math.random()*130;
      } else {
        x=Math.random()<.5?55+Math.random()*130:AW-55-Math.random()*130;
      }
      y=80+Math.random()*(AH-160);
      safe=true;
      for(const ob of currentMap.obstacles)if(x>ob.x-RAD&&x<ob.x+ob.w+RAD&&y>ob.y-RAD&&y<ob.y+ob.h+RAD){safe=false;break;}
      t++;
    }
    this.x=x;this.y=y;
    this.hp=MAX_HP;this.dead=false;this.hitFlash=0;this.swordHits=0;
    this.ammo=this.gun.maxAmmo;this.reloading=false;this.reloadTimer=0;
    this.fireCooldown=0;this.atkCD=0;this.hitTargets.clear();
    this.respawnTimer=0;this.shield=0;
    if(this.hasFlag){this.hasFlag.carrier=null;this.hasFlag.dropped=true;this.hasFlag=null;}
    if(this.isPlayer){this.powSpeed=false;this.powDamage=false;}
  }

  takeDamage(attacker,dmg=1){
    if(this.dead)return;
    if(this.shield>0){this.shield=Math.max(0,this.shield-dmg);this.hitFlash=.15;spawnBurst(this.x,this.y,'#00F5FF',6);if(this.isPlayer)updHpHud();return;}
    this.hp=Math.max(0,this.hp-dmg);this.hitFlash=.2;
    if(this.hp<=0)this.die(attacker);
    else if(this.isPlayer)updHpHud();
  }

  die(attacker){
    this.dead=true;this.hp=0;this.deaths++;this.streak=0;
    this.respawnTimer=RESPAWN_S;
    spawnBurst(this.x,this.y,this.teamCol,28,true);
    spawnBurst(this.x,this.y,'#FFE600',8,true);
    if(this.hasFlag){
      const f=this.hasFlag;f.carrier=null;f.dead=false;
      f.dropped=true;f.x=this.x;f.y=this.y;f.dropTimer=8;
      this.hasFlag=null;
    }
    if(attacker){
      attacker.kills++;attacker.streak++;
      if(chosenMode.teams)kills[attacker.team]++;
      else ffaScore[attacker.name]=(ffaScore[attacker.name]||0)+1;
      attacker.score+=100;
      addFeed(attacker.name,this.name,attacker.team||'ffa');
      if(attacker.isPlayer||this.isPlayer)updStatsHud();
      if(attacker.isPlayer&&STREAK_NAMES[attacker.streak])showStreak(STREAK_NAMES[attacker.streak]);
      // Gun game: advance weapon
      if(chosenMode.id==='gun'){
        const ni=Math.min(GUN_ORDER.length-1,GUN_ORDER.indexOf(attacker.gun.id)+1);
        attacker.setGun(GUN_ORDER[ni]);
        if(attacker.isPlayer){updAmmoHud();updGunGameHud();}
        if(ni===GUN_ORDER.length-1&&attacker.kills>=1)checkWin();
      }
      checkWin();
    }
    shake(this.isPlayer?10:4);
  }

  reload(){if(this.reloading||this.ammo===this.gun.maxAmmo)return;this.reloading=true;this.reloadTimer=this.gun.reload;}
  
  shoot(angle){
    if(this.fireCooldown>0||this.reloading||this.ammo<=0||this.dead)return;
    for(let i=0;i<this.gun.pellets;i++){
      const spread=(Math.random()-.5)*this.gun.spread*2+(this.gun.pellets>1?(i-2)*.06:0);
      bullets.push(new Bullet(this.x,this.y,angle+spread,this,this.gun));
    }
    this.ammo--;this.fireCooldown=this.gun.rate;
    if(this.ammo===0)this.reload();
    if(this.isPlayer){updAmmoHud();shake(this.gun.id==='shotgun'?5:this.gun.id==='sniper'?4:1);}
  }

  startMelee(){if(this.atkCD>0||this.attacking||this.dead)return;this.attacking=true;this.atkAngle=this.angle;this.atkTimer=ATK_DUR;this.atkCD=SWORD_CD;this.hitTargets.clear();}
  
  checkMeleeHit(){
    for(const e of entities){
      if(e===this||(chosenMode&&chosenMode.teams&&e.team===this.team)||e.dead||this.hitTargets.has(e))continue;
      const dx=e.x-this.x,dy=e.y-this.y,d=Math.hypot(dx,dy);
      if(d>SWORD_R+RAD)continue;
      let diff=Math.atan2(dy,dx)-this.atkAngle;
      while(diff>Math.PI)diff-=Math.PI*2;while(diff<-Math.PI)diff+=Math.PI*2;
      if(Math.abs(diff)<=SWORD_ARC){this.hitTargets.add(e);spawnBurst(e.x,e.y,"rgba(255,220,50,.7)",4);if(e.shield>0){e.shield=Math.max(0,e.shield-1);e.hitFlash=.18;spawnBurst(e.x,e.y,"#00F5FF",6);if(e.isPlayer)updHpHud();}else{e.swordHits=(e.swordHits||0)+1;e.hitFlash=.2;if(e.swordHits>=2){e.swordHits=0;e.takeDamage(this,1);}else{shake(3);if(e.isPlayer)updHpHud();}}}
    }
  }

  updatePowerups(dt){
    if(this.powSpeed){this.powSpeedTimer-=dt;if(this.powSpeedTimer<=0){this.powSpeed=false;this.speed=this.isPlayer?P_SPEED:B_SPEED;}}
    if(this.powDamage){this.powDamageTimer-=dt;if(this.powDamageTimer<=0)this.powDamage=false;}
  }

  update(dt){
    this.updatePowerups(dt);
    if(this.hitFlash>0)this.hitFlash=Math.max(0,this.hitFlash-dt);
    if(this.fireCooldown>0)this.fireCooldown-=dt;
    if(this.atkCD>0)this.atkCD-=dt;
    if(this.reloading){this.reloadTimer-=dt;if(this.reloadTimer<=0){this.reloading=false;this.ammo=this.gun.maxAmmo;if(this.isPlayer)updAmmoHud();}}
    if(this.attacking){this.atkTimer-=dt;if(this.atkTimer<=0)this.attacking=false;else this.checkMeleeHit();}
    if(this.dead){
      this.respawnTimer-=dt;
      if(this.isPlayer)setRespawnUI(Math.ceil(this.respawnTimer));
      if(this.respawnTimer<=0){this.respawn();if(this.isPlayer)hideRespawnUI();}
      return;
    }
    this.isPlayer?this.upPlayer():this.upBot(dt);
    this.x+=this.vx*dt;this.y+=this.vy*dt;
    this.x=Math.max(RAD,Math.min(AW-RAD,this.x));
    this.y=Math.max(RAD,Math.min(AH-RAD,this.y));
    for(const ob of currentMap.obstacles)pushOut(this,ob);
    // Pick up powerups
    if(!this.dead){
      for(const p of powerups){
        if(p.dead)continue;
        if(Math.hypot(p.x-this.x,p.y-this.y)<20){
          p.dead=true;
          applyPowerup(this,p.type);
        }
      }
    }
    // CTF: pick up flag
    if(chosenMode.id==='ctf'&&!this.hasFlag){
      for(const team of['red','blue']){
        const f=flags[team];
        if(!f||f.carrier||f.dead)continue;
        if(f.team===this.team)continue;
        if(Math.hypot(f.x-this.x,f.y-this.y)<22){
          f.carrier=this;f.dropped=false;this.hasFlag=f;
          if(this.isPlayer)showPowBanner('ğŸš© FLAG GRABBED!');
          addFeed(this.name,'FLAG',this.team);
        }
      }
      // Cap flag at home base
      if(this.hasFlag){
        const homeX=this.team==='red'?SPAWN_C/2:AW-SPAWN_C/2;
        if(Math.abs(this.x-homeX)<80&&Math.abs(this.y-AH/2)<140){
          capFlag(this);
        }
      }
    }
  }

  upPlayer(){
    let dx=0,dy=0;
    if(keys['w']||keys['arrowup'])dy-=1;if(keys['s']||keys['arrowdown'])dy+=1;
    if(keys['a']||keys['arrowleft'])dx-=1;if(keys['d']||keys['arrowright'])dx+=1;
    const l=Math.hypot(dx,dy);if(l>0){dx/=l;dy/=l;}
    const spd=this.speed*(this.powSpeed?1.55:1);
    this.vx=dx*spd;this.vy=dy*spd;
    const wx=(mouse.x-ox)/scl,wy=(mouse.y-oy)/scl;
    this.angle=Math.atan2(wy-this.y,wx-this.x);
    // Auto shoot if holding mouse
    if(mousedown)this.shoot(this.angle);
  }

  upBot(dt){
    // â”€â”€ Target selection: always know where the player is â”€â”€
    if(!this.target||this.target.dead){
      this.target=null;
      const playerEnt=entities.find(e=>e.isPlayer&&!e.dead&&(!chosenMode||!chosenMode.teams||e.team!==this.team));
      if(playerEnt){this.target=playerEnt;}
      else{
        let best=Infinity;
        for(const e of entities){
          if(e===this)continue;
          if(chosenMode&&chosenMode.teams&&e.team===this.team)continue;
          if(e.dead)continue;
          const d=Math.hypot(e.x-this.x,e.y-this.y);
          if(d<best){best=d;this.target=e;}
        }
      }
    }

    // â”€â”€ Obstacle + edge avoidance steering â”€â”€
    const AVOID_R=70;
    let avoidX=0,avoidY=0;
    // Map edges
    const edgePush=55;
    if(this.x<edgePush)avoidX+=(edgePush-this.x)/edgePush;
    if(this.x>AW-edgePush)avoidX-=(this.x-(AW-edgePush))/edgePush;
    if(this.y<edgePush)avoidY+=(edgePush-this.y)/edgePush;
    if(this.y>AH-edgePush)avoidY-=(this.y-(AH-edgePush))/edgePush;
    // Obstacles
    for(const ob of currentMap.obstacles){
      const cx=Math.max(ob.x,Math.min(ob.x+ob.w,this.x));
      const cy=Math.max(ob.y,Math.min(ob.y+ob.h,this.y));
      const dx=this.x-cx,dy=this.y-cy,dist=Math.hypot(dx,dy);
      if(dist<AVOID_R&&dist>0){
        const str=(AVOID_R-dist)/AVOID_R;
        avoidX+=dx/dist*str*2.2;
        avoidY+=dy/dist*str*2.2;
      }
    }
    const avoidLen=Math.hypot(avoidX,avoidY);
    if(avoidLen>1){avoidX/=avoidLen;avoidY/=avoidLen;}

    // â”€â”€ Stuck detection: if barely moved for 0.6s, force new wander â”€â”€
    if(!this._lastX)this._lastX=this.x;
    if(!this._lastY)this._lastY=this.y;
    this._stuckTimer=(this._stuckTimer||0)+dt;
    if(this._stuckTimer>0.6){
      const moved=Math.hypot(this.x-this._lastX,this.y-this._lastY);
      if(moved<8){this.wanderAngle=Math.random()*Math.PI*2;this._forcedWander=.7;}
      this._lastX=this.x;this._lastY=this.y;this._stuckTimer=0;
    }
    if(this._forcedWander>0){
      this._forcedWander-=dt;
      const spd=this.speed*(this.powSpeed?1.55:1);
      this.vx=Math.cos(this.wanderAngle)*spd+avoidX*spd;
      this.vy=Math.sin(this.wanderAngle)*spd+avoidY*spd;
      this.angle=this.wanderAngle;
      return;
    }

    if(!this.target){
      this.wanderTimer-=dt;
      if(this.wanderTimer<=0){this.wanderAngle=(Math.random()-.5)*Math.PI*2;this.wanderTimer=.5+Math.random()*.8;}
      const spd=this.speed*(this.powSpeed?1.55:1)*.5;
      this.vx=Math.cos(this.wanderAngle)*spd+avoidX*spd;
      this.vy=Math.sin(this.wanderAngle)*spd+avoidY*spd;
      this.angle=Math.atan2(this.vy,this.vx);
      return;
    }

    const tx=this.target.x,ty=this.target.y;
    const d=Math.hypot(tx-this.x,ty-this.y);
    const toT=Math.atan2(ty-this.y,tx-this.x);

    // Blend avoid into chase direction
    const chaseX=Math.cos(toT),chaseY=Math.sin(toT);
    const avoidWeight=Math.min(1,avoidLen*1.4);
    const blendX=chaseX*(1-avoidWeight)+avoidX*avoidWeight;
    const blendY=chaseY*(1-avoidWeight)+avoidY*avoidWeight;
    const blendAngle=Math.atan2(blendY,blendX);

    this.angle=toT; // face target regardless of movement dir
    this.stateTimer-=dt;
    if(this.stateTimer<=0){
      if(this.hp<=1&&d>120)this.state='retreat';
      else if(d<SWORD_R+22)this.state='strafe';
      else this.state='chase';
      this.stateTimer=.35+Math.random()*.5;
    }

    // Shoot
    this.botGunCD-=dt;
    if(d>90&&d<900&&!this.reloading&&this.ammo>0&&this.botGunCD<=0){
      const lead=d/this.gun.spd;
      const aimX=tx+this.target.vx*lead,aimY=ty+this.target.vy*lead;
      const aimA=Math.atan2(aimY-this.y,aimX-this.x);
      const inaccuracy=.25*(1-this.aggro);
      this.shoot(aimA+(Math.random()-.5)*inaccuracy);
      this.botGunCD=this.gun.rate*(1+Math.random()*.4);
    }
    if(d<SWORD_R+8)this.startMelee();

    const sdir=((this.kills+this.deaths)%2===0?1:-1);
    const spd=this.speed*(this.powSpeed?1.55:1);
    switch(this.state){
      case'chase':
        this.vx=Math.cos(blendAngle)*spd;
        this.vy=Math.sin(blendAngle)*spd;
        break;
      case'strafe':{
        const st=toT+Math.PI/2*sdir;
        const sx=Math.cos(st)*(1-avoidWeight)+avoidX*avoidWeight;
        const sy=Math.sin(st)*(1-avoidWeight)+avoidY*avoidWeight;
        this.vx=sx*spd*.85;this.vy=sy*spd*.85;
        break;
      }
      case'retreat':
        this.vx=(-chaseX*(1-avoidWeight*0.5)+avoidX*avoidWeight*0.5)*spd*.9;
        this.vy=(-chaseY*(1-avoidWeight*0.5)+avoidY*avoidWeight*0.5)*spd*.9;
        break;
    }
  }

  draw(){
    if(this.dead)return;
    const c=ctx;
    c.save();c.translate(this.x,this.y);
    // Melee arc
    if(this.attacking){
      const t=this.atkTimer/ATK_DUR,arcEnd=this.atkAngle-SWORD_ARC+(1-t)*SWORD_ARC*2;
      c.beginPath();c.moveTo(0,0);c.arc(0,0,SWORD_R,this.atkAngle-SWORD_ARC,arcEnd);c.closePath();
      c.fillStyle=this.team==='red'?'rgba(255,49,49,.17)':'rgba(30,144,255,.17)';c.fill();
      c.strokeStyle=this.team==='red'?'rgba(255,49,49,.5)':'rgba(30,144,255,.5)';c.lineWidth=1;c.stroke();
    }
    // Glow
    c.shadowColor=this.isPlayer?this.skin.glowCol:this.teamGlow;c.shadowBlur=this.isPlayer?28:12;
    // Body
    c.beginPath();c.arc(0,0,RAD,0,Math.PI*2);
    c.fillStyle=this.hitFlash>0?'#fff':this.teamCol;
    if(this.hitFlash>0)c.globalAlpha=.55+this.hitFlash*2.5;
    c.fill();c.globalAlpha=1;c.shadowBlur=0;
    // Inner skin
    c.beginPath();c.arc(0,0,RAD*.7,0,Math.PI*2);c.fillStyle=this.skin.bodyCol;c.fill();
    this.drawSkin(c);
    // Shield ring
    if(this.shield>0){
      c.beginPath();c.arc(0,0,RAD+7,0,Math.PI*2);
      c.strokeStyle='rgba(0,245,255,.7)';c.lineWidth=2.5;
      c.shadowColor='#00F5FF';c.shadowBlur=10;c.stroke();c.shadowBlur=0;
    }
    // Player ring
    if(this.isPlayer){c.beginPath();c.arc(0,0,RAD+5,0,Math.PI*2);c.strokeStyle='rgba(255,230,0,.8)';c.lineWidth=2;c.stroke();}
    // Speed trail
    if(this.powSpeed&&(Math.abs(this.vx)+Math.abs(this.vy))>50){
      c.save();c.globalAlpha=.3;c.fillStyle='#FFE600';
      c.beginPath();c.arc(-Math.cos(this.angle)*12,-Math.sin(this.angle)*12,RAD*.5,0,Math.PI*2);c.fill();
      c.restore();
    }
    // Sword
    const sa=this.attacking?this.atkAngle-SWORD_ARC+(1-this.atkTimer/ATK_DUR)*SWORD_ARC*2:this.angle;
    c.save();c.rotate(sa);
    c.shadowColor=this.attacking?'rgba(255,230,0,.85)':'transparent';c.shadowBlur=this.attacking?12:0;
    c.beginPath();c.moveTo(RAD-1,-1.5);c.lineTo(SWORD_R*.85,0);
    c.strokeStyle=this.attacking?'#FFE600':'rgba(210,215,230,.8)';c.lineWidth=this.attacking?3:2;c.stroke();
    c.beginPath();c.moveTo(RAD+9,-7);c.lineTo(RAD+9,7);
    c.strokeStyle=this.attacking?'rgba(255,230,0,.9)':'rgba(190,195,220,.7)';c.lineWidth=2.5;c.stroke();
    c.shadowBlur=0;c.restore();
    // Direction dot
    c.beginPath();c.arc(Math.cos(this.angle)*(RAD+4),Math.sin(this.angle)*(RAD+4),2.5,0,Math.PI*2);c.fillStyle='rgba(255,255,255,.9)';c.fill();
    // CTF flag
    if(this.hasFlag){
      c.save();c.translate(0,-RAD-12);
      c.fillStyle=this.hasFlag.team==='red'?'#FF3131':'#1E90FF';
      c.font='14px sans-serif';c.textAlign='center';c.fillText('ğŸš©',0,0);
      c.restore();
    }
    c.restore();
    // HP bar
    const bw=36,bh=4,bx=this.x-bw/2,by=this.y-RAD-13;
    c.fillStyle='rgba(0,0,0,.65)';c.fillRect(bx-1,by-1,bw+2,bh+2);
    c.fillStyle=this.hp===1?'#FF3131':this.teamCol;c.fillRect(bx,by,bw*(this.hp/MAX_HP),bh);
    // Name
    c.font=this.isPlayer?'bold 11px Barlow Condensed,sans-serif':'700 9px Barlow Condensed,sans-serif';
    c.textAlign='center';c.fillStyle=this.isPlayer?'rgba(255,230,0,.95)':'rgba(200,210,230,.6)';
    c.fillText(this.isPlayer?'â–¶ YOU':this.name,this.x,this.y-RAD-18);
  }

  drawSkin(c){
    c.save();
    switch(this.skin.shape){
      case'rings':c.beginPath();c.arc(0,0,RAD*.48,0,Math.PI*2);c.strokeStyle=this.skin.accCol+'bb';c.lineWidth=1.5;c.stroke();c.beginPath();c.arc(0,0,RAD*.22,0,Math.PI*2);c.fillStyle=this.skin.accCol;c.fill();break;
      case'eyes':[-5,5].forEach(ex=>{c.beginPath();c.arc(ex,-1.5,3,0,Math.PI*2);c.shadowColor='#FF0000';c.shadowBlur=7;c.fillStyle='#FF0000';c.fill();c.shadowBlur=0;});break;
      case'soft':c.beginPath();c.arc(0,0,RAD*.45,0,Math.PI*2);c.fillStyle='rgba(255,255,255,.18)';c.fill();[-5,5].forEach(ex=>{c.beginPath();c.arc(ex,0,2,0,Math.PI*2);c.fillStyle='rgba(255,255,255,.9)';c.fill();});break;
      case'fire':for(let i=0;i<8;i++){const a=(i/8)*Math.PI*2+Date.now()*.004;c.beginPath();c.arc(Math.cos(a)*RAD*.4,Math.sin(a)*RAD*.4,2,0,Math.PI*2);c.fillStyle=i%2===0?'#FF6600':'#FFD700';c.fill();}c.beginPath();c.arc(0,0,RAD*.18,0,Math.PI*2);c.fillStyle='#FFD700';c.fill();break;
      case'cross':c.beginPath();c.moveTo(-RAD*.42,0);c.lineTo(RAD*.42,0);c.moveTo(0,-RAD*.42);c.lineTo(0,RAD*.42);c.strokeStyle=this.skin.accCol;c.lineWidth=2.5;c.shadowColor=this.skin.accCol;c.shadowBlur=5;c.stroke();c.shadowBlur=0;c.beginPath();c.arc(0,0,3.5,0,Math.PI*2);c.fillStyle=this.skin.accCol;c.fill();break;
      case'zap':c.beginPath();c.moveTo(-RAD*.32,-RAD*.32);c.lineTo(RAD*.08,0);c.lineTo(-RAD*.15,RAD*.32);c.strokeStyle=this.skin.accCol;c.lineWidth=2.2;c.shadowColor=this.skin.accCol;c.shadowBlur=6;c.stroke();c.shadowBlur=0;break;
    }
    c.restore();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FLAG (CTF)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
class Flag {
  constructor(team){
    this.team=team;
    this.homeX=team==='red'?SPAWN_C/2:AW-SPAWN_C/2;
    this.homeY=AH/2;
    this.x=this.homeX;this.y=this.homeY;
    this.carrier=null;this.dropped=false;this.dropTimer=0;this.dead=false;
  }
  update(dt){
    if(this.dropped){
      this.dropTimer-=dt;
      if(this.dropTimer<=0){this.x=this.homeX;this.y=this.homeY;this.dropped=false;}
    }
    if(this.carrier){this.x=this.carrier.x;this.y=this.carrier.y;}
  }
  draw(){
    if(this.carrier)return;
    const c=ctx,bob=Math.sin(Date.now()*.002)*5;
    c.save();c.translate(this.x,this.y+bob-15);
    c.shadowColor=this.team==='red'?'#FF3131':'#1E90FF';c.shadowBlur=16;
    c.font='22px sans-serif';c.textAlign='center';c.textBaseline='middle';
    c.fillText(this.team==='red'?'ğŸš©':'ğŸ³',0,0);
    c.restore();
    // Base indicator
    c.save();c.translate(this.homeX,this.homeY);
    c.beginPath();c.arc(0,0,28,0,Math.PI*2);
    c.strokeStyle=(this.team==='red'?'rgba(255,49,49,.3)':'rgba(30,144,255,.3)');
    c.setLineDash([6,6]);c.lineWidth=2;c.stroke();c.setLineDash([]);
    c.restore();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function pushOut(e,r){
  const cx=Math.max(r.x,Math.min(r.x+r.w,e.x)),cy=Math.max(r.y,Math.min(r.y+r.h,e.y));
  const dx=e.x-cx,dy=e.y-cy,d=Math.hypot(dx,dy);
  if(d===0){e.x=r.x+r.w/2;}else if(d<RAD){const ov=RAD-d;e.x+=(dx/d)*ov;e.y+=(dy/d)*ov;}
}
function resolveCollisions(){
  for(let i=0;i<entities.length;i++){for(let j=i+1;j<entities.length;j++){
    const a=entities[i],b=entities[j];if(a.dead||b.dead)continue;
    const dx=b.x-a.x,dy=b.y-a.y,d=Math.hypot(dx,dy),min=RAD*2;
    if(d<min&&d>0){const p=(min-d)/2;a.x-=(dx/d)*p;a.y-=(dy/d)*p;b.x+=(dx/d)*p;b.y+=(dy/d)*p;}
  }}
}
function shake(mag){shakeMag=Math.max(shakeMag,mag);}

function applyPowerup(e,type){
  switch(type.id){
    case'health':if(e.hp<MAX_HP){e.hp=Math.min(MAX_HP,e.hp+1);if(e.isPlayer)updHpHud();}break;
    case'speed':e.powSpeed=true;e.powSpeedTimer=5;e.speed=(e.isPlayer?P_SPEED:B_SPEED)*1.55;break;
    case'damage':e.powDamage=true;e.powDamageTimer=5;break;
    case'shield':e.shield=2;break;
  }
  if(e.isPlayer){
    showPowBanner(type.label+'!');
    updHpHud();updPowHud();
  }
}

function capFlag(carrier){
  const f=carrier.hasFlag;
  ctfCaps[carrier.team]++;
  carrier.score+=300;
  f.x=f.homeX;f.y=f.homeY;f.dropped=false;f.carrier=null;carrier.hasFlag=null;
  addFeed(carrier.name,'FLAG CAP',carrier.team);
  updCtfHud();checkWin();
  shake(12);
  spawnBurst(carrier.x,carrier.y,carrier.team==='red'?'#FF3131':'#1E90FF',35,true);
}

function spawnRandomPowerup(){
  let x,y,safe=false,t=0;
  while(!safe&&t<30){
    x=SPAWN_C+30+Math.random()*(AW-SPAWN_C*2-60);
    y=60+Math.random()*(AH-120);
    safe=true;
    for(const ob of currentMap.obstacles){if(x>ob.x-20&&x<ob.x+ob.w+20&&y>ob.y-20&&y<ob.y+ob.h+20){safe=false;break;}}
    t++;
  }
  const type=POW_TYPES[Math.floor(Math.random()*POW_TYPES.length)];
  powerups.push(new Powerup(x,y,type));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  KOTH ZONE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateKOTH(dt){
  const zx=AW/2,zy=AH/2,zr=85;
  let inZone={red:0,blue:0};
  for(const e of entities){
    if(e.dead)continue;
    if(Math.hypot(e.x-zx,e.y-zy)<zr)inZone[e.team]=(inZone[e.team]||0)+1;
  }
  const winner=inZone.red>inZone.blue?'red':inZone.blue>inZone.red?'blue':null;
  if(winner){
    kothScore[winner]+=dt;
    updKothHud();
    checkWin();
  }
}
function drawKothZone(){
  const c=ctx,zx=AW/2,zy=AH/2,zr=85;
  c.save();
  c.beginPath();c.arc(zx,zy,zr,0,Math.PI*2);
  c.fillStyle='rgba(255,230,0,.04)';c.fill();
  c.strokeStyle='rgba(255,230,0,.35)';c.lineWidth=2;c.setLineDash([10,8]);c.stroke();c.setLineDash([]);
  c.font='bold 9px Barlow Condensed,sans-serif';c.textAlign='center';c.fillStyle='rgba(255,230,0,.35)';c.fillText('KING OF THE HILL',zx,zy+zr+14);
  c.restore();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HUD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updScoreHud(){
  const m=chosenMode;
  if(m.id==='tdm'){
    document.getElementById('sr').textContent=kills.red;
    document.getElementById('sb2').textContent=kills.blue;
    document.getElementById('sr').className='sn2 red';
    document.getElementById('sb2').className='sn2 blue';
    document.getElementById('ssep').innerHTML='KILLS<br>TO '+m.target;
  }else if(m.id==='ffa'){
    const top=Object.entries(ffaScore).sort((a,b)=>b[1]-a[1])[0];
    document.getElementById('sr').textContent=top?top[1]:0;
    document.getElementById('sb2').textContent=m.target;
    document.getElementById('sr').className='sn2 ffa';
    document.getElementById('sb2').className='sn2 ffa';
    document.getElementById('ssep').innerHTML='LEAD<br>TO WIN';
  }else if(m.id==='koth'){
    document.getElementById('sr').textContent=Math.floor(kothScore.red)+'s';
    document.getElementById('sb2').textContent=Math.floor(kothScore.blue)+'s';
    document.getElementById('sr').className='sn2 red';
    document.getElementById('sb2').className='sn2 blue';
    document.getElementById('ssep').innerHTML='ZONE<br>'+m.target+'s';
  }else if(m.id==='ctf'){
    document.getElementById('sr').textContent=ctfCaps.red;
    document.getElementById('sb2').textContent=ctfCaps.blue;
    document.getElementById('sr').className='sn2 red';
    document.getElementById('sb2').className='sn2 blue';
    document.getElementById('ssep').innerHTML='CAPS<br>TO '+m.target;
  }else if(m.id==='gun'){
    const gi=GUN_ORDER.indexOf(player?player.gun.id:'pistol');
    document.getElementById('sr').textContent=gi+1;
    document.getElementById('sb2').textContent=GUN_ORDER.length;
    document.getElementById('sr').className='sn2 ffa';
    document.getElementById('sb2').className='sn2 ffa';
    document.getElementById('ssep').innerHTML='WEAPON<br>TIER';
  }
}
function updStatsHud(){
  if(!player)return;
  document.getElementById('mk').textContent=player.kills;
  document.getElementById('md').textContent=player.deaths;
  document.getElementById('ms').textContent=player.streak;
}
function updHpHud(){
  if(!player)return;
  for(let i=1;i<=3;i++)document.getElementById('h'+i).classList.toggle('e',i>player.hp);
  const sd=document.getElementById('shield-display');
  sd.innerHTML=player.shield>0?'ğŸ›¡ï¸'.repeat(player.shield):'';
}
function updAmmoHud(){
  if(!player)return;
  const g=player.gun;
  document.getElementById('hgname').textContent=g.name;
  document.getElementById('hgname').style.color=g.col;
  const bp=document.getElementById('hbullets');bp.innerHTML='';
  const max=Math.min(g.maxAmmo,30);
  for(let i=0;i<max;i++){
    const d=document.createElement('div');d.className='bpip';
    d.style.background=i<player.ammo?g.col:'rgba(255,255,255,.1)';
    d.style.height=g.id==='sniper'?'13px':'9px';
    bp.appendChild(d);
  }
  document.getElementById('hreload').style.display=player.reloading?'block':'none';
}
function updPowHud(){
  if(!player)return;
  const hp=document.getElementById('hpow');hp.innerHTML='';
  if(player.powSpeed){const s=document.createElement('span');s.className='pow-pip';s.title='Speed Boost';s.textContent='âš¡';hp.appendChild(s);}
  if(player.powDamage){const s=document.createElement('span');s.className='pow-pip';s.title='Damage Amp';s.textContent='ğŸ”¥';hp.appendChild(s);}
}
function updGunGameHud(){
  if(chosenMode.id!=='gun')return;
  const gi=GUN_ORDER.indexOf(player.gun.id);
  const el=document.getElementById('hgun');
  el.style.display='block';
  el.textContent=`WEAPON ${gi+1}/${GUN_ORDER.length}: ${player.gun.name}`;
  el.style.color=player.gun.col;
  updScoreHud();
}
function updKothHud(){
  document.getElementById('kr-s').textContent=Math.floor(kothScore.red)+'s';
  document.getElementById('kb-s').textContent=Math.floor(kothScore.blue)+'s';
  const t=chosenMode.target;
  document.getElementById('kr-fill').style.width=(kothScore.red/t*100).toFixed(1)+'%';
  document.getElementById('kb-fill').style.width=(kothScore.blue/t*100).toFixed(1)+'%';
  updScoreHud();
}
function updCtfHud(){
  document.getElementById('ctf-r').textContent=ctfCaps.red;
  document.getElementById('ctf-b').textContent=ctfCaps.blue;
  updScoreHud();
}
function addFeed(killer,victim,team){
  feedItems.unshift({killer,victim,team,life:4.5});
  if(feedItems.length>5)feedItems.pop();
  document.getElementById('hfeed').innerHTML=feedItems.map(k=>
    `<div class="kf ${k.team}"><span class="kk">${k.killer.slice(0,9)}</span><span class="ksep"> âš” </span><span class="kv">${k.victim.slice(0,9)}</span></div>`
  ).join('');
}
function setRespawnUI(n){document.getElementById('hrespawn').classList.add('show');document.getElementById('rsc').textContent=Math.max(0,n);}
function hideRespawnUI(){document.getElementById('hrespawn').classList.remove('show');}

let streakTimeout;
function showStreak(txt){
  clearTimeout(streakTimeout);
  document.getElementById('sb-text').textContent=txt;
  const b=document.getElementById('streak-banner');b.classList.remove('show');
  void b.offsetWidth;b.classList.add('show');
  streakTimeout=setTimeout(()=>b.classList.remove('show'),2200);
}
let powBannerTO;
function showPowBanner(txt){
  clearTimeout(powBannerTO);
  document.getElementById('pb-text').textContent=txt;
  const b=document.getElementById('pow-banner');b.classList.remove('show');
  void b.offsetWidth;b.classList.add('show');
  powBannerTO=setTimeout(()=>b.classList.remove('show'),1800);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  WIN CHECK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function checkWin(){
  const m=chosenMode,t=m.target;
  if(m.id==='tdm')     {if(kills.red>=t)endRound('RED TEAM',kills.red>kills.blue?'red':'blue');else if(kills.blue>=t)endRound('BLUE TEAM','blue');}
  else if(m.id==='ffa'){const top=Object.entries(ffaScore).sort((a,b)=>b[1]-a[1])[0];if(top&&top[1]>=t)endRound(top[0]+' WINS','ffa');}
  else if(m.id==='koth'){if(kothScore.red>=t)endRound('RED TEAM','red');else if(kothScore.blue>=t)endRound('BLUE TEAM','blue');}
  else if(m.id==='ctf'){if(ctfCaps.red>=t)endRound('RED TEAM','red');else if(ctfCaps.blue>=t)endRound('BLUE TEAM','blue');}
  else if(m.id==='gun'){
    const gi=GUN_ORDER.indexOf(player.gun.id);
    if(gi===GUN_ORDER.length-1&&player.kills>0)endRound(player.name+' WINS','you');
    for(const e of entities){
      if(e===player||e.dead)continue;
      const egi=GUN_ORDER.indexOf(e.gun.id);
      if(egi===GUN_ORDER.length-1&&e.kills>0)endRound(e.name+' WINS',e.team);
    }
  }
}

function endRound(winnerText, winnerTeam){
  running=false;
  const won=winnerTeam==='you'||(chosenMode.teams&&winnerTeam===chosenTeam)||(chosenMode.id==='ffa'&&winnerText.startsWith(playerName));
  const fl=document.getElementById('flash');
  fl.style.background=won?'rgba(255,230,0,.14)':'rgba(255,49,49,.14)';
  fl.style.opacity='1';
  setTimeout(()=>{fl.style.opacity='0';},700);
  setTimeout(()=>{
    const et=document.getElementById('et');
    et.textContent=won?'ğŸ† VICTORY! '+winnerText:winnerText+' WINS!';
    et.className='ewt '+(won?'you':winnerTeam==='ffa'?'ffa':winnerTeam);
    document.getElementById('es').textContent=chosenMode.name+' â€” ROUND OVER';
    buildScoreboard();
    showScreen('s-end');
  },850);
}

function buildScoreboard(){
  const all=[...entities].sort((a,b)=>b.score-a.score);
  const tb=document.getElementById('sb-body');tb.innerHTML='';
  all.forEach((e,i)=>{
    const kd=e.deaths>0?(e.kills/e.deaths).toFixed(2):e.kills+'.00';
    const tr=document.createElement('tr');
    if(e.isPlayer)tr.className='highlight';
    const teamLabel=e.team==='red'?`<span class="sb-team-r">RED</span>`:`<span class="sb-team-b">BLUE</span>`;
    tr.innerHTML=`<td>${i===0?'ğŸ‘‘':'#'+(i+1)}</td><td>${e.isPlayer?'<b>'+e.name+' â—€</b>':e.name}</td><td>${chosenMode.teams?teamLabel:'FFA'}</td><td class="sb-k">${e.kills}</td><td>${e.deaths}</td><td class="sb-kd">${kd}</td><td class="sb-win">${e.score.toLocaleString()}</td>`;
    tb.appendChild(tr);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ARENA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawArena(){
  const t=currentMap.theme,c=ctx;
  c.fillStyle=t.floor;c.fillRect(0,0,AW,AH);
  c.strokeStyle=t.grid;c.lineWidth=1;
  for(let x=0;x<=AW;x+=55){c.beginPath();c.moveTo(x,0);c.lineTo(x,AH);c.stroke();}
  for(let y=0;y<=AH;y+=55){c.beginPath();c.moveTo(0,y);c.lineTo(AW,y);c.stroke();}
  c.strokeStyle=t.wa;c.lineWidth=2.5;c.strokeRect(3,3,AW-6,AH-6);
  const cs=22,bpts=[[0,0,1,1],[AW,0,-1,1],[0,AH,1,-1],[AW,AH,-1,-1]];
  c.strokeStyle=t.wa;c.lineWidth=2.5;
  bpts.forEach(([bx,by,sx,sy])=>{c.beginPath();c.moveTo(bx+sx*cs,by);c.lineTo(bx,by);c.lineTo(bx,by+sy*cs);c.stroke();});
  c.fillStyle='rgba(255,49,49,.04)';c.fillRect(0,0,SPAWN_C,AH);
  c.fillStyle='rgba(30,144,255,.04)';c.fillRect(AW-SPAWN_C,0,SPAWN_C,AH);
  c.setLineDash([8,10]);
  c.strokeStyle='rgba(255,49,49,.12)';c.lineWidth=1;c.beginPath();c.moveTo(SPAWN_C,0);c.lineTo(SPAWN_C,AH);c.stroke();
  c.strokeStyle='rgba(30,144,255,.12)';c.beginPath();c.moveTo(AW-SPAWN_C,0);c.lineTo(AW-SPAWN_C,AH);c.stroke();
  c.setLineDash([]);
  c.font='bold 10px Barlow Condensed,sans-serif';c.textAlign='center';
  c.fillStyle='rgba(255,49,49,.22)';c.fillText('RED SPAWN',SPAWN_C/2,24);
  c.fillStyle='rgba(30,144,255,.22)';c.fillText('BLUE SPAWN',AW-SPAWN_C/2,24);
  c.save();c.globalAlpha=.022;c.font='bold 200px Barlow Condensed,sans-serif';c.textAlign='center';c.fillStyle='#fff';c.fillText('RIVALS',AW/2,AH/2+65);c.restore();
  for(const ob of currentMap.obstacles){
    c.fillStyle=t.wf;c.fillRect(ob.x,ob.y,ob.w,ob.h);
    c.strokeStyle=t.ws;c.lineWidth=2;c.strokeRect(ob.x,ob.y,ob.w,ob.h);
    c.save();c.beginPath();c.rect(ob.x,ob.y,ob.w,ob.h);c.clip();
    c.strokeStyle=t.st;c.lineWidth=1;
    for(let dd=-ob.h;dd<ob.w+ob.h;dd+=18){c.beginPath();c.moveTo(ob.x+dd,ob.y);c.lineTo(ob.x+dd+ob.h,ob.y+ob.h);c.stroke();}
    c.restore();
    const cs2=9;c.strokeStyle=t.wa;c.lineWidth=2;
    [[ob.x,ob.y,1,1],[ob.x+ob.w,ob.y,-1,1],[ob.x,ob.y+ob.h,1,-1],[ob.x+ob.w,ob.y+ob.h,-1,-1]].forEach(([bx,by,sx,sy])=>{c.beginPath();c.moveTo(bx+sx*cs2,by);c.lineTo(bx,by);c.lineTo(bx,by+sy*cs2);c.stroke();});
  }
  if(chosenMode.id==='koth')drawKothZone();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MAIN LOOP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loop(ts){
  if(!running)return;
  const dt=Math.min((ts-lastTs)/1000,.065);lastTs=ts;
  feedItems=feedItems.filter(f=>{f.life-=dt;return f.life>0;});
  if(shakeMag>.12){shakeX=(Math.random()-.5)*shakeMag*2;shakeY=(Math.random()-.5)*shakeMag*2;shakeMag*=.78;}else{shakeX=0;shakeY=0;shakeMag=0;}
  // Powerup spawn
  powupTimer+=dt;if(powupTimer>=powupInterval){powupTimer=0;if(powerups.filter(p=>!p.dead).length<4)spawnRandomPowerup();}
  powerups=powerups.filter(p=>!p.dead);
  for(const e of entities)e.update(dt);
  resolveCollisions();
  bullets=bullets.filter(b=>{if(b.dead)return false;b.update(dt);return !b.dead;});
  particles=particles.filter(p=>p.life>0);for(const p of particles)p.update(dt);
  if(chosenMode.id==='koth')updateKOTH(dt);
  if(chosenMode.id==='ctf'){for(const t of['red','blue'])if(flags[t])flags[t].update(dt);}
  if(player&&!player.dead){updStatsHud();updPowHud();}
  updScoreHud();
  render();
  requestAnimationFrame(loop);
}

function render(){
  scl=Math.min(canvas.width/AW,canvas.height/AH);
  ox=(canvas.width-AW*scl)/2;oy=(canvas.height-AH*scl)/2;
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle='#000';ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.save();ctx.translate(ox+shakeX,oy+shakeY);ctx.scale(scl,scl);
  drawArena();
  for(const p of powerups)if(!p.dead)p.draw();
  if(chosenMode.id==='ctf'){for(const t of['red','blue'])if(flags[t])flags[t].draw();}
  for(const p of particles)p.draw();
  for(const b of bullets)b.draw();
  for(const e of entities)e.draw();
  ctx.restore();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GAME INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initGame(){
  currentMap=generateMap();
  document.getElementById('mapname').textContent=currentMap.theme.name;
  document.getElementById('hmode').textContent=chosenMode.icon+' '+chosenMode.name;
  entities=[];bullets=[];particles=[];powerups=[];
  kills={red:0,blue:0};kothScore={red:0,blue:0};ctfCaps={red:0,blue:0};ffaScore={};
  feedItems=[];
  document.getElementById('hfeed').innerHTML='';
  hideRespawnUI();
  powupTimer=0;
  // Show mode-specific HUD elements
  document.getElementById('koth-bar').classList.toggle('show',chosenMode.id==='koth');
  document.getElementById('ctf-hud').classList.toggle('show',chosenMode.id==='ctf');
  document.getElementById('hgun').style.display=chosenMode.id==='gun'?'block':'none';

  const sp=(t)=>t==='red'?55+Math.random()*130:AW-55-Math.random()*130;
  const isFFA=!chosenMode.teams;
  const eTeam=chosenTeam==='red'?'blue':'red';

  // Player
  const initGun=chosenMode.id==='gun'?'pistol':chosenGun;
  const p1v1x=chosenMode.id==='1v1'?AW/2-200:sp(chosenTeam);
  player=new Entity(p1v1x,AH/2+(Math.random()-.5)*200,chosenTeam,playerName,true,chosenSkin,initGun);
  ffaScore[playerName]=0;
  entities.push(player);

  // Bots (3 allies + 4 enemies for team modes, 7 enemies for FFA)
  const numBots=chosenMode.id==='1v1'?1:isFFA?7:7;
  const botSkins=SKINS.map(s=>s.id);

  for(let i=0;i<numBots;i++){
    let team,name;
    if(isFFA){
      team=null;
      const t=i<4?'red':'blue';team=t;
      name=BOT_NAMES.ffa[i%BOT_NAMES.ffa.length];
    } else {
      team=i<3?chosenTeam:eTeam;
      const pool=i<3?BOT_NAMES[chosenTeam]:BOT_NAMES[eTeam];
      name=pool[i%pool.length];
    }
    const sk=botSkins[Math.floor(Math.random()*botSkins.length)];
    const gn=chosenMode.id==='gun'?'pistol':GUNS[Math.floor(Math.random()*GUNS.length)].id;
    const bx1v1=chosenMode.id==='1v1'?AW/2+200:sp(team);
    const e=new Entity(bx1v1,AH/2+(Math.random()-.5)*200,team,name,false,sk,gn);
    ffaScore[name]=0;
    entities.push(e);
  }

  // CTF flags
  if(chosenMode.id==='ctf'){
    flags.red=new Flag('red');
    flags.blue=new Flag('blue');
  }

  // Spawn a few initial powerups
  for(let i=0;i<3;i++)spawnRandomPowerup();
  updStatsHud();updAmmoHud();updHpHud();updScoreHud();
  if(chosenMode.id==='gun')updGunGameHud();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SCREENS / MENU
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showScreen(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById(id).classList.add('active');}

function selTeam(team){
  chosenTeam=team;
  document.querySelectorAll('.bt').forEach(b=>b.classList.remove('sel'));
  document.querySelector('.bt-'+team).classList.add('sel');
  checkReady();
}
function selSkin(id){chosenSkin=id;document.querySelectorAll('.sk').forEach(s=>s.classList.toggle('sel',s.dataset.id===id));checkReady();}
function selGun(id){chosenGun=id;document.querySelectorAll('.gc').forEach(g=>g.classList.toggle('sel',g.dataset.id===id));checkReady();}
function selMode(id){
  chosenMode=MODES.find(m=>m.id===id);
  document.querySelectorAll('.mc').forEach(m=>m.classList.toggle('sel',m.dataset.id===id));
  // FFA & Gun Game: hide team picker, always show gun unless gun game
  const needTeam=chosenMode.teams&&chosenMode.id!=='1v1';
  document.getElementById('team-pick').style.opacity=needTeam?'1':'.35';
  if(!needTeam)chosenTeam='red';
  document.getElementById('gun-row').style.display=chosenMode.id==='gun'?'none':'block';
  if(chosenMode.id==='gun')chosenGun='pistol';
  checkReady();
}
function checkReady(){
  const ok=chosenMode&&chosenSkin&&(chosenGun||chosenMode.id==='gun')&&(chosenTeam||!chosenMode.teams);
  const btn=document.getElementById('bp');
  btn.style.visibility=ok?'visible':'hidden';
}
function startGame(){
  if(!chosenMode)return;
  playerName=(document.getElementById('ni').value.trim().toUpperCase()||'PLAYER').slice(0,12);
  if(!chosenTeam)chosenTeam='red';
  showScreen('s-game');
  initGame();
  running=true;lastTs=performance.now();
  requestAnimationFrame(loop);
}
function playAgain(){
  chosenTeam=null;chosenSkin=null;chosenGun=null;chosenMode=null;
  document.querySelectorAll('.bt,.sk,.gc,.mc').forEach(b=>b.classList.remove('sel'));
  document.getElementById('bp').style.visibility='hidden';
  document.getElementById('ni').value='';
  showScreen('s-menu');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BUILD MENU
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildMenu(){
  const mg=document.getElementById('mg');
  MODES.forEach(m=>{
    const d=document.createElement('div');d.className='mc';d.dataset.id=m.id;d.onclick=()=>selMode(m.id);
    d.innerHTML=`<span class="mc-icon">${m.icon}</span><span class="mc-name">${m.name}</span><span class="mc-desc">${m.desc}</span>`;
    mg.appendChild(d);
  });
  const sg=document.getElementById('sg');
  SKINS.forEach(sk=>{
    const d=document.createElement('div');d.className='sk';d.dataset.id=sk.id;d.onclick=()=>selSkin(sk.id);
    d.innerHTML=`<div class="sp" style="background:${sk.bodyCol};box-shadow:0 0 9px ${sk.glowCol}">${sk.emoji}</div><div class="sn">${sk.name}</div>`;
    sg.appendChild(d);
  });
  const gr=document.getElementById('gr');
  GUNS.forEach(g=>{
    const d=document.createElement('div');d.className='gc';d.dataset.id=g.id;d.onclick=()=>selGun(g.id);
    const pips=(n,max=5,col)=>'<div class="pips">'+[...Array(max)].map((_,i)=>`<div class="pip" style="background:${i<n?col:'var(--bdr)'}"></div>`).join('')+'</div>';
    d.innerHTML=`<span class="gname" style="color:${g.col}">${g.icon} ${g.name}</span><div class="srow"><span class="slb">DMG</span>${pips(g.d,5,g.col)}</div><div class="srow"><span class="slb">SPD</span>${pips(g.f,5,'#FFE600')}</div><div class="srow"><span class="slb">AMO</span>${pips(g.a,5,'#00F5FF')}</div>`;
    gr.appendChild(d);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INPUT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('keydown',e=>{
  keys[e.key.toLowerCase()]=true;
  if(!player||player.dead||!running)return;
  if(e.key===' '){e.preventDefault();player.shoot(player.angle);}
  if(e.key.toLowerCase()==='f')player.startMelee();
  if(e.key.toLowerCase()==='r')player.reload();
  if(e.key.toLowerCase()==='e'&&chosenMode.id==='ctf'){
    // Manual flag interact handled in update loop
  }
});
document.addEventListener('keyup',e=>{keys[e.key.toLowerCase()]=false;});
document.addEventListener('mousemove',e=>{mouse.x=e.clientX;mouse.y=e.clientY;});

window.addEventListener('load',()=>{
  canvas=document.getElementById('gc');ctx=canvas.getContext('2d');
  const resize=()=>{canvas.width=window.innerWidth;canvas.height=window.innerHeight;};
  resize();window.addEventListener('resize',resize);
  canvas.addEventListener('mousedown',e=>{
    mousedown=true;
    if(!player||player.dead||!running)return;
    if(e.button===0)player.shoot(player.angle);
    if(e.button===2)player.startMelee();
  });
  canvas.addEventListener('mouseup',()=>mousedown=false);
  canvas.addEventListener('mouseleave',()=>mousedown=false);
  canvas.addEventListener('contextmenu',e=>e.preventDefault());
  buildMenu();
});
</script>
</body>
</html>
